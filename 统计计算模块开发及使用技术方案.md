下面是经过全部确认后的最终版《统计计算模块开发及使用技术方案》，其中明确了单记录内计算、跨年度比较计算、统计聚合、以及数据更新时通过按钮触发重新计算的要求。请仔细阅读：

------

# 统计计算模块开发及使用技术方案

## 1. 模块概述

**目的：**
 本模块旨在对学生视力数据进行统计计算，并支持两种计算场景：

1. **单记录内计算**
   - 针对每个学生在同一数据年份内的记录，根据干预前后的视力数据（如左眼裸眼视力与左眼干预裸眼视力）计算变化值，并根据预设阈值生成相应标签（“上升”、“维持”、“下降”）。
   - 计算结果在数据录入或修改时计算好后保存到数据库对应字段中。
   - 数据录入或数据修改页面中将单独设置一个按钮，允许用户手工触发重新计算，以便更新个别修改后的数据。
2. **跨年度比较计算**
   - 用户在查询或统计分析界面中明确指定两个数据年份（例如 from_year=2003 和 to_year=2005），后端通过自连接方式分别取出同一学生在两个年份的扩展数据，实时计算指定指标的差值，并生成标签。
   - 此部分计算不写入数据库，而是实时返回结果供查询、统计和报表展示使用。

此外，本模块将支持统计分析功能，包括对各指标（如视力变化标签）的聚合统计、分性别、分年龄段、分学校等分组统计以及趋势图表展示。

------

## 2. 功能需求

### 2.1 计算目标

#### 2.1.1 单记录内计算

- **计算项目示例：**

  - **左眼裸眼视力变化** $\text{left\_naked\_change} = \text{左眼-干预裸眼视力} - \text{左眼-裸眼视力}$

  - 阈值与标签

    （针对裸眼视力）：

    - 如果变化值 > 0.1，则标签为“上升”
    - 如果变化值 < -0.1，则标签为“下降”
    - 否则为“维持”

- **其他指标：**

  - 对于球镜、柱镜：阈值为 0.01
  - 对于轴位数据：阈值为 1
  - 视力等级按照球镜数据进行判定分类（轻度、中度、临床前期、假性近视），其中SE为球镜数据
    - 轻度近视要求左右眼同时满足： $-0.50 < SE \leq -0.30$
    - 中度近视以右眼数据为准： $-6.00 \leq SE_R < -3.00$
    - 临床前期近视以右眼数据为准，当不满足轻度和中度标准时，且：
      - 6-9岁儿童：$SE_R \leq 1.25$
      - 10-12岁儿童：$SE_R \leq 0.75$
    - 假性近视：散瞳验光后右眼球镜数据为 0

- **数据存储：**
   单记录内计算结果（例如 left_naked_change、left_interv_effect 等）在数据导入或修改时计算好后保存到数据库。

#### 2.1.2 跨年度比较计算

- **功能描述：**
   用户在查询或统计界面指定两个数据年份（例如 from_year 与 to_year），后端通过自连接（利用 SQLAlchemy 的 aliased() 方法）分别获取同一学生在这两个年份的记录。
- **计算示例：**
   例如，跨年度左眼裸眼视力变化计算： $\text{cross\_left\_naked\_change} = \text{ext\_to.left\_eye\_naked\_interv} - \text{ext\_from.left\_eye\_naked}$
- **标签生成规则：**
   同裸眼视力计算，阈值为 0.1；生成标签“上升”、“维持”、“下降”。
- **数据返回：**
   跨年度计算结果实时返回，不保存数据库。

### 2.2 统计与聚合需求

- 统计分析模块需要聚合各指标数据：
  - 各变化类别（上升、维持、下降）的数量和占比
  - 平均变化值
  - 可按性别、年龄、学校等分组统计
  - 趋势图表展示
- 查询接口返回数据时，若用户指定跨年度比较条件，则返回计算结果作为附加字段供统计分析使用。

------

## 3. 模块设计

### 3.1 模块结构

将所有视力数据计算逻辑封装到独立模块文件 `vision_calculation.py`，模块包括以下主要函数：

- **determine_effect(change, type)**

  - 输入：
    - `change`: 计算得到的差值
    - `type`: 指标类型（"naked"、"spherical"/"cylindrical"、"axis"）
  - 逻辑：
    - 若 type="naked"，使用阈值 0.1；
    - 若 type 为 "spherical" 或 "cylindrical"，使用阈值 0.01；
    - 若 type="axis"，使用阈值 1。
  - **输出：** 返回 "上升"、"维持" 或 "下降"。

- **calculate_within_year_change(record)**

  - **输入：** 单条 StudentExtension 记录

  - **逻辑：** 根据记录中的数据（例如左眼裸眼视力与左眼干预裸眼视力）计算变化值，并调用 determine_effect() 得到标签。

  - 输出：

     返回一个字典，包含计算结果和生成的标签，例如：

    ```python
    {
      "left_naked_change": -0.2,
      "left_interv_effect": "下降",
      // 其他指标...
    }
    ```

  - **用途：** 数据导入或数据修改时调用，计算结果更新到数据库中。

- **calculate_cross_year_change(student_id, from_year, to_year)**

  - 输入：

    - `student_id`
    - `from_year` 与 `to_year`（用户在查询时指定的年份）

  - 逻辑：

    - 利用 SQLAlchemy 的 aliased() 对 StudentExtension 进行自连接，分别过滤出 from_year 和 to_year 的记录（例如 ext_from 和 ext_to）。
    - 计算各指定指标的差值，例如： $\text{cross\_left\_naked\_change} = \text{ext\_to.left\_eye\_naked\_interv} - \text{ext\_from.left\_eye\_naked}$
    - 调用 determine_effect() 得到对应标签。

  - 输出：

     返回包含跨年度计算结果的字典，例如：

    ```python
    {
      "cross_left_naked_change": -0.25,
      "cross_left_naked_effect": "下降"
    }
    ```

  - **用途：** 查询和统计分析时实时计算，不存储数据库。

### 3.2 模块集成

- **数据导入/修改模块**
   在数据录入或数据修改页面中，设置一个按钮（例如“重新计算”），调用 calculate_within_year_change() 对当前记录进行计算，并更新数据库中的计算字段。
- **查询与统计分析模块**
   当用户在查询界面指定跨年度比较条件时，后端调用 calculate_cross_year_change() 进行实时计算，并将计算结果附加到返回数据中；统计分析模块基于这些返回结果进行聚合统计。

------

## 4. 使用说明

### 4.1 接口调用

- **单记录内计算**
   在数据导入或修改时，每条 StudentExtension 记录处理完毕后，调用：

  ```python
  result = calculate_within_year_change(record)
  ```

  然后将 result 中的各字段更新到数据库中相应的字段（如 left_naked_change、left_interv_effect 等）。

- **跨年度比较计算**
   当用户在组合查询或统计界面输入 from_year 与 to_year 后，后端在查询接口中对每个学生调用：

  ```python
  cross_result = calculate_cross_year_change(student_id, from_year, to_year)
  ```

  并将 cross_result 合并到返回的 JSON 数据中，前端据此展示跨年度比较的结果和标签。

### 4.2 前端展示与交互

- **查询页面**
   查询结果中，若返回了跨年度计算结果，则显示在单独的列中，每个学生的记录按数据年份分行展示。
   同时在学生详情页中，设计完整的表单展示所有数据记录，包括导入数据与计算结果。
- **统计分析页面**
   统计分析页面调用本模块的计算函数，聚合各类计算指标（例如各类别的占比、平均变化值等），并支持用户在交互界面组合查询条件。
- **数据修改页面**
   在数据导入/修改页面中设置“重新计算”按钮，触发单记录内计算函数，确保在手工修改数据后可以更新计算结果。

------

## 5. 统计聚合功能

统计分析模块将基于本模块提供的计算结果实现以下聚合：

- 各类别（上升、维持、下降）的数量和占比统计
- 分性别、分年龄段、分学校的聚合统计
- 趋势图表展示跨年度变化情况

前端将提供组合查询条件，允许用户选择统计维度和过滤条件，并将查询参数传给后端，后端使用本模块计算并聚合后返回结果。

------

## 6. 备选方案与扩展

- **实时计算 vs. 预计算**
   由于数据量较小，跨年度比较采用实时计算；单记录内计算在导入时直接存储。
- **模块扩展**
   若后续需要新增其他视力指标的计算，只需在 `vision_calculation.py` 中添加相应的函数，不影响现有代码。

------

## 7. 已经确认信息

1. **阈值与计算规则**
   - 裸眼视力阈值：0.1
   - 球镜/柱镜阈值：0.01
   - 轴位阈值：1
   - 视力等级分类标准按前述公式执行。
2. **计算指标范围**
   - 当前仅计算上述指标，后续如有变化可扩展。
3. **用户输入形式**
   - 跨年度比较时，前端允许用户输入或选择 from_year 与 to_year，形式可采用文本输入或多选下拉框。
4. **展示需求**
   - 查询结果中，同一学生若有多年份记录，每个记录单独一行展示；点击单条记录可跳转到学生详情页，显示所有数据记录。
5. **统计分析要求**
   - 统计模块需要支持多维度聚合和趋势分析。
6. **数据修改**
   - 数据导入或修改页面中，设置独立按钮触发单记录内计算，保证手工修改后计算结果及时更新。

------



下面给出最终版的统计计算模块的开发及使用技术方案，详细说明了各项视力相关指标的计算规则、数据来源及保存字段，确保所有需求点和细节均得到了充分说明。请仔细阅读，如有疑问再讨论。

------

满足要求：

------

## 统计计算模块详细技术方案

### 一、总体说明

本模块用于对学生视力数据进行自动计算，主要包括两部分内容：

1. **单记录内计算（同一年内的计算）**
    在数据导入或手动修改时，针对同一数据年份的 StudentExtension 记录，自动计算干预前与干预后的各项视力指标的差值，并根据预设阈值生成相应的效果标签，同时对视力等级进行判断。计算结果会直接更新到数据库对应的字段中。
2. **跨年度比较计算（实时计算，不保存数据库）**
    当用户在查询或统计分析界面指定两个不同的数据年份时（例如 from_year 与 to_year），通过 SQLAlchemy 自连接获取同一学生在不同年份的记录，实时计算各项指标的跨年度差值及效果标签，计算结果直接返回供展示使用，不更新数据库。

### 二、单记录内计算（同一年内计算）

#### 1. 视力变化（裸眼视力）

- **左眼裸眼视力变化**

  - **公式**：
     `left_naked_change = left_eye_naked_interv - left_eye_naked`

  - 数据来源

    ：

    - 干预前裸眼数据字段：`left_eye_naked`
    - 干预后裸眼数据字段：`left_eye_naked_interv`

  - **保存字段**：`left_naked_change`

  - **效果标签判断**（阈值：0.1）：
     使用 `determine_effect(change, "naked")` 得到标签，保存字段：`left_interv_effect`

- **右眼裸眼视力变化**

  - **公式**：
     `right_naked_change = right_eye_naked_interv - right_eye_naked`

  - 数据来源

    ：

    - 干预前裸眼数据字段：`right_eye_naked`
    - 干预后裸眼数据字段：`right_eye_naked_interv`

  - **保存字段**：`right_naked_change`

  - **效果标签判断**（阈值：0.1）：
     保存标签字段：`right_interv_effect`

#### 2. 屈光数据变化（取“球镜”、“柱镜”、“轴位”数据）

- **球镜变化**

  - **左眼球镜变化**

    - **公式**：
       `left_sphere_change = left_sphere_interv - left_sphere`

    - 数据来源

      ：

      - 干预前球镜数据字段：`left_sphere`
      - 干预后球镜数据字段：`left_sphere_interv`

    - **保存字段**：`left_sphere_change`

    - **效果标签**：判断时使用阈值 0.01，标签保存字段：`left_sphere_effect`

  - **右眼球镜变化**

    - **公式**：
       `right_sphere_change = right_sphere_interv - right_sphere`

    - 数据来源

      ：

      - 干预前球镜数据字段：`right_sphere`
      - 干预后球镜数据字段：`right_sphere_interv`

    - **保存字段**：`right_sphere_change`

    - **效果标签**：阈值 0.01，标签保存字段：`right_sphere_effect`

- **柱镜变化**

  - **左眼柱镜变化**

    - **公式**：
       `left_cylinder_change = left_cylinder_interv - left_cylinder`

    - 数据来源

      ：

      - 干预前柱镜数据字段：`left_cylinder`
      - 干预后柱镜数据字段：`left_cylinder_interv`

    - **保存字段**：`left_cylinder_change`

    - **效果标签**：阈值 0.01，标签保存字段：`left_cylinder_effect`

  - **右眼柱镜变化**

    - **公式**：
       `right_cylinder_change = right_cylinder_interv - right_cylinder`

    - 数据来源

      ：

      - 干预前柱镜数据字段：`right_cylinder`
      - 干预后柱镜数据字段：`right_cylinder_interv`

    - **保存字段**：`right_cylinder_change`

    - **效果标签**：阈值 0.01，标签保存字段：`right_cylinder_effect`

- **轴位变化**

  - **左眼轴位变化**

    - **公式**：
       `left_axis_change = left_axis_interv - left_axis`

    - 数据来源

      ：

      - 干预前轴位数据字段：`left_axis`
      - 干预后轴位数据字段：`left_axis_interv`

    - **保存字段**：`left_axis_change`

    - **效果标签**：阈值 1，标签保存字段：`left_axis_effect`

  - **右眼轴位变化**

    - **公式**：
       `right_axis_change = right_axis_interv - right_axis`

    - 数据来源

      ：

      - 干预前轴位数据字段：`right_axis`
      - 干预后轴位数据字段：`right_axis_interv`

    - **保存字段**：`right_axis_change`

    - **效果标签**：阈值 1，标签保存字段：`right_axis_effect`

#### 3. 视力等级判断

分为干预前与干预后两部分，判断均基于【屈光-球镜】数据，同时结合年龄判断，具体规则如下：

##### 3.1 干预前视力等级（保存至字段 `vision_level`）

- 数据来源

  ：

  - 右眼干预前球镜数据：`right_sphere`
  - 左眼干预前球镜数据：`left_sphere`（仅用于轻度近视判断）
  - 年龄：`age`

- 判断规则

  ：

  1. **假性近视**：若右眼散瞳球镜（right_dilated_sphere）数据等于 0，则视为“假性近视”。

  2. 轻度近视

     ：要求左右眼球镜数据同时满足：

     - 数值满足： ≥ -3.00 且 ＜ -0.50
        即 `left_sphere` 与 `right_sphere` 均大于等于 -3.00 且小于 -0.50
        （注意：此处判断轻度近视时，必须左右眼同时满足条件）

  3. 中度近视

     ：仅使用右眼数据判断，条件为：

     - `right_sphere` 的数值满足： ≥ -6.00 且 ＜ -3.00

  4. 临床前期近视

     ：仅使用右眼数据结合年龄判断（前提是不满足轻度或中度近视条件）：

     - 如果年龄在 6 至 9 岁（含6与9），且 `right_sphere` ≤ 1.25；
     - 如果年龄在 10 至 12 岁（含10与12），且 `right_sphere` ≤ 0.75；

  5. **其他情况**：若不满足上述任何条件，则判定为“正常”或“未分级”（可自定义）。

##### 3.2 干预后视力等级（保存至字段 `interv_vision_level`）

- 数据来源

  ：

  - 右眼干预后球镜数据：`right_sphere_interv`
  - 左眼干预后球镜数据：`left_sphere_interv`（仅用于轻度近视判断）
  - 年龄：`age`

- 判断规则

  ：与干预前类似，但全部使用干预后数据判断：

  1. **假性近视**：若 `right_dilated_sphere_interv` 等于 0，则判定为“假性近视”。

  2. 轻度近视

     ：要求左右眼干预后球镜数据同时满足：

     - `left_sphere_interv` 与 `right_sphere_interv` 均 ≥ -3.00 且 ＜ -0.50

  3. 中度近视

     ：仅依据右眼干预后数据判断，条件为：

     - `right_sphere_interv` 数值满足： ≥ -6.00 且 ＜ -3.00

  4. 临床前期近视

     ：仅依据右眼干预后数据结合年龄判断（前提是不满足轻度或中度条件）：

     - 如果年龄在 6 至 9 岁（含6与9），且 `right_sphere_interv` ≤ 1.25；
     - 如果年龄在 10 至 12 岁（含10与12），且 `right_sphere_interv` ≤ 0.75；

  5. **其他情况**：否则判定为“正常”或“未分级”。

#### 4. 跨年度比较计算（实时计算，不更新数据库）

- 跨年度比较的计算方法与单记录内计算类似，但以两个不同数据年份的记录进行比较。

- 示例：

  跨年度左眼裸眼视力变化

  - **公式**：
     `cross_left_naked_change = to_year_record.left_eye_naked_interv - from_year_record.left_eye_naked`

  - 效果标签

    ：使用阈值 0.1，生成标签，返回字段例如：

    - `cross_left_naked_change`
    - `cross_left_naked_effect`

- 同理，其它指标（例如右眼裸眼、右眼球镜、柱镜、轴位等）也按此方法计算。

- 展示时，列名称可采用前缀方式（如由用户指定“2003-2005”前缀）以区分跨年度数据。

### 三、手动重新计算功能

- 在数据录入或学生详情页中增加“重新计算”按钮。
- 按钮功能：调用本模块单记录计算函数（例如 `calculate_within_year_change(record)` 以及视力等级判断函数），对当前记录重新进行计算，并更新数据库中相应字段（包括各变化值和效果标签、干预前视力等级 `vision_level` 和干预后视力等级 `interv_vision_level`）。

### 四、异常与空值处理

- 如果某一计算所需的原始数据为空（例如裸眼视力、球镜数据、年龄等），则对应计算结果设为 `None`，标签也设为 `None`。
- 如数据无法转换为数字，则捕获异常，记录错误日志，并将对应计算结果置为 `None`。

------

## 所有计算项目清单

| 计算项                     | 公式                                     | 干预前数据字段 / 干预后数据字段                              | 保存字段              | 效果标签字段          | 判断阈值 | 特别说明         |
| -------------------------- | ---------------------------------------- | ------------------------------------------------------------ | --------------------- | --------------------- | -------- | ---------------- |
| 左眼裸眼视力变化           | left_eye_naked_interv - left_eye_naked   | 干预前：left_eye_naked干预后：left_eye_naked_interv          | left_naked_change     | left_interv_effect    | 0.1      |                  |
| 右眼裸眼视力变化           | right_eye_naked_interv - right_eye_naked | 干预前：right_eye_naked干预后：right_eye_naked_interv        | right_naked_change    | right_interv_effect   | 0.1      |                  |
| 左眼球镜变化               | left_sphere_interv - left_sphere         | 干预前：left_sphere干预后：left_sphere_interv                | left_sphere_change    | left_sphere_effect    | 0.01     |                  |
| 右眼球镜变化               | right_sphere_interv - right_sphere       | 干预前：right_sphere干预后：right_sphere_interv              | right_sphere_change   | right_sphere_effect   | 0.01     |                  |
| 左眼柱镜变化               | left_cylinder_interv - left_cylinder     |                                                              | left_cylinder_change  | left_cylinder_effect  | 0.01     |                  |
| 右眼柱镜变化               | right_cylinder_interv - right_cylinder   |                                                              | right_cylinder_change | right_cylinder_effect | 0.01     |                  |
| 左眼轴位变化               | left_axis_interv - left_axis             |                                                              | left_axis_change      | left_axis_effect      | 1        |                  |
| 右眼轴位变化               | right_axis_interv - right_axis           |                                                              | right_axis_change     | right_axis_effect     | 1        |                  |
| 干预前视力等级（视力等级） | 视力等级判断公式（见下述规则）           | 右眼球镜：right_sphere左眼球镜：left_sphere年龄：age         | vision_level          | ——                    | ——       | 判断规则详见下文 |
| 干预后视力等级             | 同上，但数据取自干预后字段               | 右眼球镜：right_sphere_interv左眼球镜：left_sphere_interv年龄：age | interv_vision_level   | ——                    | ——       | 判断规则详见下文 |

#### 干预前视力等级判断规则：

- **假性近视**：若right_dilated_sphere == 0，则“假性近视”；

- **轻度近视**：要求左右眼同时满足：
   `left_sphere` 与 `right_sphere` 均 ≥ -3.00 且 ＜ -0.50

- **中度近视**：仅依据 right_sphere 判断，条件：
   right_sphere ≥ -6.00 且 ＜ -3.00

- 临床前期近视

  ：仅依据 right_sphere 结合 age 判断（前提是不满足轻度或中度）：

  - 若 age 在 6 至 9 岁（含6与9）：right_sphere ≤ 1.25
  - 若 age 在 10 至 12 岁（含10与12）：right_sphere ≤ 0.75

- 其他情况：判定为“正常”或“未分级”。

#### 干预后视力等级判断规则：

- 同上，但使用 right_sphere_interv 和 left_sphere_interv  以及right_dilated_sphere_interv替换。

------

### 五、跨年度比较（实时计算）

对于跨年度比较，各项指标的计算方法与上述单记录内计算类似，但查询的是同一学生在不同年份的记录，示例：

- **跨年度左眼裸眼视力变化**：
   `cross_left_naked_change = to_year_record.left_eye_naked_interv - from_year_record.left_eye_naked`
   并生成效果标签（阈值 0.1），返回字段如 `cross_left_naked_change` 和 `cross_left_naked_effect`。
- 其它指标按类似方法计算，且展示列名称前可加用户设定前缀。

------

### 六、手动重新计算

- 当数据被修改或单条录入时，通过点击“重新计算”按钮触发本模块计算函数，对该记录重新计算所有上述指标，并更新到对应字段。

------

### 七、异常处理

- 如原始数据为空或格式转换错误，对应计算结果及效果标签均置为 None，并在日志中记录错误信息。
- 年龄数据为空时，无法判断视力等级，视为“未分级”。

------

## 后续步骤

1. **代码实现**：在 vision_calculation.py 模块中实现上述各函数，并在数据导入模块中调用单记录计算函数进行更新。
2. **测试验证**：通过导入数据后检查数据库中的计算字段是否按预期更新，同时在查询/统计界面测试跨年度计算功能。
3. **手动重新计算**：在学生详情页或数据修改页面添加“重新计算”按钮，测试点击后记录数据更新情况。

------

请确认以上方案是否满足您的需求，如无问题，我将据此开始完善并输出代码。

