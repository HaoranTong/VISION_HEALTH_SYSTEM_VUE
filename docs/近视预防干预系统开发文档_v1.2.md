------

------

# 近视预防干预系统开发文档_v1.2

------

## 一、文档管理信息

| 项目     | 内容                                                         |
| -------- | ------------------------------------------------------------ |
| 文档类型 | 开发文档（DEV）                                              |
| 系统名称 | 近视预防干预系统                                             |
| 文档编号 | DEV-20250206-003 【修改：由原 DEV-20250206-002 更新为 DEV-20250206-003】 |
| 当前版本 | v1.2 【修改：版本更新至 v1.2】                               |
| 生成日期 | 2025年2月XX日 【修改：更新生成日期】                         |
| 生效日期 | 2025年2月XX日 【修改：更新生效日期】                         |

------

## 二、系统概述

本系统旨在开发一套覆盖学生视力筛查、干预跟踪、统计分析全流程的管理系统，实现多层级数据聚合、动态组合分析（50+维度）及智能预警与干预效果评估。

【新增】同时，系统集成自动备份与目录结构恢复工具，确保在代码或文档丢失时，可通过一键恢复功能重建预设的目录结构及初始化文件。

【保留】原 v1.1 关于系统目标、用户角色和主要业务流程的描述基本保持不变。

------

## 三、系统架构设计

### 3.1 前端设计

- 技术选型

  ：

  - 前端使用 HTML、CSS、JavaScript 与 **Bootstrap** 构建响应式界面；图表展示采用 **Chart.js**；后续可引入 Vue/React 实现组件化开发。

- 界面设计

  ：

  - 使用 Figma 或 Axure 绘制原型，设计数据录入、查询、统计分析、大屏展示等页面。
  - 【新增】增加“目录结构恢复”页面，提供“一键恢复”按钮，前端通过 AJAX 调用后端目录恢复 API，实现自动重建项目目录及初始化文件。

### 3.2 后端设计

- 技术选型

  ：

  - 基于 **Flask** 框架开发 API 接口，使用 **SQLAlchemy** 作为 ORM。初期使用 SQLite，后续迁移至 MySQL 云平台。

- API 接口设计

  ：

  - 实现数据录入 API（单条和 Excel 批量导入）、数据查询 API、统计分析 API、数据导出 API。
  - 【新增】实现目录结构恢复 API，调用自动生成目录结构的脚本（如 create_structure.py），以实现一键恢复。

- 权限控制

  ：

  - 使用 JWT 实现用户认证，并通过 Flask 装饰器实现基于角色的权限验证；【修改】增加未授权访问日志记录功能。

### 3.3 数据库设计

- 数据库选型

  ：

  - 初期采用 SQLite，正式部署时迁移至 MySQL 云平台。

- 主要数据表

  ：

  - 包括学生基本信息、健康信息、视力数据、干预记录等。
  - 【新增】数据库及关键配置文件应支持定期自动备份，并与代码备份方案统一管理。

------

## 四、详细设计

### 4.1 功能模块划分

#### 4.1.1 数据管理模块

- 数据采集

  ：

  - 实现 Excel 批量导入（利用 Pandas 校验格式、必填字段、视力值范围，生成“导入失败记录表”与“数据不完整记录表”）及单条数据录入（基于 Bootstrap 表单与 AJAX 实现实时校验）。

- 数据存储

  ：

  - 定义学生、健康信息、视力数据、干预记录等数据模型，支持系统管理员动态添加字段及设置计算规则。

- 后台管理与日志记录

  ：

  - 限制数据修改权限为系统管理员，并记录所有修改日志。

- 【新增】

  目录结构恢复工具

  ：

  - 集成自动生成项目目录结构的脚本（create_structure.py），并通过目录恢复 API 暴露给前端，实现“一键恢复”功能。

#### 4.1.2 统计分析模块

- 实现多条件、分页和任意字段组合查询；
- 实现近视程度分类（基于【3.2.2 分析模型】规则）：
  - 【修改】取消“高度近视”和“假性近视”分类；
  - “轻度近视”判断要求：同时采集左右眼数据，只有当左右眼均满足轻度标准，才标记为“轻度近视”；其他分类仅依据右眼数据。
- 整理统计数据生成适合 Chart.js 渲染的 JSON 数据，并支持导出 Excel 和 PDF 文件。

#### 4.1.3 前端展示模块

- **数据录入、查询、统计分析、大屏展示**页面保持原有设计；
- 【新增】**目录结构恢复页面**：提供“一键恢复目录结构”按钮，前端通过 AJAX 调用后端目录恢复 API，并显示恢复结果。

#### 4.1.4 用户管理与权限

- 家长通过微信小程序登录，其他角色通过账号密码登录；
- 系统管理员在后台配置权限。
- 【修改】权限验证中增加未授权访问日志记录功能。

### 4.2 数据流设计

- 数据录入流程

  ：

  1. 前端通过表单提交数据；
  2. 后端校验数据并存入数据库；
  3. 前端反馈录入结果。

- 数据查询与统计流程

  ：

  1. 前端提交查询条件；
  2. 后端返回统计数据及图表数据；
  3. 前端调用 Chart.js 渲染图表；
  4. 支持数据导出。

- 【新增】

  目录结构恢复流程

  ：

  1. 用户点击前端“目录结构恢复”页面中的“一键恢复”按钮；
  2. 前端通过 AJAX 调用后端恢复 API；
  3. 后端执行恢复脚本，重建目录结构及初始化文件；
  4. 将恢复结果反馈给前端显示。

### 4.3 界面设计

- 整体风格：蓝白扁平化，简洁清晰，符合响应式设计要求。
- 包含数据录入、查询、统计分析、大屏展示页面。
- 【新增】目录结构恢复页面：提供“一键恢复”按钮及恢复结果提示。

------

## 五、开发计划

### 5.1 任务分解

1. **环境搭建与配置**
   - 安装 Python、Flask、VSCode、Git；配置虚拟环境及所需依赖（Flask、SQLAlchemy、Pandas、Chart.js、Bootstrap 等）。
2. **数据库设计与建模**
   - 定义学生、健康信息、视力数据、干预记录等数据模型；编写数据库初始化及迁移脚本。
3. **后端 API 开发**
   - 实现数据录入（单条和 Excel 批量导入）、查询、统计分析、数据导出 API。
   - 【新增】实现目录结构恢复 API（调用 create_structure.py 脚本）。
   - 完成权限控制与日志记录功能。
4. **前端页面开发**
   - 开发数据录入、查询、统计分析、大屏展示页面。
   - 【新增】开发目录结构恢复页面，包含“一键恢复”按钮及交互逻辑。
5. **测试与调试**
   - 编写单元测试、API 测试及前后端集成测试；调试各模块确保系统稳定运行。
6. **部署与上线准备**
   - 完成本地开发后，配置云平台部署（如 Docker 部署）；
   - 编写部署脚本，完成性能、安全及备份恢复测试。

### 5.2 时间安排

| 阶段         | 任务描述                                                     | 预估时间 |
| ------------ | ------------------------------------------------------------ | -------- |
| 环境搭建     | 完成开发环境配置、依赖安装、Git设置                          | 1 周     |
| 数据库建模   | 设计并实现数据库表结构及初始化数据                           | 1 周     |
| 后端开发     | 实现数据录入、Excel导入、查询、统计分析、目录恢复及权限控制 API | 2 周     |
| 前端开发     | 构建各页面（数据录入、查询、统计分析、大屏展示、目录恢复）   | 2 周     |
| 测试与调试   | 编写测试用例，进行单元、集成及系统测试                       | 1 周     |
| 部署上线准备 | 配置云平台部署、编写部署脚本、上线前调试，并配置备份与恢复服务 | 1 周     |

*注：总周期约8周，实际进度可根据项目需求及开发过程中遇到的问题进行调整。*

------

## 六、环境配置与部署规划

### 6.1 开发环境

- **操作系统**：Windows
- **开发工具**：VSCode（集成 PowerShell 终端）、Git、GitHub
- **依赖库**：Python 3.x、Flask、SQLAlchemy、Pandas、Flask-Migrate（可选）、Chart.js、Bootstrap 等
- **数据库**：初期使用 SQLite（文件存放于 instance/app.db 中），后续迁移至 MySQL
- 【新增】定期自动备份机制：配置定时任务自动备份数据库文件及项目关键文件（包括目录结构备份）。

### 6.2 部署环境

- **初期部署**：本地开发，使用 SQLite
- **正式部署**：迁移至云平台（如 Docker 容器化部署），使用 MySQL 数据库
- 【新增】部署时配置备份与恢复服务，确保代码、配置文件及数据库的安全性。

------

## 七、附录

### 7.1 开发资源

- [Flask 官方文档](https://flask.palletsprojects.com/)
- [SQLAlchemy 官方文档](https://docs.sqlalchemy.org/)
- [Bootstrap 官方文档](https://getbootstrap.com/)
- [Chart.js 官方文档](https://www.chartjs.org/)
- [VSCode 官方文档](https://code.visualstudio.com/)

### 7.2 设计原型工具

- 推荐使用 Figma 或 Axure 绘制前端原型，便于后续交互与 UI 设计讨论。

### 7.3 目录结构恢复脚本

【新增】在项目根目录下提供了名为 `create_structure.py` 的脚本，用于自动创建项目文档及代码目录结构，并生成各个包目录下的 `__init__.py` 等初始化文件。使用方法：

```bash
python create_structure.py
```

该脚本可在意外丢失目录结构时“一键”恢复至设计好的标准结构。

------

## 八、文档变更历史

| 版本 | 修订日期   | 修订内容                                                     | 审核人   |
| ---- | ---------- | ------------------------------------------------------------ | -------- |
| v1.0 | 2025-02-03 | 初始版本：详细开发方案，涵盖系统架构、详细设计、开发计划及部署规划 | [待签核] |
| v1.1 | 2025-02-06 | 增加和细化需求调整：1. 增加“学校ID”字段；2. “教育ID号”导入后自动生成“索引ID”；3. 系统管理员可在后台添加字段；4. 系统管理员可指定字段间计算规则（如“右眼-干预-裸眼视力”减“右眼-裸眼视力”，结果保存至“干预效果”字段）；5. 数据导入时分别生成“导入失败记录表”与“数据不完整记录表”；6. 自动计算近视分类保存至“近视等级”字段。 | [待签核] |
| v1.2 | 2025-XX-XX | 【新增】1. 在【3.2.1 分析维度】中增加“班级”、“年龄区间”、“屈光-球镜”、“屈光-柱镜”、“干预效果”、“视力等级”维度；【修改】2. 在【3.2.2 分析模型】中取消“高度近视”和“假性近视”分类，并规定：轻度近视须左右眼均满足轻度标准，其余分类仅依据右眼数据；【修改】3. 在【3.31 Web端功能】中扩展系统数据维护功能（包括角色管理、权限管理、账户管理、消息推送、参数设定、菜单维护、页面调整、规则设定、字典管理、日志管理）；【新增】4. 在完整数据字段中增加“干预前视力等级”、“干预后视力等级”、“左眼裸眼视力变化”、“右眼裸眼视力变化”、“左眼屈光-球镜变化”、“右眼屈光-球镜变化”、“左眼屈光-柱镜变化”、“右眼屈光-柱镜变化”、“左眼视力干预效果”、“右眼视力干预效果”、“左眼球镜干预效果”、“右眼球镜干预效果”、“左眼柱镜干预效果”、“右眼柱镜干预效果”；【新增】5. 补充自动备份与目录结构恢复机制。 | [待签核] |

------

