下面是统计报表页面功能需求及技术开发方案的完整结构化说明，供后续开发参考：

------

# 统计报表页面功能需求及技术开发方案

## 1. 概述

**目标**
 构建一个统计报表页面，用于对系统中存储的各项统计数据进行多维度聚合计算，并以报表形式展示。报表页面同时支持预设查询模版、组合查询以及分页、导出等操作，并能与图表展示页面联动（通过按钮跳转或共享查询结果）。

**主要用户**

- 系统管理员
- 数据分析人员

------

## 2. 功能需求

### 2.1 报表数据展示

- **数据统计范围**
  - 对统计指标进行聚合计算，主要统计字段包括但不限于：
    - 视力等级（干预前、干预后）
    - 裸眼视力数据（左右眼）
    - 屈光数据（左右眼球镜、柱镜、轴位）
    - 干预效果（上升、维持、下降）
    - 其他业务相关数据（如年龄、学校、班级等）
- **显示内容**
  - 表格形式展示统计结果，表头显示各统计维度名称；
  - 表格行显示每个分组（如“上升”、“维持”、“下降”）的统计数据，数据内容包括：
    - 记录数
    - 所占比例（百分比）
  - 分页功能：若统计数据条目较多，可按每页固定条数（例如10条）分页显示。

### 2.2 查询功能

- **查询方式**
  - 仅采用组合查询方式作为唯一查询入口
  - 支持预设模版：
    - 系统预先定义若干查询模版（例如“裸眼视力变化统计”、“干预效果统计”等），用户可以直接选择
    - 用户也可以在预设模版基础上进行修改（增减、调整统计维度），形成临时查询模版；同时支持保存新模版
- **查询条件类型**
  - 对于固定的字段（例如学校、年级、性别、数据年份等）采用下拉选择
  - 对于数值型字段（如裸眼视力、球镜数据等）支持区间查询（提供最小值、最大值输入框）
  - 对于多选字段（如干预效果）采用复选框形式
  - 对于文本型字段（如姓名）支持模糊查询（如输入部分文本即可匹配）
- **查询结果**
  - 查询结果返回后以报表表格方式展示；
  - 同时支持导出报表（例如导出为 Excel 文件）。

### 2.3 页面布局与交互

- **整体布局**
  - 页面继承自统一的基础模板，保证全局导航、侧边栏、顶部导航保持一致；
  - 页面上部分为查询区域，下部分为统计报表显示区域；
  - 查询区域包含组合查询模块，内部显示预设模版下拉选择、添加条件、清除条件、查询按钮。
- **报表区域**
  - 采用卡片式设计，表格显示统计数据；
  - 表格上方显示动态生成的表头，表头列名固定，与后端统计数据字段对应；
  - 页面底部提供分页控件，方便用户浏览所有统计记录。
- **操作按钮**
  - “查询”按钮：点击后收集查询条件，调用后端统计接口并刷新报表数据
  - “导出报表”按钮：将当前报表数据导出为 Excel 文件
  - “查看图表”按钮：跳转至图表展示页面，使用当前报表查询条件生成图表
- **查询模版管理**
  - 预设模版下拉框允许用户选择已有模版；
  - “保存模版”按钮允许用户将当前组合查询条件保存为新模版，后续查询时可直接调用

------

## 3. 技术方案

### 3.1 前端技术选型

- **模板与页面结构**
  - 使用 Jinja2 模板引擎构建 HTML 页面，采用基础模板（base.html）统一布局
  - 报表页面（report.html）采用卡片式设计，并通过包含组合查询模块的 HTML 文件（comboQuery.html）实现查询区域
- **样式**
  - 全局样式由 core.css 定义
  - 报表页面局部样式单独由 report.css 管理
  - 组合查询模块样式由 comboQuery.css 管理，需避免与报表页面其他局部样式冲突（如更改卡片名称，确保唯一性）
- **前端交互**
  - 使用原生 JavaScript 实现页面交互逻辑
  - 分别编写 report.js 管理报表数据获取、表格渲染和分页逻辑
  - 组合查询模块的交互由 comboQuery.js 实现，提供添加、删除、获取查询条件接口
  - 图表展示页面采用 Chart.js 进行图表绘制

### 3.2 后端技术选型

- 框架
  - 使用 Flask 框架构建 RESTful API
- 数据库与ORM
  - 使用 SQLAlchemy 作为 ORM，支持 SQLite 数据库（数据量约 10 万条以内）
- 统计计算
  - 统计接口在 analysis_api 蓝图中实现，接口包括：
    - /api/analysis/report 用于返回统计报表数据（聚合统计结果，分组统计数据）
    - /api/analysis/chart 用于返回图表数据（如分组数据、趋势数据等）
  - 统计计算逻辑基于 SQLAlchemy 聚合函数（如 func.count, func.sum, group_by 等）
  - 数据返回格式为 JSON，由前端动态解析后展示

### 3.3 实现逻辑

- **查询条件处理**

  - 前端通过组合查询模块收集所有查询条件，将条件 JSON 存入隐藏输入框，并通过 URL 参数传递到后端统计接口
  - 后端在 analysis_api 中解析查询条件，对 Student 与 StudentExtension 进行多维度过滤和聚合统计

- **报表数据生成**

  - 根据查询条件生成聚合统计数据，返回格式示例：

    ```json
    {
      "total_students": 1000,
      "group_stats": [
         {"group": "上升", "count": 300, "percentage": 30.0},
         {"group": "维持", "count": 500, "percentage": 50.0},
         {"group": "下降", "count": 200, "percentage": 20.0}
      ]
    }
    ```

  - 前端 report.js 接收数据后，动态生成表头和数据行，并调用分页函数生成分页控件

- **图表数据生成**

  - 图表页面通过调用 /api/analysis/chart 接口获取数据，返回数据格式适用于 Chart.js，如：

    ```json
    {
      "labels": ["上升", "维持", "下降"],
      "datasets": [{
          "label": "效果统计",
          "data": [300, 500, 200],
          "backgroundColor": [
              "rgba(75, 192, 192, 0.5)",
              "rgba(153, 102, 255, 0.5)",
              "rgba(255, 159, 64, 0.5)"
          ]
      }]
    }
    ```

  - 前端图表页面调用 Chart.js 绘制柱状图或其他类型图表，并支持鼠标悬停显示详细信息

- **页面跳转与联动**

  - 报表页面和图表页面均提供切换按钮，用户可在两个页面间跳转，且两个页面均使用相同的查询条件，从而保证报表与图表数据的一致性

------

## 4. 技术框架和开发环境

- **后端**
  - Flask 2.x
  - Flask-SQLAlchemy
  - Waitress（作为生产服务器）
  - 数据库：SQLite
- **前端**
  - HTML5、CSS3、JavaScript
  - Chart.js（用于图表展示）
  - Bootstrap 5（用于快速构建响应式布局和样式）
  - Jinja2 模板引擎
- **开发环境**
  - VSCode 编辑器
  - Powershell 终端
  - Git 版本控制

------

## 5. 调用与使用方法

### 5.1 后端接口调用

- **统计报表数据接口**
  - URL: `/api/analysis/report`
  - 请求方式: GET
  - 参数:
    - 固定查询条件参数（例如 education_id, school, data_year, 等）
    - 组合查询条件参数（通过 advanced_conditions 参数传递 JSON 字符串）
  - 返回数据: JSON 格式统计数据
- **图表数据接口**
  - URL: `/api/analysis/chart`
  - 请求方式: GET
  - 参数同上
  - 返回数据: JSON 格式图表数据，适用于 Chart.js

### 5.2 前端调用

- **报表页面**
  - 报表页面（report.html）集成组合查询模块，通过 report.js 负责：
    - 收集查询条件
    - 调用统计报表接口
    - 动态生成表格和分页控件
    - 导出报表操作
- **图表页面**
  - 图表页面（chart.html）调用 Chart.js 以及相应的前端 JS 逻辑（chart.js），获取图表数据接口返回的数据，并绘制图表
  - 页面提供返回报表页面的按钮，实现两个页面之间的切换

------

## 6. 其他技术细节

### 6.1 查询模版管理

- 系统预设若干查询模版，前端通过下拉框显示（例如 templateSelect）
- 用户可在当前查询条件基础上修改，并通过“保存模版”按钮保存为新模版（保存方式可采用后端存储或浏览器本地存储，依据项目需求确定）

### 6.2 分页与导出

- 分页由 report.js 实现，利用 URL 参数传递页码和每页记录数
- 导出功能调用后端统计报表接口，返回 Excel 文件供下载

### 6.3 数据聚合计算

- 统计数据通过 SQLAlchemy 的聚合函数实现，例如：
  - 使用 `func.count` 计算各分组的记录数
  - 计算比例时，除以总记录数，返回百分比
- 多维度统计时可采用 GROUP BY 分组查询，或根据前端传递的统计维度动态生成 SQLAlchemy 过滤条件

------

## 7. 实现步骤

1. **后端统计接口开发**
   - 在 analysis_api.py 中实现 /api/analysis/report 接口，处理查询条件、进行数据聚合统计
   - 在 analysis_api.py 中实现 /api/analysis/chart 接口，处理查询条件、生成适用于图表的数据
2. **前端报表页面开发**
   - 修改 report.html，实现固定组合查询区域和报表展示区域的布局
   - 编写 report.js，实现获取查询条件、调用统计接口、生成报表和分页功能、绑定导出与页面跳转按钮
3. **前端图表页面开发**
   - 修改 chart.html，实现固定组合查询区域和图表展示区域的布局
   - 编写 chart.js，调用 /api/analysis/chart 接口获取数据，并利用 Chart.js 绘制图表
   - 绑定返回报表页面按钮
4. **查询模版功能开发**
   - 集成组合查询模块（comboQuery.html、comboQuery.js、comboQuery.css）
   - 实现预设模版下拉框及保存模版功能（可根据项目需求扩展）
5. **整体联调与测试**
   - 调试各模块接口，确保报表和图表数据一致
   - 确保分页、导出、模版保存、页面跳转等功能正常工作

------

以上即为统计报表页面及图表展示模块的功能需求及技术开发方案详细说明。请审阅并确认是否符合您的需求，我们将按照此方案开始后续开发工作。