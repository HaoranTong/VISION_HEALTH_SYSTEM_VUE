下面给出一个逐步完善功能、修复错误代码的工作步骤计划，每一步都说明具体目标、检查点和预期结果，你可以按步骤逐一执行，并在每一步完成后反馈测试结果：

------

### 第一步：明确初始页面状态和基本交互

**目标：**

- 保证报表查询页面初始状态为空，无任何统计数据显示。
- “取消”或“清除条件”按钮能够将页面恢复到刚进入时的状态（包括固定查询条件、模板选择、统计时间、组合查询条件和报表展示区域）。

**检查点：**

- 打开页面时，报表区域应为空。
- 点击“清除条件”按钮后，所有输入框和下拉框（包括模板选择和统计时间）应重置为空（或回到初始提示状态），报表数据也清空。

**预期结果：**

- 页面没有数据展示，所有条件清空。

------

### 第二步：模板下拉框与统计时间下拉框调整

**目标：**

- 修改模板下拉框：默认显示“请选择模版”，而非直接默认选中某个模版。
- 调整统计时间下拉框：下拉选项只显示从 2023 年开始的年份。

**检查点：**

- 在报表页面打开时，模板下拉框第一项为“请选择模版”，没有默认选中“按年龄段”或“按性别”。
- 统计时间下拉框的年份选项正确，从 2023 开始。

**预期结果：**

- 用户打开页面时看到模板下拉框提示“请选择模版”，统计时间下拉框显示 2023、2024、…（符合需求）。

------

### 第三步：模板下拉框的自动查询

**目标：**

- 为模板下拉框增加 `change` 事件监听，当用户选择具体模版（例如“按年龄段”或“按性别”）时，系统应自动立即查询并显示对应报表，无需额外点击“查询”按钮。
- 同时，模板下拉框中应有一个“取消”选项，当选择“取消”时，报表区域清空。

**检查点：**

- 当用户在模板下拉框中选择“按年龄段”或“按性别”时，立即触发查询请求，页面显示对应报表数据；
- 当选择“取消”时，页面报表数据被清空，且模板参数不传到后端。

**预期结果：**

- 模板选择后自动查询，且“取消”选项有效。

------

### 第四步：自由组合查询条件逻辑完善

**目标：**

- 当用户添加自由组合查询条件时，如果输入了 advanced_conditions，则自动忽略固定模板参数（template 参数为空）。
- 保证对于同一分组字段，允许用户在自由查询中多选（例如性别同时选“男”和“女”），后端应采用“OR”逻辑实现分组，并生成多行数据。
- 同时保证组合查询条件能够正确传递给后端。

**检查点：**

- 前端在调用查询时，检测到隐藏输入框（comboConditions）有内容后，不传 template 参数；
- 后端日志应显示 advanced_conditions 中的 group 条件被正确解析，并采用 OR 逻辑生成分组数据，而非过滤结果为空。

**预期结果：**

- 自由组合查询条件正确传递，后端统计接口能根据组合查询生成多行分组数据（例如性别分组显示“男”和“女”两行）。

------

### 第五步：报表名称和附注显示调整

**目标：**

- 报表默认名称由统计指标（自由组合查询中 role 为 "metric"）决定，不再自动在报表名称中添加年份；
- 年份（统计时间）以附注形式显示在报表标题行的右侧，格式为“统计时间：<所选年份>”。
- 允许用户自行输入报表名称来替代默认名称（此部分如果有对应输入框，则保证其值能覆盖默认生成的名称）。

**检查点：**

- 当用户查询后，报表标题行应显示类似“xxx统计表”加上右侧附注“统计时间：2023”（如果统计时间选择为2023）；
- 若用户自定义报表名称，则显示自定义的名称。

**预期结果：**

- 报表标题与右侧附注显示符合需求。

------

### 第六步：二级选择项复选框完善

**目标：**

- 当用户选择统计指标字段（如“视力等级”）时，在该字段的下拉菜单中为所有子选项前添加复选框，允许用户多选（比如选择“临床前期近视”、“轻度近视”和“中度近视”）。
- 前端应将用户多选的结果作为一个数组传入 advanced_conditions。

**检查点：**

- 在组合查询模块中，二级子选项前有复选框；
- 用户可以多选；
- 收集条件时，这些多选结果被作为数组传递。

**预期结果：**

- 用户可以一次选择多个子选项，后端接收到后能够按“OR”逻辑处理并分别统计。

------

### 第七步：分组统计逻辑调整

**目标：**

- 分组统计时，每个分组（如性别、班级等）的统计数量和占比应是该分组内部的计算，而非全体数据的计算。
- 报表的最后一列显示“总统计数量”，最后一行显示“合计”行，各统计项计算为各分组数据的合计。

**检查点：**

- 后端聚合查询逻辑应确保对每个分组分别计算数量和占比；
- 合计行在返回数据中正确附加。

**预期结果：**

- 报表中每行数据的占比均基于该分组内的总人数；最后一行合计正确显示。

------

### 第八步：模版保存功能

**目标：**

- 用户在自由组合查询条件查询后，可以点击“保存模版”按钮，弹出输入框默认填入当前报表名称（可编辑），保存后模版出现在模板下拉框中，供后续使用。

**检查点：**

- 前端点击“保存模版”后弹出输入框，默认报表名称能编辑并确认保存；
- 保存后，后端将模版记录存储，且模板下拉框中显示保存的模版（此部分后端保存模版逻辑如果尚未实现，可能需要预留接口）。

**预期结果：**

- 模版保存功能基本能完成（如果后端存储模版功能已实现），否则先在前端确保模版名称的编辑与显示逻辑完整。

------

### 第九步：数据年份作为独立筛选条件

**目标：**

- 数据年份不再作为组合查询中的一个普通字段，而是作为一个独立的下拉选择框，放在组合查询区域的顶部，命名为“统计时间”，供用户选择。
- 所选统计时间将作为固定过滤条件（参数 stat_time）传递给后端，并在报表标题右侧作为附注显示。

**检查点：**

- 在报表页面顶部，组合查询区域中存在统计时间下拉框，其选项范围从 2023 年开始；
- 清除条件按钮能清除统计时间的选择。

**预期结果：**

- 统计时间下拉框正常显示，并与查询条件一起正确传递到后端。

------

## 进一步说明

- **多行分组统计**：后端在解析 advanced_conditions 时，对于同一分组字段（如 gender）应将多个组别条件以“OR”逻辑合并，而分组统计结果则分别展示每个组别的统计数据（如“男”、“女”分别作为两行）。
- **复选框的实现**：前端在组合查询模块中，针对具有下级选项的字段，必须显示复选框以便多选，这部分需在 comboQuery.js 或 comboQuery_report.js 中检查和完善。
- **保持原有正确功能**：所有修改必须在不破坏已有正确功能的前提下进行，确保固定模板查询（无组合条件时）依然能正常工作。

------

请确认以上步骤和问题分析是否准确、清晰。如果确认无误，我们可以按步骤逐一修改代码，从最基础的初始页面状态、模板下拉框设置开始，再逐步完善后续功能。