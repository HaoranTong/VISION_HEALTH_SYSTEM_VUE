# 统计报表页面功能需求及技术开发方案

## 1. 概述

**目标**  
构建一个统计报表页面，用于对系统中存储的各项统计数据进行多维度聚合计算，并以报表形式展示。报表页面同时支持预设查询模版、组合查询以及分页、导出等操作，并能与图表展示页面联动（通过按钮跳转或共享查询结果）。

**主要用户**  
- 系统管理员  
- 数据分析人员

---

## 2. 功能需求

### 2.1 报表数据展示

- **数据统计范围**  
  对统计指标进行聚合计算，主要统计字段包括但不限于：  
  - 视力等级（干预前、干预后）  
  - 裸眼视力数据（左右眼）  
  - 屈光数据（左右眼球镜、柱镜、轴位）  
  - 干预效果（上升、维持、下降）  
  - 其他业务相关数据（如年龄、学校、班级等）  
  - 【新增】统计“总眼视力干预效果”：即通过左右眼数据合并计算得到的统计结果。  

- **显示内容**  
  - 以 HTML 表格形式展示统计结果。  
  - 表格表头支持多层次设计。例如：  
    - 第一层显示统计对象大类，如“临床前期近视”、“轻度近视”、“中度近视”；  
    - 每个大类下设“人数”和“占比”两个子列；  
  - 行显示各个分组（例如按性别、按年龄段或组合分组）的统计数据，分组名称显示在行头（例如“男”、“女”或“男6-9岁”、“女10-12岁”等）。  
  - 分页功能：若统计数据条目较多，可按每页固定条数（例如10条）分页显示。

### 2.2 查询功能

- **查询方式**  
  仅采用组合查询方式作为唯一查询入口，无固定查询栏。  
  - 用户可以通过组合查询模块添加条件，每个条件需明确指定其性质，即：  
    - **统计计算的对象**（统计指标）：如干预效果“上升”、“维持”、“下降”，这些是最终要统计的结果；  
    - **过滤条件**：用于筛选数据，如“数据年份”、“学校”等；  
    - **分组依据**：用于对数据进行分组统计，如“性别”、“年龄段”等。  
  - 每个条件均有一个确认项，用户可选择确认条件的性质；若未选择，系统将采用预设的默认设置。

- **查询结果**  
  - 查询结果返回后以报表表格方式展示；  
  - 同时支持导出报表（Excel 和 PDF 格式）。

### 2.3 页面布局与交互

- **整体布局**  
  - 页面继承自统一的基础模板（base.html），保证全局统一布局与样式；  
  - 页面上半部分为组合查询区域，下半部分为统计报表显示区域。  
  - 查询区域包含组合查询模块，显示预设模版下拉选择、添加条件、清除条件、查询按钮。  

- **报表区域**  
  - 采用卡片式设计，表格展示统计数据；  
  - 表头设计为多层次结构：  
    - 上层显示统计指标大类（如“临床前期近视”、“轻度近视”、“中度近视”以及【新增】“总眼视力干预效果”）；  
    - 下层显示各大类对应的“人数”和“占比”。  
  - 行部分显示分组数据，行头显示分组名称（例如，按性别统计时显示“男”、“女”；按年龄段统计时显示“6-9岁”、“10-12岁”；若组合分组则显示“男6-9岁”、“女10-12岁”等）。  
  - 报表标题中需包含用户选择的数据年份，例如“2023 学生视力情况统计表-预防干预前”。

- **操作按钮**  
  - “查询”按钮：点击后收集组合查询条件，调用后端统计接口并刷新报表数据；  
  - “导出报表”按钮：将当前报表数据导出为 Excel 和 PDF 文件；  
  - “查看图表”按钮：跳转至图表展示页面，共享当前查询条件生成图表；  
  - 查询模版管理：预设模版下拉框供用户选择已有模版；用户可在当前组合查询条件基础上进行编辑，并通过“保存模版”按钮保存新模版，后续可直接调用。

---

## 3. 技术方案

### 3.1 前端技术选型

- **模板与页面结构**  
  - 使用 Jinja2 模板引擎构建 HTML 页面，采用基础模板（base.html）统一布局；  
  - 报表页面（report.html）采用卡片式设计，并通过包含组合查询模块的 HTML 文件（comboQuery.html）实现查询区域。  

- **样式**  
  - 全局样式由 core.css 定义；  
  - 报表页面局部样式单独由 report.css 管理；  
  - 组合查询模块样式由 comboQuery.css 管理，确保与报表页面风格统一。  

- **前端交互**  
  - 使用原生 JavaScript 实现页面交互逻辑；  
  - 分别编写 report.js 管理报表数据获取、表格渲染和分页逻辑；  
  - 组合查询模块的交互由 comboQuery.js 实现，提供添加、删除、获取查询条件接口；  
  - 图表展示页面采用 Chart.js 进行图表绘制。  

### 3.2 后端技术选型

- **框架**  
  - 使用 Flask 构建 RESTful API。  

- **数据库与 ORM**  
  - 使用 SQLAlchemy 管理数据库操作，数据库采用 SQLite（数据量约 10 万条以内）。  

- **统计计算**  
  - 后端统计计算接口位于 analysis_api 蓝图中，接口包括：  
    - `/api/analysis/report` 用于返回统计报表数据（聚合统计结果，分组统计数据）；  
    - `/api/analysis/chart` 用于返回图表数据（分组统计、趋势数据等）。  
  - 统计计算逻辑基于 SQLAlchemy 聚合函数（如 func.count, func.sum, group_by 等）；  
  - 针对“总眼视力干预效果”等新增统计指标，后端在接口中增加动态计算逻辑，将左右眼数据合并统计后返回。  

### 3.3 实现逻辑

- **查询条件处理**  
  - 前端通过组合查询模块收集查询条件，每个条件明确标识性质：统计指标、过滤条件或分组依据；  
  - 用户可通过确认项指定条件性质，若未明确则采用默认预设。  
  - 前端将查询条件以 JSON 格式存入隐藏输入框，通过 URL 参数传递给后端统计接口。  

- **报表数据生成**  
  - 后端接口根据查询条件对 Student 与 StudentExtension 数据进行过滤和聚合统计，生成数据格式示例：  

    ```json
    {
      "tableName": "2023 学生视力情况统计表-预防干预前(按性别)",
      "header": [
         "性别", 
         "临床前期近视(人数)", "临床前期近视(占比)",
         "轻度近视(人数)", "轻度近视(占比)",
         "中度近视(人数)", "中度近视(占比)",
         "视力不良(人数)", "视力不良(占比)",
         "统计人数"
      ],
      "rows": [
         {
           "row_name": "男",
           "pre_clinic_count": 51,
           "pre_clinic_ratio": 52.04,
           "mild_count": 36,
           "mild_ratio": 36.73,
           "moderate_count": 3,
           "moderate_ratio": 3.06,
           "bad_vision_count": 90,
           "bad_vision_ratio": 91.84,
           "total_count": 98
         },
         {
           "row_name": "女",
           "pre_clinic_count": 48,
           "pre_clinic_ratio": 47.06,
           "mild_count": 46,
           "mild_ratio": 45.1,
           "moderate_count": 5,
           "moderate_ratio": 4.9,
           "bad_vision_count": 99,
           "bad_vision_ratio": 97.06,
           "total_count": 102
         },
         {
           "row_name": "合计",
           "pre_clinic_count": 99,
           "pre_clinic_ratio": 49.5,
           "mild_count": 82,
           "mild_ratio": 41,
           "moderate_count": 8,
           "moderate_ratio": 4,
           "bad_vision_count": 189,
           "bad_vision_ratio": 94.5,
           "total_count": 200
         }
      ]
    }
    ```

  - 前端 report.js 接收数据后，根据 header 数组动态生成多层次表头和表体数据；  
  - 分页功能根据返回数据条数进行分页；  

- **图表数据生成**  
  - 图表页面调用 `/api/analysis/chart` 接口获取数据，返回数据格式适用于 Chart.js；  
  - 前端图表页面利用 Chart.js 绘制柱状图或其他类型图表，并支持鼠标悬停显示详细数据；  

- **页面跳转与联动**  
  - 报表页面和图表页面均提供切换按钮，用户在报表页面查询后，通过“查看图表”按钮跳转到图表页面，图表页面自动使用相同查询条件生成图表；  
  - 同时，图表页面提供返回报表页面的按钮，实现双向联动。

---

## 4. 技术框架和开发环境

- **后端**  
  - Flask 2.x  
  - Flask-SQLAlchemy  
  - Waitress（生产服务器）  
  - 数据库：SQLite

- **前端**  
  - HTML5、CSS3、JavaScript  
  - Chart.js（用于图表展示）  
  - Bootstrap 5（响应式布局和样式）  
  - Jinja2 模板引擎  

- **开发环境**  
  - VSCode 编辑器  
  - Powershell 终端  
  - Git 版本控制

---

## 5. 调用与使用方法

### 5.1 后端接口调用

- **统计报表数据接口**  
  - URL: `/api/analysis/report`  
  - 请求方式: GET  
  - 参数:  
    - 固定查询条件参数（例如 education_id, school, data_year, grade, 等）  
    - 组合查询条件参数（通过 advanced_conditions 参数传递 JSON 字符串）  
    - 模版参数：template（例如 template1 表示按年龄段统计，template2 表示按性别统计）  
  - 返回数据: JSON 格式统计数据（包括 tableName、header、rows 等字段）

- **图表数据接口**  
  - URL: `/api/analysis/chart`  
  - 请求方式: GET  
  - 参数同上  
  - 返回数据: JSON 格式图表数据，适用于 Chart.js

### 5.2 前端调用

- **报表页面**  
  - 报表页面（report.html）集成组合查询模块，通过 report.js 实现：  
    - 收集查询条件  
    - 调用统计报表接口  
    - 动态生成表头、表格数据和分页控件  
    - 支持预设模版选择与保存  
    - 导出报表（支持 Excel 与 PDF 格式）  
    - 提供“查看图表”按钮，跳转至图表页面

- **图表页面**  
  - 图表页面（chart.html）调用 Chart.js 及 chart.js 脚本获取图表数据接口返回的数据，绘制图表；  
  - 提供返回报表页面按钮，实现报表与图表数据联动。

---

## 6. 其他技术细节

### 6.1 查询模版管理

- 系统预设若干查询模版（例如“按年龄段”、“按性别”），前端通过下拉框显示；  
- 用户可在当前组合查询条件基础上修改，并通过“保存模版”按钮保存为新模版（保存方式可采用后端存储或浏览器本地存储，由项目需求决定）。

### 6.2 分页与导出

- 分页由 report.js 实现，利用 URL 参数传递页码和每页记录数；  
- 导出功能调用后端接口，支持同时导出 Excel 和 PDF 文件。

### 6.3 数据聚合计算

- 统计数据通过 SQLAlchemy 聚合函数实现，如 `func.count`、`func.sum` 等；  
- 对于多维度统计，采用 GROUP BY 分组查询，支持用户自定义分组顺序；  
- 针对“总眼视力干预效果”等新指标，后端在接口中增加动态计算逻辑，将左右眼数据合并统计。

---

## 7. 实现步骤

1. **后端统计接口开发**  
   - 在 analysis_api.py 中实现 `/api/analysis/report` 接口，处理查询条件、进行数据聚合统计，并支持模版参数。  
   - 在 analysis_api.py 中实现 `/api/analysis/chart` 接口，生成适用于图表的数据。  

2. **前端报表页面开发**  
   - 修改 report.html，实现组合查询区域与报表展示区域的布局；  
   - 编写 report.js，实现收集组合查询条件、调用统计接口、动态生成多层次表头和表体、分页及导出功能。  

3. **前端图表页面开发**  
   - 修改 chart.html，实现图表展示区域与组合查询区域的布局；  
   - 编写 chart.js，调用 `/api/analysis/chart` 接口获取数据，并利用 Chart.js 绘制图表；  
   - 绑定返回报表页面按钮，确保数据联动。  

4. **查询模版功能开发**  
   - 集成组合查询模块（comboQuery.html、comboQuery.js、comboQuery.css）；  
   - 实现预设模版下拉选择和模版保存功能。  

5. **整体联调与测试**  
   - 调试各模块接口，确保报表与图表数据一致；  
   - 测试分页、导出、模版保存、页面跳转等功能，确保所有功能正常工作。

---

## 8. 使用示例

- 用户在报表页面选择模版“按性别”，然后在组合查询区域添加查询条件（例如选择“干预效果”为“上升”、“下降”以及其他过滤条件），点击“查询”按钮。  
- 系统将根据查询条件调用 `/api/analysis/report` 接口返回统计数据，前端动态生成表格，表头显示“性别”、“临床前期近视(人数)”、“临床前期近视(占比)”、“轻度近视(人数)”、“轻度近视(占比)”、“中度近视(人数)”、“中度近视(占比)”、“视力不良(人数)”、“视力不良(占比)”、“统计人数”；表体行显示“男”、“女”、“合计”等分组数据。  
- 用户点击“导出报表”可导出 Excel 或 PDF 文件；  
- 用户点击“查看图表”跳转到图表页面，图表页面利用相同查询条件调用 `/api/analysis/chart` 接口，生成柱状图或其他图表展示统计结果。

---

以上即为最终整理的统计报表页面功能需求及技术开发方案。请审阅确认，之后我们将严格按照此方案进行代码开发工作。

---

请确认以上文档内容是否完全满足您的要求。