下面是一份完整的关于数据查询模块的功能及技术开发文档，内容涵盖所有功能细节、技术细节以及调用和使用方法，采用结构化的 Markdown 格式输出：

------

# 数据查询模块功能及技术开发文档

## 1. 模块概述

### 1.1 功能目标

数据查询模块的主要目标是为近视预防干预系统提供多维度、多条件的学生数据查询与导出功能，支持以下功能：

- **固定查询**
  - 用户可通过固定查询区域输入简单条件，如教育ID号、学校、年级、班级、数据年份、姓名、性别和身份证号码。
  - 固定查询使用模糊匹配或精确匹配（如身份证号码），直接通过 SQLAlchemy 过滤器构造查询条件。
- **组合查询**
  - 用户可通过组合查询区域动态添加任意查询条件，实现更复杂的查询需求。
  - 支持文本输入、下拉选择、数值区间查询、多选复选框（用于干预效果等）和单个复选框（用于布尔值字段）。
  - 所有组合查询条件将收集成 JSON 数组，并传递给后端查询接口，与固定查询条件叠加使用。
- **分页显示**
  - 查询结果支持分页，每页显示固定数量（如10条）记录，并提供页码导航，确保所有记录均可通过分页查看。
- **列配置**
  - 用户可通过下拉菜单配置需要在结果表中显示的列，列配置列表完整反映数据库中的字段。
  - 选中的列会传递给后端导出接口，生成 Excel 文件时以中文列名输出。
- **数据导出**
  - 用户在查询结果页面点击“导出”按钮后，根据当前查询条件和列配置，将查询结果导出为 Excel 文件。

### 1.2 技术目标

- **统一查询接口**
  - 固定查询与组合查询条件共同构成最终查询参数，后端接口解析后统一构造 SQLAlchemy 查询对象。
- **配置驱动**
  - 查询条件（尤其是组合查询部分）采用配置对象定义，各字段类型、查询控件和选项均可灵活配置，便于后续扩展和维护。
- **前后端分离**
  - 前端查询页面与后端 API 接口通过 URL 参数进行数据交互，确保模块化设计、易于调试和测试。
- **界面及交互**
  - 固定查询区域与组合查询区域在数据查询页面中并排显示，各自布局合理，支持动态添加、删除查询条件。
  - 分页、列配置、数据表格等前端交互功能与后端返回数据协同工作，保证数据展示的完整性与准确性。

------

## 2. 模块架构与实现

### 2.1 前端部分

#### 2.1.1 固定查询区域

- 功能

  ：

  固定查询区域用于输入常用条件，采用两个排版：

  - 第一排：教育ID号、学校、年级、班级、数据年份（通过文本输入框或下拉框）。
  - 第二排：姓名、性别、身份证号码、以及查询、导出、清除和列配置按钮。

- 技术实现

  ：

  - 使用 Bootstrap 网格系统（如 `col-md-2`、`col-md-6` 等）确定每个控件所占宽度。
  - 使用模糊匹配（`ilike`）与精确匹配过滤（如身份证号码）构造查询条件。
  - 固定查询区域的值通过 JavaScript 中的 `getQueryParams()` 函数收集，与组合查询条件一起传递给后端接口。

#### 2.1.2 组合查询区域

- 功能

  ：

  组合查询区域允许用户动态添加多条查询条件，以构造复杂查询。主要功能包括：

  - 动态添加查询条件行（点击“添加条件”按钮）。
  - 每一行根据字段类型生成相应控件：
    - 文本型：生成文本输入框。
    - 下拉选择型：生成下拉选择框，选项与列配置保持一致。
    - 数值区间型：生成两个输入框，分别用于输入最小值和最大值。
    - 多选复选框：生成一组复选框（例如干预效果），选项固定为“上升”、“维持”、“下降”。
    - 单个复选框：用于布尔类型字段（如“刮痧”、“艾灸”等）。
  - 将所有查询条件行数据收集成 JSON 数组，并存入隐藏输入框（id="comboConditions"）。
  - 点击组合查询区的“查询”按钮后，调用固定查询页面的查询方法（如 `fetchData()`）进行数据刷新。

- 技术实现

  ：

  - 组合查询区域 HTML 结构单独封装为 `comboQuery.html`，样式封装在 `comboQuery.css`，交互逻辑封装在 `comboQuery.js`。
  - 查询条件控件的生成与数据收集基于配置对象 `comboQueryConfig`，所有字段的控件类型及选项均由该对象定义。

#### 2.1.3 分页与列配置

- 分页
  - 前端分页功能通过 JS 中的 `renderPagination()` 函数实现，根据返回数据总记录数计算页码，并绑定点击事件加载对应页数据。
- 列配置
  - 下拉菜单中列出所有数据库字段对应的中文名称，用户可选择需要显示的列。
  - 选中项通过 JS 中的 `getSelectedColumns()` 函数收集，并在导出和表格渲染时生效。

#### 2.1.4 前端文件结构

- HTML 文件
  - `query.html`：数据查询页面，包含固定查询区域、组合查询区域（通过 `{% include "comboQuery.html" %}` 引入）以及结果展示区域。
- CSS 文件
  - `query.css`：数据查询页面局部样式，主要负责固定查询区域和结果表格的样式。
  - `comboQuery.css`：组合查询模块的样式，控制卡片外观、按钮、控件间距及滚动区域等。
- JS 文件
  - `query.js`：固定查询、分页、列配置及数据表格渲染逻辑。
  - `comboQuery.js`：组合查询模块的动态交互逻辑，负责添加条件行、收集条件数据以及触发查询操作。

### 2.2 后端部分

#### 2.2.1 查询接口（/api/students/query）

- 功能

  ：

  - 接受固定查询参数和 advanced_conditions 参数，解析组合查询条件。
  - 调用 `build_query()` 函数，根据固定查询与组合查询条件构造 SQLAlchemy 查询对象。
  - 执行查询、分页，并将查询结果转换为 JSON 格式返回给前端。

- 关键函数

  ：

  - `build_query()`：核心函数，读取请求参数，解析 JSON 格式的 advanced_conditions，将所有条件组合后应用到查询中。
  - `record_to_dict()`：将 ORM 查询结果转换为字典，便于 JSON 序列化。

#### 2.2.2 数据导出接口

- 功能

  ：

  - 根据当前查询条件（固定查询与组合查询条件）导出 Excel 文件。
  - 支持列配置，用户选择的列将映射为中文列名输出到 Excel 中。

### 2.3 调用与集成

- **前端页面调用**
  - 数据查询页面通过模板继承 `base.html`，在页面中引入 `query.css`、`comboQuery.css`、`query.js` 和 `comboQuery.js`。
  - 固定查询区域与组合查询区域通过并排布局（例如各占 50% 宽度）显示在页面顶部。
  - 用户在组合查询区域中添加条件后，点击“查询”按钮时，comboQuery.js 会将所有条件转换为 JSON 字符串存入隐藏输入框，并调用固定查询区域的 `fetchData()` 函数，统一触发查询。
- **后端 API 调用**
  - 前端调用 `/api/students/query` 接口，通过 URL 参数传递固定条件和 advanced_conditions（组合查询条件），后端解析并返回查询结果，前端接收到 JSON 数据后进行分页及表格渲染。

------

## 3. 技术细节

### 3.1 配置驱动

- 配置对象 comboQueryConfig

  - 定义所有组合查询字段及其对应的控件类型和选项，便于后续修改。

  - 示例格式：

    ```javascript
    const comboQueryConfig = {
      "data_year": {
        label: "数据年份",
        type: "dropdown",
        options: ["2023", "2024", "2025", "2026", "2027", "2028"]
      },
      "education_id": { label: "教育ID号", type: "text" },
      "school": {
        label: "学校",
        type: "dropdown",
        options: ["华兴小学", "苏宁红军小学", "师大附小清华小学"]
      },
      // …其它字段配置…
      "左眼视力干预效果": {
        label: "左眼视力干预效果",
        type: "multi-select",
        options: ["上升", "维持", "下降"]
      },
      // …复选框类型…
      "刮痧": { label: "刮痧", type: "checkbox" }
      // …其他字段…
    };
    ```

  - 在 comboQuery.js 中，根据该配置生成相应的查询条件行控件。

### 3.2 CSS 全局变量与模块样式隔离

- 局部 CSS 变量
  - 在 comboQuery.css 中定义模块局部变量（例如 `--combo-card-width`、`--combo-header-bg` 等），确保模块样式易于维护和调整，同时不会影响全局样式。
- 父容器与相对宽度
  - 前端页面中固定查询区域和组合查询区域的宽度在 query.css 中定义，并通过 HTML 布局（如 Bootstrap 网格系统）确定父容器宽度。
  - 组合查询模块通过引用 comboQuery.css 并覆盖局部变量，可实现宽度和其它样式属性的定制。

### 3.3 JS 模块调用与接口联动

- **组合查询模块初始化**
  - 在 DOMContentLoaded 后，comboQuery.js 自动初始化，绑定“添加条件”、“清除条件”、“查询”按钮事件，并生成查询条件行。
  - 当用户点击组合查询区域的“查询”按钮时，getComboConditions() 收集条件数据并存入隐藏输入框，然后调用固定查询区域中的 fetchData() 函数，实现条件联动查询。
- **统一查询逻辑**
  - 固定查询区域与组合查询区域最终都调用相同的后端查询接口（/api/students/query），后端在 build_query() 函数中解析固定条件与 advanced_conditions 条件，并返回统一的查询结果。

------

## 4. 调用使用方法

### 4.1 前端调用

- 在数据查询页面（query.html）中包含以下内容：
  - 固定查询区域的 HTML 代码（包含教育ID号、学校、年级等输入控件和按钮）。
  - 组合查询区域通过 `{% include "comboQuery.html" %}` 引入，确保 comboQuery.css 和 comboQuery.js 被正确加载。
  - 引入 query.js，用于处理固定查询、分页、列配置以及读取组合查询条件（从隐藏输入框 comboConditions）。

### 4.2 后端调用

- 前端发起查询请求时，将固定查询条件和组合查询条件（advanced_conditions 参数）一并传递给后端。
- 后端查询接口（/api/students/query）在 build_query() 函数中解析所有条件，构造 SQLAlchemy 查询对象，执行查询后返回 JSON 格式的结果数据，供前端分页和表格渲染使用。

### 4.3 数据导出调用

- 导出功能基于当前查询条件及列配置，通过调用 /api/students/export 接口生成 Excel 文件，供用户下载。

------

## 5. 测试步骤

1. **页面加载检查**
   - 打开数据查询页面，检查固定查询区域和组合查询区域是否并排显示，且布局、样式正确。
2. **固定查询测试**
   - 在固定查询区域输入条件（如学校、姓名等），点击“查询”按钮，确认查询结果与条件匹配，分页功能正常。
3. **组合查询测试**
   - 点击“添加条件”按钮，添加查询条件（例如选择“学校”字段并选择“苏宁红军小学”，或输入部分姓名）。
   - 点击组合查询区域的“查询”按钮，检查隐藏输入框 comboConditions 中是否生成了正确的 JSON 字符串，并触发固定查询的 fetchData()，查询结果正确显示。
4. **列配置测试**
   - 打开列配置下拉菜单，确认所有列配置项完整显示，并根据选中情况调整结果表格列的显示。
5. **数据导出测试**
   - 根据当前查询条件和列配置，点击“导出”按钮，确认 Excel 文件中列名称和数据与页面显示一致。
6. **调试日志检查**
   - 打开浏览器开发者工具的 Network 和 Console 面板，检查查询请求 URL 中 advanced_conditions 参数是否正确，后端日志中输出固定条件和组合条件是否符合预期。

------

## 6. 注意事项

- **代码输出要求**
   所有修改的代码必须保留原有经过验证的部分，仅增加或修改与组合查询相关的代码；输出完整文件内容，确保直接覆盖源文件后能够正确运行。
- **模块化设计**
   组合查询模块的 HTML、CSS、JS 均独立封装，便于在其它页面（如统计分析模块）中调用，调用时可根据父容器样式调整局部 CSS 变量实现样式定制。
- **调试与日志**
   在关键函数（如 build_query()）中可适当添加调试日志，以便排查组合查询条件传递和解析问题；请确保日志信息能在服务器终端正确输出。

------

## 7. 结论

以上文档详细描述了数据查询模块的整体功能、技术实现细节、调用使用方法及测试步骤。模块实现了固定查询、组合查询、分页、列配置和数据导出等功能，采用配置驱动和模块化设计，保证了功能的灵活性和可扩展性。

请仔细阅读并确认该文档是否满足您的需求，如有任何问题或需要进一步调整，请告知。