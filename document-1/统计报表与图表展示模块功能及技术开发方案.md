下面是一份经过详细讨论后整理的统计报表页面及图表展示模块的功能与技术开发方案文档，供后续开发参考，请仔细阅读确认：

------

# 统计报表与图表展示模块功能及技术开发方案

## 1. 概述

**目标**
 构建一个统计分析模块，实现对系统内存储的各类数据进行多维度聚合计算，并分别以报表和图表两种形式展示统计结果。模块须满足以下要求：

- 支持用户通过组合查询方式过滤数据（支持预设模板、条件添加、清除、查询操作）。
- 报表页面通过 HTML 表格展示统计数据，并支持分页、导出功能。
- 图表页面利用 Chart.js 绘制图示，展示与报表数据对应的统计结果，并支持鼠标悬停显示详细信息。
- 两个页面之间能通过按钮实现跳转，且共享相同的查询条件，保证报表与图表数据一致。

**主要用户**

- 系统管理员
- 数据分析人员

------

## 2. 功能需求

### 2.1 报表数据展示

- **统计指标**
  - 统计视力数据，包括（但不限于）：
    - 视力等级（干预前与干预后）
    - 裸眼视力数据（左右眼）
    - 屈光数据（左右眼球镜、柱镜、轴位）
    - 干预效果（上升、维持、下降）
  - 同时支持按其他业务数据（例如学校、年级、班级、年龄等）进行分组统计。
- **展示方式**
  - 以 HTML 表格形式展示统计结果。
  - 表头显示各统计维度名称；
  - 表格行显示各分组数据，包括“记录数”和“占总人数的比例”。
  - 数据前置显示数据年份（例如“2023 学生视力情况统计表-预防干预前”）。
- **分页与导出**
  - 当统计记录条数较多时，页面通过分页控件（例如每页10条）显示所有数据。
  - 提供“导出报表”按钮，支持将当前统计结果导出为 Excel 文件。

### 2.2 查询功能

- **查询方式**
  - 仅采用组合查询作为唯一查询入口，固定查询条件在报表页面中不再提供列配置功能。
  - 采用组合查询模块：
    - 支持预设查询模板（例如“模版1：按年龄分组”、“模版2：按性别分组”），模板中预先定义统计维度；
    - 用户可以在预设模板基础上修改（增减、调整统计维度），临时生成新的查询条件，或保存为新模板。
- **查询条件类型**
  - 固定字段（学校、年级、性别、数据年份等）采用下拉选择；
  - 数值型字段（裸眼视力、屈光数据等）支持区间查询（输入最小值和最大值）；
  - 多选字段（干预效果）采用复选框；
  - 文本型字段（姓名）支持模糊查询。
- **查询结果处理**
  - 查询条件由组合查询模块收集，并存入隐藏输入框，通过 URL 参数传递到后端统计接口。
  - 后端统计接口根据查询条件执行聚合统计，并返回 JSON 格式数据给前端，前端动态生成表格内容。

### 2.3 图表展示功能

- **图表数据**
  - 图表页面调用后端图表数据接口获取统计结果，数据格式适合 Chart.js 绘制图表。
  - 示例数据包括：
    - 分组标签（例如“上升”、“维持”、“下降”）
    - 每个分组的统计数据（人数或比例）
    - 可配置不同图表类型（柱状图、饼图、折线图等）。
- **展示方式**
  - 图表页面显示一个主要图表区域，利用 Chart.js 绘制图示。
  - 鼠标悬停在图表上时显示详细数据（如具体人数、比例等）。
  - 图表页面提供“返回报表”按钮，跳转回统计报表页面；同样，报表页面提供“查看图表”按钮，跳转到图表页面，保证数据一致性。

### 2.4 页面布局与交互

- **整体布局**
  - 页面继承自统一的基础模板（base.html），保持全局导航、侧边栏、顶部导航一致。
  - 报表页面上半部分为查询区域（组合查询模块），下半部分为统计报表展示区域。
  - 图表页面同样包括查询区域和图表展示区域，但仅展示图表，不再显示数据报表。
- **操作按钮**
  - 查询按钮：收集组合查询条件，调用后端统计接口刷新报表数据；
  - 导出报表按钮：导出当前报表数据；
  - 切换按钮：报表页面的“查看图表”按钮和图表页面的“返回报表”按钮实现页面间跳转。
- **查询模版管理**
  - 提供预设模版下拉菜单，允许用户选择已有模版；
  - 保存模版功能：用户修改当前查询条件后可保存为新模版，下次直接调用。

------

## 3. 技术方案

### 3.1 前端

- **模板与页面结构**
  - 使用 Jinja2 模板引擎构建页面（如 report.html、chart.html）。
  - 采用基础模板（base.html）统一加载全局 CSS、JS 文件。
- **样式**
  - 全局样式由 core.css 定义。
  - 报表页面局部样式由 report.css 管理。
  - 组合查询模块样式由 comboQuery.css 提供，需调整类名避免与报表页面冲突（如将组合查询模块的卡片类统一改为 .report-combo-query-card）。
- **交互逻辑**
  - report.js：负责报表数据的获取、表格动态生成、分页及导出功能。
  - comboQuery.js：负责组合查询模块的条件添加、清除、条件收集等功能。
  - 图表页面使用 Chart.js 及 chart.js 脚本实现图表绘制，数据通过 analysis_api 接口获取。

### 3.2 后端

- **框架**
  - 使用 Flask 构建 RESTful API；
  - 蓝图注册各功能模块接口（如 import_api、query_api、analysis_api）。
- **数据库与 ORM**
  - 使用 Flask-SQLAlchemy 操作 SQLite 数据库（数据量10万条以内）。
- **统计计算**
  - 统计接口在 analysis_api 蓝图中实现，提供：
    - /api/analysis/report 接口：根据查询条件对 Student 与 StudentExtension 数据进行聚合统计（使用 func.count、group_by 等函数），返回统计报表数据。
    - /api/analysis/chart 接口：返回适用于图表展示的统计数据（格式适用于 Chart.js）。

### 3.3 实现逻辑

- **查询条件处理**
  - 前端组合查询模块收集条件，存入隐藏输入框 comboConditions；
  - 报表页面和图表页面在查询时都调用 getReportQueryParams()（或类似函数）将固定条件和组合查询条件拼接为 URL 参数，调用后端统计接口。
- **数据聚合统计**
  - 后端统计接口接收查询条件，构造 SQLAlchemy 查询，使用聚合函数计算每个分组（例如按照视力干预效果、性别、年龄段分组）的记录数；
  - 返回 JSON 格式统计数据，包括总人数、各分组人数和比例等。
- **报表生成**
  - 前端 report.js 接收统计数据后，动态生成表头与表格数据，分页控件根据总记录数动态生成；
  - 用户点击导出报表按钮时调用后端导出接口生成 Excel 文件。
- **图表生成**
  - 图表页面调用 /api/analysis/chart 接口，返回数据后利用 Chart.js 绘制柱状图、饼图等；
  - 支持鼠标悬停显示详细信息，提供图表切换及返回报表页面按钮。

------

## 4. 开发步骤

1. **后端接口开发**
   - 在 `analysis_api.py` 中实现 /api/analysis/report 接口，完成聚合统计逻辑。
   - 在 `analysis_api.py` 中实现 /api/analysis/chart 接口，生成适用于图表展示的数据格式。
   - 确保统计计算逻辑支持按预设模版（例如按年龄、按性别）分组统计。
2. **前端报表页面开发**
   - 修改/完善 `report.html`，确保组合查询模块、报表展示区域、分页控件、导出和切换按钮正确布局。
   - 编写/完善 `report.js`，实现查询条件收集、调用统计接口、动态生成表格和分页控件、绑定导出与页面切换按钮。
3. **前端图表页面开发**
   - 修改/完善 `chart.html`，确保图表展示区域与查询区域布局合理。
   - 编写 `chart.js`（或在已有 chart.js 中扩展），调用 /api/analysis/chart 接口，并利用 Chart.js 绘制图表。
   - 绑定返回报表页面按钮，确保图表和报表之间共享查询条件。
4. **查询模版管理开发**
   - 集成组合查询模块（comboQuery.html、comboQuery.js、comboQuery.css），实现预设模板下拉菜单和保存模板功能。
   - 确保预设模板能自动填充查询条件，并能在报表和图表页面中使用统一的查询条件。
5. **整体联调与测试**
   - 分别测试报表页面和图表页面的查询、分页、导出、图表绘制及页面切换功能。
   - 确保统计报表数据和图表数据在不同查询条件下一致。
   - 调试并解决所有前后端交互问题，确保最终用户体验流畅。

------

## 5. 技术框架与开发环境

- **后端**
  - Flask 2.x
  - Flask-SQLAlchemy
  - Waitress（生产服务器）
  - SQLite
- **前端**
  - HTML5、CSS3、JavaScript（原生）
  - Chart.js
  - Bootstrap 5
  - Jinja2 模板
- **开发环境**
  - VSCode
  - Powershell
  - Git

------

## 6. 调用与使用方法

### 6.1 后端接口

- **统计报表接口**
  - URL: `/api/analysis/report`
  - 请求方式: GET
  - 参数: 固定查询条件及组合查询条件（advanced_conditions，JSON 格式）
  - 返回数据: JSON 格式报表统计数据
- **图表数据接口**
  - URL: `/api/analysis/chart`
  - 请求方式: GET
  - 参数同上
  - 返回数据: JSON 格式图表数据，适用于 Chart.js

### 6.2 前端页面

- **报表页面 (report.html)**
  - 包含组合查询区域（通过 comboQuery.html 调用组合查询模块）
  - 通过 report.js 获取查询条件、调用统计接口，动态生成报表表格、分页控件
  - 提供导出报表按钮
- **图表页面 (chart.html)**
  - 包含组合查询区域与图表展示区域
  - 通过 chart.js 调用图表数据接口，利用 Chart.js 绘制图表
  - 提供返回报表页面按钮

------

## 7. 实现细节

- **数据聚合计算**
  - 利用 SQLAlchemy 的聚合函数（如 func.count、group_by）实现按不同统计维度分组统计
  - 支持动态解析组合查询条件，过滤数据后再聚合统计
- **报表与图表联动**
  - 保证报表页面和图表页面均从相同的查询条件出发，调用后端接口获取统计数据
  - 页面跳转通过按钮实现，保证查询条件通过 URL 参数或隐藏输入框共享
- **查询模版**
  - 预设模版由下拉菜单提供，后端不保存模版（也可根据需求保存至数据库或浏览器本地存储）
  - 模版内容包括固定组合查询条件，用户可修改后保存为新模版

------

以上即为统计报表与图表展示模块的完整功能及技术开发方案。请确认是否符合您的要求，我们将严格按照此方案进行后续代码开发和完善工作。