下面是一份详细的技术文档，专门针对“数据导入”功能的开发、使用以及后续扩展提出说明。请仔细阅读，并保存到长期记忆中。该文档同时指出了哪些模块可以扩展、哪些代码不宜修改，以及页面与组件之间的关系。

------

# 数据导入功能开发及使用技术文档

## 1. 功能概述

“数据导入”功能主要用于将学生数据以 Excel（.xlsx）或 CSV（.csv）格式批量导入系统。主要包括以下几个方面：

- **文件上传与解析**

  - 用户可通过拖拽或文件选择方式上传文件。
  - 前端页面（data_import.html）负责文件选择、显示文件列表、触发上传等操作。

- **数据校验**

  - 后端使用 Pandas 读取文件，清洗列名称（去除空格、隐藏字符）。
  - 对每一行数据进行必填字段检查和基本格式、数值范围校验（例如裸眼视力必须在 0.1～5.0 之间）。
  - 若一行记录中存在多个必填项缺失，则该行只计作一条失败记录。

- **数据库写入与部分更新**

  - 根据“教育ID号”作为唯一标识，判断记录是否已存在。

    - **新记录**：直接创建新的 Student 对象。

    - 已存在记录

      ：执行“部分更新”逻辑，即：

      - 若数据库中某字段已有值，则不允许覆盖；
      - 若该字段为 None，而上传数据有值，则进行填充。

  - 出现重复覆盖或数据格式错误时，视为失败。

- **失败记录导出**

  - 对所有失败的行生成一个“上传失败记录表”，该表仅包含失败行，并在新增的“错误信息”列中标注具体错误。
  - 使用 Pandas+XlsxWriter 导出失败记录，并将生成的文件保存在指定的公开目录（如 frontend/static/uploads），同时提供下载链接。

- **前端反馈**

  - 上传完成后，页面显示成功和失败的记录数，若有失败记录则显示下载链接。

## 2. 主要代码模块及其说明

### 2.1 前端页面：data_import.html

- **位置与作用**

  - 位于 `frontend/templates/data_import.html`，该页面继承了 `layouts/base.html`，由顶部导航栏和侧边栏组件共同构成。
  - 页面内包含文件上传区域、文件列表显示、选择/取消/上传按钮等交互元素。

- **重要部分说明**

  - 文件输入控件（隐藏的 `<input type="file" id="fileInput" ...>`）由 JavaScript 控制。

  - 按钮（#selectFileBtn、#cancelBtn、#uploadBtn）通过事件监听触发相应的操作。

  - 最后在 

    ```
    {% block scripts %}
    ```

     内嵌入了 JavaScript 脚本，该脚本负责：

    - 处理文件选择和拖拽；
    - 更新文件列表显示；
    - 对多个文件采用并行上传（Promise.all）。

*扩展修改说明：*

- 若需要增加上传前校验（例如检查文件大小或预览部分数据），可在该页面的 JavaScript 部分增加事件监听或修改 updateFileList() 函数。
- 注意不要删除或修改已有的按钮 ID 和 DOM 结构，否则会导致 JS 绑定失效。

### 2.2 后端接口：import_api.py

- **位置与作用**

  - 位于 

    ```
    backend/api/import_api.py
    ```

    。该模块实现数据导入接口 

    ```
    /api/students/import
    ```

    ，负责：

    - 文件上传及保存（临时目录 TEMP_UPLOAD_DIR）。
    - 使用 Pandas 解析文件、清洗列名称（`df.columns = df.columns.str.strip()`）。
    - 调用 `validate_required_fields()` 对每行进行必填字段及格式校验。
    - 根据 “教育ID号” 判断是新增还是部分更新（函数 `partial_update_student()`）。
    - 对失败的行，记录错误信息并生成失败记录表（导出到 FAILURE_UPLOAD_DIR，文件可通过 URL 下载）。

- **关键函数说明**

  - **allowed_file(filename)**
     判断上传文件扩展名是否在允许范围内（xlsx, csv）。
  - **validate_required_fields(row, required_fields, row_index)**
     检查每一行是否缺失必填字段，并对裸眼视力进行数值范围和格式检查。
     *扩展建议：* 如果需要忽略隐藏字符或额外处理列名，可以在读取 DataFrame 后增加列名称清洗代码。
  - **partial_update_student(student_obj, row, row_index, errors)**
     针对已存在记录执行部分更新：若数据库字段已有值，则不允许覆盖；否则更新。
  - **import_students()**
     主接口函数，依次执行以下步骤：
    1. 检查上传文件是否存在、文件格式是否允许。
    2. 保存上传文件到临时目录，并用 secure_filename() 处理文件名。
    3. 根据扩展名解析文件，生成 DataFrame。
    4. 清洗列名称（去除首尾空格）。
    5. 对每一行进行必填字段校验，累计错误信息，并记录失败行（用集合 failed_rows 记录行号，保证每条记录只计一次）。
    6. 对合格数据，新建或部分更新 Student 对象。
    7. 提交数据库；若提交失败则回滚。
    8. 如果存在失败行，则生成失败记录表（只导出失败行，并在“错误信息”列中写入对应的错误提示，使用 XlsxWriter 标红）。
    9. 删除临时文件，并返回 JSON 结果（包含导入成功记录数、失败记录数、失败记录文件下载链接）。

*扩展修改说明：*

- 若后续需要扩展其他字段校验或处理逻辑，可在 `validate_required_fields()` 与 `partial_update_student()` 内添加相应判断。
- 请注意不要随意更改数据库模型（例如 Student 类定义）中的字段名称，除非已在所有代码中同步更新。
- 目前的“重复上传”逻辑是通过检查数据库中是否存在相同“教育ID号”来实现的。
- 如果需要更改失败记录表的生成格式或添加其他信息，修改对应失败记录部分的代码。

### 2.3 数据库模型：Student（student.py）

- 位置与作用
  - 位于 `backend/models/student.py`。定义学生基本信息数据库表。
- 注意事项
  - 根据最新要求，“教育ID号”现在作为唯一索引，因此在模型中对应字段名称改为 `education_id`（原 full_edu_id 已删除）。
  - 其他字段如学校、年级、班级、姓名、性别、裸眼视力、矫正视力等保持不变。

*扩展建议：*

- 如果后续需要支持更多字段（例如扩展信息放在另外一个表中），请不要修改已验证通过的 Student 模型，而是创建新的模型（例如 StudentExtension）。

### 2.4 路由与整体应用：app.py

- 位置与作用
  - 位于 `app.py`，负责创建 Flask 应用、初始化数据库、注册蓝图、配置日志以及定义首页和数据导入页面路由。
- 重要说明
  - 不要修改蓝图注册和数据库初始化的相关代码，除非明确需要调整数据导入功能的路由或静态文件路径。
  - 数据导入页面路由定义为 `/import`，在模板中应使用 `url_for('import_api.import_students')` 生成接口 URL。

## 3. 开发及调试流程

### 3.1 功能开发步骤

1. **功能需求明确**
   - 根据需求文档确认必填字段、校验规则、重复记录处理策略及失败记录表生成要求。
2. **前端页面调试**
   - 使用 data_import.html 进行测试。确保文件选择、拖拽、上传按钮等功能正常。
   - 检查 Network 面板中上传请求的状态和响应数据。
3. **后端调试**
   - 通过日志输出（使用 current_app.logger.debug()）确认文件上传、DataFrame 解析、校验及数据库写入各步骤是否正确。
   - 确认失败记录生成部分是否只包含失败行，并标注正确的错误信息。
4. **重复记录处理**
   - 在部分更新逻辑中验证，对于相同“教育ID号”的记录，已有字段不被覆盖，而空字段可更新。
   - 在测试时，可以准备一份包含重复“教育ID号”的数据进行验证。

### 3.2 工具与调试

- **开发工具**
  - 编辑器：Visual Studio Code
  - 终端：PowerShell 或 VSCode 内置终端
  - 版本管理：建议使用 Git（在改动前请先 commit 已通过测试的版本）
- **日志调试**
  - 在关键步骤（例如文件上传、解析、校验、数据库写入、生成失败记录表）添加 `current_app.logger.debug()` 语句，输出变量值和状态。
  - 使用 Flask 内置日志记录，将日志写入文件（如 app.log）便于排查问题。
- **浏览器开发者工具**
  - Network 面板：检查上传请求的状态码、响应体内容。
  - Console 面板：查看前端 JavaScript 错误、调试输出。

## 4. 注意事项

1. **代码修改建议**
   - 若对 import_api.py 进行大幅修改，请先备份原始代码（例如通过 Git 提交），以便回退到已知正常版本。
   - 不要修改数据库模型（Student）和蓝图注册等关键部分，除非有必要。
   - 前端 data_import.html 与后端 import_api.py 必须匹配，URL 生成要确保正确。
2. **页面与组件的关系**
   - data_import.html 作为独立页面，继承了 base.html，其中已经包含顶部导航栏和侧边栏组件。修改上传逻辑时，只需修改 data_import.html 中的 JS 部分以及 import_api.py 后端接口代码，不影响其他组件。
   - 保持各组件（如 topnav、sidebar）独立封装，尽量不要在数据导入逻辑中涉及它们的代码。
3. **错误统计逻辑**
   - 当前错误统计基于每个失败行（即使一行有多个错误，只计一次失败），请确保在代码中使用集合（例如 failed_rows）记录行号，而不是简单累加错误信息数量。
4. **失败记录表生成**
   - 失败记录表只导出失败的行数据，并在“错误信息”列标红。确保用 XlsxWriter 写入 Excel 文件后，通过 url_for 提供下载链接。

## 5. 后续扩展方向

- **自定义校验规则**：可扩展更多字段的格式和范围校验规则（例如联系电话、身份证格式）。
- **用户配置映射**：如果未来字段发生变化，可考虑实现用户自定义字段映射界面，而不是写死在代码中。
- **性能优化**：对于大批量数据导入，可考虑分批提交数据库、使用异步任务队列等方式。

------

这份文档总结了当前数据导入功能的开发情况、主要代码模块、调试工具及开发步骤。修改时请特别注意保持已经验证正常的部分不变，且建议在大幅修改前备份原代码（如通过 Git 提交）。

请确认是否有其他疑问或需要进一步详细说明的部分。