关于多层表头的需求，我要再次明确一下细节： 1、报表的第1列，永远是分组的信息，第1列表头不分层，要根据中间部分动态表头的层数，决定跨几行。第1 列表头的名称分两种情况： A.如果只选择一个数据字段为分组，则分组数据字段的中文名称就是第1 列的表头名称 B.如果选择了多个字段作为分组，则默认为第1 列的表头为“分组”两个字 ***举例： ###如果选择“性别”字段作为分组，并且勾选了二级选项“男”和“女”，则表头名称就是“性别”，“男”和“女”就是两个统计维度。 ###不论选择了几个分组条件，只要在下拉框里选择的分组字段名是同一个字段，就视为选择一个字段，比如分三次选择“年龄”为分组，，每次设定一个年龄段或者具体的年龄，此时第1列的明天依然是“年龄”，具体选择的年龄段或者年龄数，就分别是不同的统计维度 ###如果选择了多个不同的数据字段作为分组，比如先后选择“拔罐”、“针灸”、“热敷”为分组条件，这三个条件对应三个统计维度，每个维度一行数据，此时第1列的表头就是默认的“分组” 2、最后一列永远是“统计总数”，最后一列表头也永远不分层，要根据中间部分动态表头的层数，决定跨几行。 3、中间部分的表头，要根据“统计指标”动态生成。分为以下几种情况： C.无论用户选择几个数据字段作为“统计指标”报表第一层永远都是被选做统计指标的数据字段的中文名称，比如可以只选择“视力等级”为统计指标，第一层表名称就是“视力等级”，也可能选择“视力等级”和“干预后视力等级”两个字段同时做统计指标，那么第一层表头的名称就是“视力等级”和“干预后视力等”两个字段名称按照选择的先后顺序并列 D.如果用户选择作为“统计指标”是数据字段有二级选项，那么该二级选项的名称，或者数值或数值范围就是第二层表头，如果没有二级选项，这一层就不存在 E.最下一层表头，永远是“数量”和“占比”两列，对应每一个统计指标字段的二级选项或直接对应每一个统计指标字段（没有二级选项的情况） ##### 以上对需求的描述是否清楚？请明确的表述一遍你的理解，不要错过任何细节



Reasoned for 18 seconds推理了18秒

I need to summarize the requirements for the multi-layer table header. It says the first column is always for group information, and its header is not layered. The header name depends on the grouping fields. If only one field is chosen, the header uses the Chinese name of the field. If multiple fields are chosen, the header is labeled "分组" (Group). There are also subcases for different scenarios outlining how to handle the dynamic header layers in the middle.我需要总结一下多层表头的要求。上面说第一列总是用于分组信息，并且其表头不分层。表头名称取决于分组字段。如果只选择一个字段，则表头使用字段的中文名称。如果选择多个字段，则表头标记为“分组”（组）。还有针对不同场景的子案例，概述了如何处理中间的动态表头层。

My understanding is:我的理解是：

- The first column header name changes based on grouping fields.第一列标题名称根据分组字段而变化。
  - If "性别" is the group field and "男" and "女" are options, the first column header is "性别".如果“性别”为组字段，“男”和“女”为选项，则第一列标题为“性别”。
  - Multiple grouping fields lead to "分组" in the first column header.多个分组字段导致第一个列标题为“分组”。
  - If grouping uses the same field, the first column retains that field's name.如果分组使用相同的字段，则第一列保留该字段的名称。

- The last column is "统计总数" (Total Count), covering multiple rows.最后一列是“统计总数”（Total Count），涵盖多行。

- The middle part is dynamically generated with statistical indicators, with Chinese names in the first row. Secondary options, if any, show in the second.中间部分是动态生成的统计指标，第一行是中文名称，如果有次要选项则显示在第二行。

- The bottom row is always "数量" (Quantity) and "占比" (Proportion).



以下是我对多层表头需求的完整理解，包含所有细节：

1. **第一列（分组列）的要求：**
   - 第一列永远用于显示分组信息，其表头不参与多层结构，而是根据中间部分动态表头的层数，设置跨行数。
   - 第一列的名称分两种情况：
      A. 如果用户只选择了一个数据字段作为分组，则第一列的表头名称就是该分组字段的中文名称（例如只选“性别”，则表头显示“性别”）。
      B. 如果用户选择了多个不同的数据字段作为分组，则统一显示为“分组”。
   - 补充说明：
     - 如果用户多次选择相同的分组字段（例如分三次选择“年龄”，每次设定不同的年龄段或具体年龄），则视为只选择了一个分组字段，此时第一列的表头名称仍为“年龄”，但各行显示的分组值（年龄段或具体年龄）可能不同。
     - 如果用户选择了多个不同字段（例如先选择“拔罐”，后选择“针灸”，再选择“热敷”），则第一列的表头统一显示为“分组”，而具体的分组值分别为“拔罐”、“针灸”、“热敷”。
2. **最后一列（统计总数）的要求：**
   - 最后一列固定显示“统计总数”，其表头也不分层。
   - 同样，根据中间部分的动态表头层数，最后一列需要跨相应的行数，以保持与中间部分表头对齐。
3. **中间部分（统计指标部分）的要求：**
   - 第一层表头（统计指标字段名称）：
     - 无论用户选择几个数据字段作为统计指标，第一层表头永远显示被选为统计指标的数据字段的中文名称。例如，如果只选“视力等级”，第一层只显示“视力等级”；如果同时选“视力等级”和“干预后视力等级”，则第一层依照选择顺序并列显示这两个字段名称。
   - 第二层表头（统计指标的二级选项）：
     - 如果某个统计指标字段支持二级选项（例如细分的类别、数值范围等），那么这些二级选项的名称将构成第二层表头；
     - 如果统计指标字段没有二级选项，则这一层不生成（即直接跳过）。
   - 第三层表头（固定“数量”和“占比”）：
     - 最下层的表头永远为“数量”和“占比”，对应每一个统计指标字段的每个二级选项；
     - 如果没有二级选项，则直接为每个统计指标字段生成两列：“数量”和“占比”。

总结来说：

- 第一列为分组信息，表头名称根据选择的分组字段情况确定（单一字段时显示字段中文名；多字段时统一显示“分组”），且不参与层次划分，跨行数与中间部分相同。
- 中间部分的表头根据统计指标构成，第一层显示统计指标字段名称；若有二级选项，则第二层显示选项名称，第三层统一显示“数量”和“占比”。
- 最后一列固定为“统计总数”，同样不分层，跨行数与中间部分一致。

请确认以上理解是否满足需求描述。

以上理解满足需求的描述，下面用文字描述一下实现的逻辑

下面是实现多层表头的逻辑说明：

1. **确定表头结构**

   - 首先，根据用户在查询中选择的“分组”和“统计指标”来确定整个表头的层级。
   - 对于分组列：
     - 程序会先检查所有被设为分组的条件。
     - 如果所有分组条件中，用户选择的分组字段都是同一个（例如多次选择“年龄”），则第一列的表头名称就是该字段的中文名称（例如“年龄”）；
     - 如果分组条件中包含多个不同字段，则统一显示“分组”。
   - 对于统计指标部分：
     - 统计指标的第一层始终显示用户选择的每个统计指标字段的中文名称，按选择顺序依次并列。
     - 接下来判断每个统计指标是否有二级选项（例如用户是否进一步选择了具体的细分类别、数值范围或其他选项）：
       - 如果有，则中间部分的表头结构为三层；
       - 如果没有，则直接生成两层结构，第一层为统计指标名称，第二层直接显示“数量”与“占比”。

2. **构建各层表头单元格**

   - 第一列（分组列）

     ：

     - 生成一个单元格，其内容为分组列的名称。
     - 该单元格不参与层次拆分，而是直接根据中间部分的层数确定它需要跨越的行数（例如如果中间部分为三层，则该单元格设置 rowspan=3；如果是两层，则 rowspan=2）。

   - 统计指标部分

     ：

     - 对于每个统计指标字段：
       - 在第一行中生成一个单元格，内容为该指标的中文名称。
       - 如果该指标存在二级选项，则该单元格的 colspan 设置为（二级选项数量 × 2），因为每个二级选项在最下层会对应“数量”和“占比”两个单元格。
       - 如果该指标没有二级选项，则直接设置 colspan=2；此时整个统计指标部分只需要两层表头。
     - 如果采用三层表头结构：
       - 第二层为每个具有二级选项的统计指标：对其每个二级选项生成一个单元格，内容为选项名称，单元格 colspan=2；
       - 第三层则对每个二级选项生成两个固定单元格，一个显示“数量”，一个显示“占比”。
     - 如果采用两层表头结构：
       - 第一层已经显示了统计指标字段名称，每个单元格的 colspan=2；
       - 第二层直接为每个统计指标字段生成两个单元格，分别显示“数量”和“占比”。

   - 最后一列（统计总数）

     ：

     - 生成一个单元格，其内容固定为“统计总数”，同样不分层，跨行数与中间部分一致（即 rowspan=2 或 rowspan=3）。

3. **动态判断层数**

   - 实现时需要在生成表头之前，对用户选择的统计指标数据结构进行预处理，检查每个指标是否包含二级选项：
     - 如果至少有一个指标包含二级选项，则整体采用三层表头结构；
     - 如果所有指标均无二级选项，则采用两层结构。
   - 根据这个判断结果，计算第一列和最后一列所需的 rowspan 值，以及后续统计指标单元格的 colspan 值。

4. **错误检查与适配**

   - 在生成表头之前，对后端返回或前端收集的 header 数据进行校验，确保所有单元格对象中至少包含必需的 `text` 属性；
   - 对于可能缺失的 colspan 或 rowspan 信息，可以根据整体层数自动补全默认值，保证表头各行能够正确合并单元格，不会出现错位或空单元格。

5. **整合到页面生成流程中**

   - 在 report.js 中，会先根据接口返回的数据或前端组合查询结果，构造出标准化的 header 数据结构，然后调用一个专门负责生成 HTML 表头的函数，该函数遍历标准化的 header 数据生成对应的 `<tr>` 和 `<th>` 标签；
   - 与此同时，表体的数据行生成逻辑应确保每一行的数据列数与表头列数完全对应，从而使整个报表的展示保持对齐。

这种实现逻辑确保：

- 第一列和最后一列始终保持固定不变，而中间部分的表头能够根据用户选择的统计指标和子选项动态调整层数和列宽；
- 不论用户选择单一或多个统计指标、是否包含二级选项，都能生成一个结构清晰、层次明确的报表表头，方便后续数据展示与交互处理。

请确认这一实现逻辑说明是否清晰和完整，我们可继续讨论下一步具体实现步骤。



以上逻辑很清楚，我还要继续补充一下需求的细节： 1、多次选择同一个数据字段作为统计指标，每次给定一个数值或者数值区间，此时视为只有一个统计指标名称。比如分三次选择“左眼裸眼视力”为统计指标，每次填写一个数值区间，此时，作为统计指标的数据字段名称就是“左眼裸眼视力”，而分别输入的三个数值区间，就是三个二级选项（直接用数值区间显示，比如“0-5”）。多个字段作为统计指标时的情况同样处理 以上补充说明是否清晰



以上补充说明很清楚。我的理解如下：

- 如果用户多次选择同一数据字段（例如“左眼裸眼视力”）作为统计指标，每次都提供一个具体的数值或数值区间，则在报表中，该统计指标的第一层表头仍统一显示“左眼裸眼视力”。
- 而用户每次输入的数值或数值区间，将作为该统计指标的二级选项显示（例如“0-5”、“5-10”等），并在最下层为每个选项分别生成“数量”和“占比”两列。
- 对于多个不同字段作为统计指标的情况，同样采用这种处理方式，即每个字段在第一层显示其中文名称，后续二级选项依据用户多次选择时填写的数值或数值区间生成。

请确认这是否符合您的需求。



以上描述符合我的需求，你加上补充需求说明后再完整的描述一下具体的实现逻辑和步骤

下面是结合前面需求和补充说明后，多层表头的完整实现逻辑和步骤说明：

------

### 1. 总体目标

构建一个报表表头，其中：

- 第一列始终用于显示分组信息，其表头名称根据用户选择的分组情况决定（单一字段时显示该字段中文名称；多个不同字段时统一显示“分组”），且跨越与中间部分相同的行数。
- 最后一列固定为“统计总数”，也不分层，跨行数与中间部分一致。
- 中间部分为统计指标区域，动态生成多层表头：
  - 第一层显示所有被选为统计指标的数据字段名称（若多次选择同一字段，则只显示一次）。
  - 第二层显示每个统计指标对应的二级选项：
    - 如果某个统计指标只被选择一次且没有额外的二级选项，则直接采用“数量”和“占比”两列作为第二层；
    - 如果同一统计指标多次选择（例如多次输入“左眼裸眼视力”的数值或数值区间），则把每次输入的数值或区间视为一个二级选项，显示该数值或区间（例如“0-5”）作为二级表头。
  - 最下一层（无论是否有第二层）始终为每个二级选项生成两列：“数量”和“占比”。

------

### 2. 具体实现逻辑

#### 2.1 数据预处理

- **统计指标数据结构**
   在生成表头前，需要收集用户选择的所有统计指标信息，这部分信息包含：
  - 每个被选为统计指标的数据字段（例如“左眼裸眼视力”、“视力等级”、“干预后视力等级”等）。
  - 对于每个统计指标，用户可能多次选择，且每次输入一个具体数值或数值区间。
  - 预处理时将同一数据字段的多次选择归为同一统计指标，并将每次输入的数值或数值区间作为该指标的二级选项列表。
  - 最终生成一个标准化的数据结构，每个统计指标对象至少包含：
    - `field`：数据字段的英文标识（对应后端字段），
    - `label`：数据字段的中文名称（如“左眼裸眼视力”），
    - `selected`：数组，包含所有用户输入的数值或区间，例如 `["0-5", "5-10", "10-15"]`。
- **分组字段和最后一列**
  - 分组字段部分提前确定：
    - 如果所有分组条件都选自同一个字段（例如多次选择“年龄”），则第一列表头名称为该字段的中文名称；
    - 如果分组条件来自多个不同字段，则统一显示为“分组”。
  - 最后一列固定显示“统计总数”。

#### 2.2 动态判断表头层级

- 确定中间部分表头层数：

  - 如果所有统计指标都没有二级选项（即每个指标只选择一次或用户未填写数值/区间），则整个统计指标部分只需两层表头：

    - 第一层为统计指标名称，
    - 第二层直接为每个统计指标生成“数量”和“占比”两列。

  - 如果至少有一个统计指标存在多次选择（即其 

    ```
    selected
    ```

     数组中有多个值），则采用三层结构：

    - 第一层为统计指标名称（每个单元格的 colspan 为该指标所选二级选项数量×2），
    - 第二层为每个统计指标下每个二级选项的名称（直接显示数值或区间，如“0-5”、“5-10”等，每个单元格 colspan 2），
    - 第三层为每个二级选项生成两个固定单元格：“数量”与“占比”。

#### 2.3 构建各层表头单元格

- **第一列（分组列）：**
  - 生成一个单元格，其内容为分组列的名称（依据上面规则确定是具体字段名称或“分组”），
  - 设置 rowspan 等于中间部分表头的层数（例如2或3）。
- **统计指标区域：**
   对于每个统计指标：
  - 第一层：
    - 为每个统计指标生成一个单元格，内容为该指标的中文名称，
    - 设置 colspan：
      - 如果采用两层结构，则 colspan 固定为2；
      - 如果采用三层结构，则 colspan 为该指标二级选项数量乘以2。
  - 第二层（如果需要）：
    - 如果当前统计指标存在二级选项（即 `selected` 数组长度大于1或大于0且认为需要二级显示），则遍历该数组，为每个选项生成一个单元格，内容为该选项（例如直接显示输入的数值或数值区间），并设置 colspan=2。
    - 如果该指标没有二级选项（或者用户仅选择一次），则可以跳过此层。
  - 最下层（数量与占比）：
    - 对于每个统计指标中每个二级选项（或直接对应统计指标，没有二级选项时也视为单个选项），为其生成两个固定单元格，分别填入“数量”和“占比”。
- **最后一列（统计总数）：**
  - 生成一个单元格，内容固定为“统计总数”，
  - 设置 rowspan 等于中间部分表头的层数（与第一列一致）。

#### 2.4 生成 HTML 表头

- 根据上述预处理后的标准化表头数据结构，遍历每一层的数组，生成对应的 `<tr>` 标签；
- 对每个单元格（对象）生成 `<th>` 标签，并设置其 `colspan` 和 `rowspan` 属性；
- 确保在生成时校验数据完整性，如缺少 `text` 的单元格给出默认值或提示。

#### 2.5 数据行与表头对齐

- 确保数据行的列数严格与表头生成的总列数一致。
- 后续在渲染数据行时，依据统计指标和各选项顺序逐列填入相应的“数量”和“占比”，以及分组信息和统计总数。

#### 2.6 错误处理和边界情况

- 在构建表头前对用户选择的统计指标、分组条件进行校验；
- 如果统计指标部分为空或返回数据格式异常，给予默认的表头显示或错误提示；
- 处理特殊情况：
  - 当同一指标的二级选项数量为0时，直接采用两层结构；
  - 当分组字段缺失时（理论上不应该发生），也给予友好提示。

------

### 3. 实现步骤总结

1. **数据收集与预处理：**
   - 收集用户的分组条件和统计指标选择，特别注意同一字段被多次选择时，将多次输入合并为同一统计指标，并将每次的数值或区间作为二级选项存入一个数组。
2. **动态判断表头层级：**
   - 根据各统计指标中二级选项的数量，判断整个统计指标部分是生成两层还是三层表头，进而确定第一列和最后一列的 rowspan。
3. **构建标准化表头数据结构：**
   - 对每一层（分组列、统计指标的第一层、可能的第二层以及最下层）构建一个包含 `text`、`colspan`、`rowspan` 的对象数组。
4. **生成 HTML 表头：**
   - 遍历标准化数据结构，生成对应的 `<tr>` 和 `<th>` 标签，并设置好 colspan 与 rowspan。
5. **确保数据行对齐：**
   - 与后续数据行生成逻辑保持一致，保证表头列数和数据列数匹配。
6. **添加错误处理和边界检测：**
   - 在各步骤中加入必要的校验逻辑，确保用户输入异常或返回数据格式异常时能给予默认处理或错误提示。

------

以上即为结合补充需求后的多层表头实现逻辑和具体步骤说明，请确认是否满足要求。

、在统计查询时，必须至少选择一个数据字段作为“分组”，同时必须至少选择一个数据字段作为“统计指标”，如果不满足这个条件，就要弹出文字提示“请选择统计指标或分组” 2、如果选择作为“统计指标”或“分组”的数据字段是有二级选项或有数值输入要求的，用户至少需要选择其中的一个二级选项，或者至少填写一个数值，或者至少输入一个文本字符串，否则就要弹出提示“请选择二级选项或填写数值或文本”， 以上补充是否清晰



##### 

Reasoned for 4 seconds合理4秒

补充说明非常清晰。我的理解如下：

1. 在统计查询中，用户必须至少选择一个数据字段作为“分组”，同时至少选择一个数据字段作为“统计指标”。如果任一条件未满足，则需要弹出提示“请选择统计指标或分组”。
2. 对于作为“统计指标”或“分组”的数据字段，如果这些字段支持二级选项或者需要用户输入数值或文本，则要求用户至少在该字段下选择一个二级选项、填写一个数值或输入文本内容，否则弹出提示“请选择二级选项或填写数值或文本”。

这种要求确保了在统计查询时，既有明确的分组依据，也有具体的统计指标和进一步的细分条件，从而保证统计计算有足够的维度和数据支持。

以下是我逐行检查统计报表 report 页面相关代码后（包括 report.html、report.js、以及后端 analysis_api 中与报表表头构建相关的逻辑）的检查结果和总结，然后给出下一步完善代码的方案，供您确认：

------

### 一、检查结果

1. **前端页面 report.html：**
   - 实现情况：
     - 页面继承自基础模板，整体布局（查询区域、表格区域、分页和按钮）已搭建；
     - 包含了用于选择模板、统计时间、报表名称、查询模式等的控件；
     - 包含“保存模板”、“添加条件”、“取消”、“查询”、“导出报表”、“查看图表”等按钮。
   - 存在问题：
     - 部分按钮（如“保存模板”、“导出报表”）没有绑定对应的事件处理逻辑；
     - 对于报表表头的展示，页面依赖后端返回的 header 数据，未在前端进行进一步的校验和动态调整（例如针对多次选择同一指标的情况未作特殊处理）。
2. **前端逻辑 report.js：**
   - 实现情况：
     - 实现了获取查询参数、调用 /api/analysis/report 接口、渲染报表表头、数据行和分页的基本逻辑；
     - 能够根据接口返回的数据构造表头（通过遍历 data.header）和表体。
   - 存在问题：
     - 没有在调用查询前对必选条件进行验证，即：必须至少选择一个分组和一个统计指标；
     - 在收集高级查询条件（advanced_conditions）时，缺少对每个字段是否至少有二级选项或输入值的验证，可能导致接口接收不完整或错误的参数；
     - 表头生成逻辑依赖后端返回的 header 数据，未在前端根据最新需求（如同一指标多次选择的情况）进行动态调整，可能出现跨行/跨列计算不准确的问题；
     - 分页和数据错误处理部分简单提示，缺少更友好的用户反馈和异常捕获。
3. **后端接口 analysis_api.py（统计报表接口及表头构造部分）：**
   - 实现情况：
     - 已实现基本的统计报表数据构造，包含对固定模板和自定义查询的处理；
     - 包含一个函数（build_multi_level_header）用于构造多层表头数据结构，支持第一层（统计指标名称）、第二层（统计指标的二级选项）和第三层（数量/占比），同时考虑了分组列和统计总数列。
   - 存在问题：
     - 参数验证不足：没有强制检查是否至少选择了一个分组字段和一个统计指标；
     - 对于作为统计指标的字段，如果支持二级选项或数值输入，未强制验证用户至少提供一个有效的二级选项、数值或文本；
     - 对多次选择同一指标的情况，虽然有逻辑合并成同一统计指标，但需要确认返回的 header 数据结构是否完全满足最新需求（例如第一层只显示一次字段名称，二级选项中显示各个数值区间）。
     - 部分异常处理较简单，未返回详细错误信息给前端，导致联调时难以定位问题。

------

### 二、下一步完善代码的方案与任务分类

基于以上检查结果，我们的优化和完善任务可分为以下几类，且需保证不破坏原有功能：

#### 1. 参数验证与错误提示

- 任务 1.1（前后端统一验证）：
  - 在前端（report.js）的查询调用前，加入验证逻辑：
    - 检查是否至少选择了一个分组字段和一个统计指标；
    - 对于每个选择为统计指标或分组的字段，如果支持二级选项或需要数值/文本输入，则验证至少有一项有效输入；
    - 如果验证不通过，弹出提示“请选择统计指标或分组”或“请选择二级选项或填写数值或文本”。
  - 在后端（analysis_api.py）的接口中，同步添加参数校验，返回明确错误信息给前端。

#### 2. 多层表头动态构建优化

- 任务 2.1（标准化表头数据结构）：
  - 对统计指标部分，预处理用户选择的数据，将同一字段多次选择合并，只显示一次字段名称，并将各次输入作为二级选项保存到同一数组；
  - 根据统计指标的二级选项数量，动态判断整体表头采用两层还是三层结构。
- 任务 2.2（表头 HTML 生成优化）：
  - 修改 report.js 中生成表头的函数（renderReportHeader），以便根据标准化的表头数据结构自动设置第一列（分组列）和最后一列（统计总数）的 rowspan，并为中间部分正确设置各单元格的 colspan 与 rowspan；
  - 增加对 header 数据的完整性校验，确保每个单元格对象有 text、colspan、rowspan 信息，如果缺失则自动补全默认值。

#### 3. 交互功能完善

- 任务 3.1（绑定导出与模板保存事件）：
  - 在 report.js 中，为“导出报表”按钮添加事件绑定，调用后端导出接口并实现下载；
  - 同时，为“保存模板”按钮绑定事件，保存当前查询条件，后续实现模板管理。
- 任务 3.2（排序功能完善）：
  - 如果有排序需求，在报表表头中加入点击排序的事件（目前可暂缓，如果当前需求中排序并非关键）。

#### 4. 代码结构与异常处理

- **任务 4.1（模块化重构）：**
  - 将 report.js 中长函数拆分为独立的子函数，如参数收集、表头生成、数据行渲染和分页生成各自独立；
  - 加强对 DOM 元素获取和数据类型转换的异常捕获，确保在意外情况时不会造成页面崩溃，并显示友好提示。
- **任务 4.2（日志与错误信息增强）：**
  - 后端接口中增强日志记录，确保在参数解析或统计计算异常时记录详细信息，并返回明确错误提示给前端，便于联调调试。

------

### 三、任务优先顺序

1. **参数验证（任务 1.1）：**
   - 优先在前后端增加必要的验证逻辑，确保统计查询时至少有一个分组和一个统计指标，同时每个支持二级选项的字段有至少一项有效输入。
2. **多层表头构建优化（任务 2.1 和 2.2）：**
   - 在确保参数正确后，集中优化表头数据结构的标准化和前端 HTML 生成，确保分组列、统计指标部分以及统计总数列均能根据选择动态生成正确的跨行/跨列设置。
3. **交互功能完善（任务 3.1）：**
   - 同步实现导出报表和保存模板按钮的事件处理，确保用户可以导出统计结果和保存查询模板。
4. **代码结构重构和异常处理（任务 4.1 与 4.2）：**
   - 在上述功能稳定后，对 report.js 及相关模块代码进行拆分和重构，增强健壮性和可维护性，同时完善日志和错误反馈。

------

请您确认以上检查结果和下一步完善方案是否符合要求，我将在获得确认后，再输出相应的修改代码。

下面是根据“参数验证”任务要求，对前端 report.js 与后端 analysis_api.py 中统计报表接口部分增加参数校验逻辑的修改方案说明，附带详细注释。请确认后再进行代码更新。

------

### 前端（report.js）的修改说明

1. 新增验证函数

   - 定义一个 

     ```
     validateReportParams()
     ```

      函数，用于在点击“查询”前对必选项进行检查：

     - 如果查询模式为预设模板（template），则要求“模板”下拉框有选中值；
     - 如果查询模式为自定义（custom），则要求隐藏的组合查询条件输入框（comboConditions）中至少包含一个角色为 "group" 或 "metric" 的条件，并且这些条件的 value 不为空（即必须填写二级选项、数值或文本）。

2. 修改查询按钮事件

   - 在“查询”按钮的点击事件中，先调用验证函数；如果验证失败，则弹出相应提示并阻止查询接口的调用。

------

### 后端（analysis_api.py）的修改说明

1. **增加参数校验逻辑**
   - 在统计报表接口（analysis_report）中，当查询模式为 “custom” 时，解析 advanced_conditions 参数后，检查是否至少存在一个角色为 "group" 或 "metric" 的条件；
   - 对于每个条件，若其 value 为空（包括空字符串），则直接返回错误提示 “请选择二级选项或填写数值或文本”；
   - 如果没有找到任何统计指标或分组条件，则返回错误提示 “请选择统计指标或分组”。
2. **确保前后端验证一致**
   - 这样既能在前端及时提醒用户，也能在后端进一步校验，防止错误参数进入统计逻辑中。

------

接下来，我将输出修改后的代码，供您确认。