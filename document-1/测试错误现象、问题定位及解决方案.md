#### 测试错误现象、问题定位及解决方案

1、这个错误说明在构造 case 表达式时，传入的 “whens” 参数格式不符合 SQLAlchemy 最新版本的要求，而不是完全因为前端参数传递不正确。具体来说，在统计指标聚合表达式中，我们使用了类似下面的写法：

```
python


Copy
case([(get_column_by_field(field) == val, 1)], else_=0)
```

而 SQLAlchemy 新版本要求传入的 when 条件必须是作为位置参数传递，而不是放在一个列表中，即应该写成：

```
python


Copy
case((get_column_by_field(field) == val, 1), else_=0)
```



下面是对自定义查询分组条件问题的详细说明和原因分析，包括选择多个没有二级选项的字段作为分组的情况：

------

### 问题说明

1. **只返回部分选项问题**
    用户在自定义查询中选择了某个字段作为分组条件（例如“年级”），并在该字段的选项中只勾选了部分值（例如只选择“一年级”和“二年级”），但最终查询结果中却显示了该字段所有可能的取值，而不是仅显示用户勾选的那部分。
2. **排序无规则问题**
    返回的分组数据顺序不固定，与用户预期的自然排序（例如按照年级从低到高）不符。
3. **多个没有二级选项的字段作为分组的情况**
    当用户选择多个没有二级选项的字段作为分组时，每个字段都应独立作为一个统计维度，并各自生成一行数据；但目前系统只取了高级查询条件中第一个分组字段进行分组，导致其他字段未被正确过滤或显示，最终报表中混合显示了所有该字段的所有取值。

------

### 原因分析

1. **过滤条件缺失**
   - 在解析高级查询条件时，代码仅将用户选中的分组字段保存为分组依据（例如将第一个分组字段赋值给变量 `grouping_expr`），但没有将用户实际勾选的具体分组值（例如“一年级”、“二年级”）作为过滤条件添加到数据库查询中。
   - 这样就导致数据库返回该字段所有不同的取值，而不只是用户所选的部分。
2. **排序缺失**
   - 查询构造过程中没有显式加入 `ORDER BY` 子句，分组结果的顺序就完全依赖于数据库默认排序顺序，通常并不是用户预期的自然排序。
3. **多个无二级选项的分组字段处理不当**
   - 当前代码逻辑仅使用高级查询条件中第一个分组字段作为主要分组依据，忽略了其他用户选择作为分组的字段。
   - 如果用户同时选择了多个没有二级选项的字段（例如既选择了“性别”也选择了“区域”作为分组），系统应对每个字段单独生成统计数据或通过联合查询返回多个分组维度，而目前未能做到这一点，导致返回结果混杂所有取值，且无法区分来自不同分组字段的数据。

------

### 小结

- **主要问题在于：**
  - 用户选择的具体分组值未被转换为有效的过滤条件，因此查询返回了该字段所有不同取值。
  - 分组结果未经过排序处理，导致返回顺序无规则。
  - 当多个没有二级选项的字段同时作为分组条件时，系统没有分别处理这些字段的过滤和统计，导致报表数据混乱。
- **解决方案思路：**
  - 在解析高级查询条件时，除了提取分组字段之外，还要将用户勾选的具体分组值（例如“一年级”和“二年级”）作为过滤条件加入到查询中。
  - 在构造分组查询时，对分组结果增加排序（如使用 ORDER BY grouping_expr），确保输出顺序符合预期。
  - 对于多个没有二级选项的分组字段，要采用联合查询或者分开统计，确保每个分组字段都能独立生成对应的统计数据，并在报表中以“分组”作为统一的第一列标题展示每个字段的结果。

请确认以上问题描述和原因分析是否满足您的要求。y