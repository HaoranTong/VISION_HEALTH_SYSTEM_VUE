下面是结合之前的需求说明和最新补充修正的完整、结构化的统计报表页面需求说明，请仔细确认：

------

## 统计报表页面完整需求说明

### 1. 查询模式与参数要求

1.1 **查询模式**

- 预设模板模式
  - 用户从下拉框中选择固定模板（如“按年龄段”、“按性别”），系统根据模板自动构造预设的分组条件和统计逻辑。
- 自定义查询模式
  - 用户通过组合查询模块自由选择数据字段设置条件，条件分为以下三种角色：
    - **分组条件（Group）**：决定报表行的分组依据。
    - **统计指标（Metric）**：决定需要统计的数据，每个统计指标将在报表中生成“数量”和“占比”两个数据列。
    - **过滤条件（Filter）**：用于进一步限制查询范围，影响最终统计结果，但不直接参与分组或统计。

1.2 **必选项验证**

- 无论采用哪种查询模式，必须满足：
  - 至少选择一个数据字段作为“分组”。
  - 至少选择一个数据字段作为“统计指标”。
- 对于任何被用作“统计指标”或“分组”的字段（无论该字段是否支持二级选项），如果字段支持二级选项或需要输入数值/文本，则用户必须至少填写一个有效的二级选项或输入内容；
  - 否则，系统应弹出提示“请选择二级选项或填写数值或文本”，而不是直接返回 400 错误。

1.3 **所有字段的灵活使用**

- “选择字段”下拉框中列出的所有数据字段，都可以被同时用作：
  - 分组条件
  - 统计指标
  - 过滤条件

------

### 2. 分组条件的处理

2.1 **分组条件来源**

- 用户可任意选择一个或多个字段作为分组条件。
- 情况说明：
  - 同一字段多次选择
    - 如用户多次选择“年龄”作为分组条件（每次输入一个区间或具体数值），则视为只选择了一个分组字段，“年龄”作为第一列的表头名称不变，但不同的输入（区间或数值）将作为不同分组标签显示在数据行中。
  - 多个不同字段
    - 如果用户选择了多个不同字段（例如先选择“拔罐”，后选择“针灸”），则第一列的表头统一显示为“分组”，而每一行的分组标签分别为各个字段对应的输入值或选项。

2.2 **数值型字段的分组处理**

- 对于数值型字段（如“年龄”、“身高”、“体重”等）：
  - 区间条件
    - 当用户同时输入最小值和最大值时，视为一个区间条件，统计该区间内的记录。
    - 支持用户输入多个区间，每个区间独立生成一个分组。
    - 区间标签应按照用户输入格式生成：若数值为整数，则显示整数；若为浮点数，则显示浮点数。
  - 单一数值条件
    - 当用户只输入单一数值（例如只填写最小值或只填写最大值），视为单一条件。
    - 同一字段允许输入多个单一数值，每个单一值分别作为一个分组。
  - 输入验证
    - 如果对数值字段既未输入具体数值也未选择其他选项，则弹出提示：“请输入具体数值或选择选项”。

------

### 3. 统计指标的处理

3.1 **统计指标选择**

- 用户可以从所有数据字段中任意选择一个或多个作为统计指标。
- 每个被选为统计指标的字段都可以支持二级选项：
  - 如果用户对某一指标多次选择（例如多次选择“左眼裸眼视力”，每次输入不同的数值或区间），则视为同一统计指标，多次输入的结果合并为该指标的二级选项。
  - 如果统计指标只被选择一次或没有额外输入，则直接生成两列：数量与占比。

3.2 **二级选项要求**

- 对于支持二级选项或需要用户输入具体内容的统计指标字段，必须保证至少有一项有效输入；否则，系统应提示“请选择二级选项或填写数值或文本”。

3.3 **多个统计指标**

- 允许用户同时选择多个不同的数据字段作为统计指标。
- 在报表表头中，这些统计指标按照用户选择的顺序从左到右排列，第一层表头显示各统计指标的中文名称。

------

### 4. 报表表头结构设计

4.1 **第一列（分组列）**

- 第一列始终用于显示分组信息，其表头不分层。
- 表头名称规则：
  - 若所有分组条件均来自同一字段，则第一列表头使用该字段的中文名称（例如“年龄”或“性别”）。
  - 若分组条件来自多个不同字段，则统一显示“分组”。
- 该单元格的 rowspan 值应与中间部分表头层数一致（例如 2 层或 3 层）。

4.2 **中间部分（统计指标区域）**

- 第一层表头
  - 显示所有被选为统计指标的数据字段的中文名称，顺序按用户选择顺序排列。
  - 如果同一字段被多次选择，只显示一次。
- 第二层表头
  - 对于支持二级选项的统计指标字段（例如用户多次输入不同的数值或区间），第二层显示每个输入值或区间的标签。
  - 如果某统计指标没有二级选项，则此层不生成，该统计指标直接在最下一层生成两列。
- 最下层表头
  - 对每个统计指标的每个二级选项（或单次选择的统计指标），生成两列，分别固定为“数量”和“占比”。

4.3 **最后一列（统计总数）**

- 固定生成一列，表头显示“统计总数”，不参与分层，且 rowspan 与第一列一致。

------

### 5. 数据行与合计行

5.1 **数据行**

- 每行数据：
  - 第一列为分组标签（由分组条件构造，例如单一值、数值区间、或文本）。
  - 中间部分依次为每个统计指标各二级选项对应的数量和占比。
  - 最后一列为该分组的统计总数。

5.2 **合计行**

- 在所有数据行末尾添加“合计”行：
  - 对所有数量进行累加。
  - 对于占比，按相应数量与整体总数计算百分比。
  - 在累加时，将 None 值视为 0。

------

### 6. 排序要求

- 对于数值型分组条件，输出时应按数值大小（升序）排序，或保持用户输入的顺序（如有明确要求，可记录用户输入顺序）。
- 分组标签生成时，若输入为整数则显示整数，若为浮点数则保留小数（满足原始数据格式）。

------

### 7. Excel 导出功能

- 用户可将当前统计报表导出为 Excel 文件。
- 导出的 Excel 文件中须包含完整多层表头、所有数据行及合计行。

------

### 8. 过滤条件显示

- 过滤条件应在报表右上角以较小字号显示，便于用户查看当前统计时所应用的所有筛选条件。

------

### 9. 错误处理与日志记录

- **前端验证**
  - 在提交查询前，前端需要验证必选项是否满足：至少选择一项分组条件和一项统计指标，以及对应的二级选项或输入内容；
  - 如果验证失败，则弹出明确的提示信息，如“请选择统计指标或分组”或“请选择二级选项或填写数值或文本”。
- **后端验证**
  - 后端在解析高级条件时，需对每个条件进行严格校验：
    - 每个条件必须包含非空的 field、operator 和有效的 value；
    - 如果存在问题，返回明确的错误提示信息。
  - 同时增强日志记录，确保异常或错误情况能够快速定位。

------

### 10. 其他要求

- 字段一致性
  - 所有字段名称、类型及选项应与数据字典保持一致。
- 不影响原始数据
  - 所有统计和显示逻辑仅在查询和报表生成过程中进行，不对数据库中原有数据做修改。
- 用户自定义报表名称
  - 报表名称默认显示为“统计报表”，用户可在页面上自行修改报表名称。

------

## 总结

1. 查询模式支持预设模板和自定义查询，要求同时选择分组和统计指标，并对支持二级选项的字段必须填写有效输入。
2. 所有字段都可以同时用作统计指标、分组和筛选，确保灵活性。
3. 分组条件：
   - 如果仅选择同一字段，则第一列表头为该字段中文名称；
   - 如果选择多个不同字段，则统一显示为“分组”。
4. 数值型字段支持区间条件和单一数值条件，且允许多次选择；各分组标签按照输入数值（格式化为整数或浮点数）显示，且排序要求升序或按用户输入顺序排列。
5. 统计指标部分：
   - 第一层显示各统计指标字段名称；
   - 第二层显示该指标的二级选项（如数值区间或具体数值），若不存在则直接生成“数量”和“占比”列；
   - 最下层固定生成“数量”和“占比”列。
6. 报表最后一列固定显示“统计总数”。
7. 过滤条件在报表右上角以较小字号显示。
8. 支持 Excel 导出功能，完整导出多层表头及所有数据行。
9. 前后端都需进行严格的参数验证，并提供明确友好的错误提示和充分的日志记录。

请确认以上需求说明是否完整、准确，或是否需要补充和调整任何部分。这样我们就能在修改代码前确保需求细节完全一致，避免后续反复修改。