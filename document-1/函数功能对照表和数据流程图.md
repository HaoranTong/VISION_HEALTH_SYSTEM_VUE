下面整理了一份详细的**函数功能对照表**和**数据流程图**，描述了整个统计分析模块从前端查询条件收集、统一构造、数据传输、后端查询与聚合、再到前端数据转换展示的全过程。下面的说明可以帮助您清晰地了解各个模块、各个函数之间的信息传递与调用关系，并避免名称或参数错误。

------

## 一、函数功能对照表

| 函数名称                     | 所在文件                         | 功能描述                                                     | 输入参数                                                     | 输出/返回                                                    | 备注                           |
| ---------------------------- | :------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------ |
| **addConditionRow**          | comboQuery_report.js             | 动态添加一行查询条件（包括角色、字段、运算符、值）           | 无（依赖页面 DOM 状态）                                      | 更新 DOM，无返回值                                           | 用于自定义查询条件的录入       |
| **clearConditions**          | comboQuery_report.js             | 清除所有查询条件行                                           | 无                                                           | 更新 DOM，无返回值                                           |                                |
| **getComboConditions**       | comboQuery_report.js             | 遍历所有条件行，返回包含每个条件的 JSON 数组（每个对象含角色、字段、运算符、值） | 从页面 DOM 读取条件信息                                      | JSON 数组，如：`[{role:"metric", field:"age", operator:"=", value:"10-15"}, …]` | 用于构造高级查询条件           |
| **getReportQueryParams**     | report.js / comboQuery_report.js | 收集报表页面中所有查询条件及公共参数，构造统一的 URLSearchParams 对象 | 读取页面中预定义模板或自定义查询输入（如 statTime、reportName、comboConditions 等） | URLSearchParams 对象，如：`query_mode=custom&advanced_conditions=[…]&stat_time=2023` | 统一预设和自定义查询           |
| **getChartQueryParams**      | chart.js                         | 收集图表页面中所有查询条件及公共参数，构造统一的 URLSearchParams 对象 | 读取页面中查询输入（与 getReportQueryParams 类似），附加图表类型参数 | URLSearchParams 对象，如：`query_mode=custom&advanced_conditions=[…]&stat_time=2023&chart_type=bar` | 与报表页面统一构造查询条件     |
| **showFilterConditions**     | chart.js                         | 从查询条件中提取筛选条件（filter 角色）信息，并在页面指定区域显示 | 读取隐藏输入框中的 advanced_conditions、statTime 等          | 更新 DOM 元素（例如 `<div id="filterConditionsInfo">`）显示文本 | 用于在图表页面展示当前筛选条件 |
| **fetchChartData**           | chart.js                         | 发起 AJAX 请求调用后端图表接口，获取统计数据，并调用图表渲染函数 | URLSearchParams 对象（由 getChartQueryParams 得到）          | 无（直接调用 renderChart 渲染图表）                          | 包括加载状态和错误处理         |
| **renderChart**              | chart.js                         | 根据 Chart.js 配置对象将图表渲染到 `<canvas id="analysisChart">` 上 | Chart.js 配置对象                                            | 图表渲染结果（显示在页面）                                   | 调用 Chart.js 库               |
| **getChartOptions**          | chart.js                         | 根据图表类型返回相应的配置选项（如柱状图、饼图、折线图）     | 图表类型（如 "bar", "pie", "line"）                          | Chart.js 配置对象                                            |                                |
| **validateReportParams**     | report.js                        | 校验报表页面必选参数（如至少有一个分组和统计指标）是否满足要求 | 读取页面输入（例如查询模式、模板选择、隐藏条件数据）         | Boolean（true/false），并弹出提示                            | 用于防止错误提交查询           |
| **renderReportHeader**       | report.js                        | 根据后端返回的 header 数据生成报表的多层表头，并更新到 DOM   | header 数组（包含各层单元格信息，如 text、colspan、rowspan 等） | 更新 DOM（表格头部）                                         | 用于构造报表的多层表头         |
| **renderReportTable**        | report.js                        | 根据后端返回的 rows 数组生成报表数据行，并更新到 DOM         | rows 数组（每行数据包含分组标签、各统计指标的数量、占比、总数） | 更新 DOM（表格主体）                                         |                                |
| **aggregate_query_data**     | analysis_api.py                  | 后端共享函数：解析查询参数、构造 SQLAlchemy 查询、执行分组与聚合统计、生成统一数据结构 | SQLAlchemy Query 对象、query_mode、template、advanced_str（高级条件 JSON 字符串） | 字典对象，包含：grouping_expr、dynamic_metrics、data_rows、labels 等 | 确保报表与图表数据一致         |
| **build_multi_level_header** | analysis_api.py                  | 根据动态统计指标构造多层表头（用于 Excel 导出或报表展示）    | dynamic_metrics（统计指标配置）、group_title（分组字段中文名称） | header 数组（多层表头各行单元格信息）                        |                                |
| **export_to_excel**          | analysis_api.py                  | 将统计数据导出为 Excel 文件                                  | header、data_rows、file_name                                 | BytesIO 对象，供 send_file 使用                              | 用于报表导出功能               |

------

## 二、数据流程图

flowchart TD
    A[用户在报表/图表页面输入查询条件<br/>(预定义模板或自定义查询)]
    B[comboQuery_report.js 收集查询条件<br/>(动态添加、清除、获取条件)]
    C[getComboConditions()<br/>(返回条件 JSON 数组)]
    D[getReportQueryParams() / getChartQueryParams()<br/>(构造 URLSearchParams)]
    E[前端统一查询数据对象<br/>(包含 query_mode, template/advanced_conditions, stat_time, report_name, chart_type)]
    F[前端发起 AJAX GET 请求<br/>目标接口：/api/analysis/report 或 /api/analysis/chart]
    G[后端 API (analysis_api.py)]
    H[解析 GET 参数<br/>(query_mode, template, advanced_conditions, etc.)]
    I[调用共享函数<br/>aggregate_query_data()]
    J[构造 SQLAlchemy Query<br/>对 Student & StudentExtension 进行过滤、分组、聚合]
    K[生成统一聚合数据结构<br/>(labels, datasets, data_rows, 包含"合计"行)]
    L[后端返回 JSON 数据<br/>(统一格式的统计数据)]
    M[前端接收返回数据]
    N[报表页面<br/>(report.js): renderReportHeader() + renderReportTable()]
    O[图表页面<br/>(chart.js): renderChart() + getChartOptions()]
    P[图表页面调用<br/>showFilterConditions() 显示筛选条件信息]
    Q[用户点击图表下钻<br/>或切换报表/图表页面时，携带当前查询条件跳转]
    

    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    L --> M
    M --> N
    M --> O
    O --> P
    N --- Q
    O --- Q
    Q --> E



下面给出整个数据收集、传输、查询、计算、以及展示过程的详细数据流程说明：

```mermaid
flowchart TD
    A[用户在报表/图表页面输入查询条件<br/>(预定义模板或自定义查询)]
    B[comboQuery_report.js 收集查询条件<br/>(动态添加、清除、获取条件)]
    C[getComboConditions()<br/>(返回条件 JSON 数组)]
    D[getReportQueryParams() / getChartQueryParams()<br/>(构造 URLSearchParams)]
    E[前端统一查询数据对象<br/>(包含 query_mode, template/advanced_conditions, stat_time, report_name, chart_type)]
    F[前端发起 AJAX GET 请求<br/>目标接口：/api/analysis/report 或 /api/analysis/chart]
    G[后端 API (analysis_api.py)]
    H[解析 GET 参数<br/>(query_mode, template, advanced_conditions, etc.)]
    I[调用共享函数<br/>aggregate_query_data()]
    J[构造 SQLAlchemy Query<br/>对 Student & StudentExtension 进行过滤、分组、聚合]
    K[生成统一聚合数据结构<br/>(labels, datasets, data_rows, 包含"合计"行)]
    L[后端返回 JSON 数据<br/>(统一格式的统计数据)]
    M[前端接收返回数据]
    N[报表页面<br/>(report.js): renderReportHeader() + renderReportTable()]
    O[图表页面<br/>(chart.js): renderChart() + getChartOptions()]
    P[图表页面调用<br/>showFilterConditions() 显示筛选条件信息]
    Q[用户点击图表下钻<br/>或切换报表/图表页面时，携带当前查询条件跳转]
    
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    L --> M
    M --> N
    M --> O
    O --> P
    N --- Q
    O --- Q
    Q --> E
```

### 流程详细说明

1. **用户输入查询条件**
   - 用户在报表或图表页面（report.html 或 chart.html）选择预定义模板或添加自定义查询条件（例如通过下拉框、文本框、复选框输入）。
   - **comboQuery_report.js** 负责动态添加和管理这些条件，并通过 **getComboConditions()** 生成 JSON 数组。
2. **前端构造统一查询数据对象**
   - 报表页面调用 **getReportQueryParams()**，图表页面调用 **getChartQueryParams()**，从页面中读取所有公共参数（如统计时间、报表名称）及组合查询条件（advanced_conditions）。
   - 最终形成统一的 URLSearchParams 对象（如 `query_mode=custom&advanced_conditions=[…]&stat_time=2023&...`），保证预定义和自定义查询格式统一。
3. **AJAX 请求发起**
   - 前端通过 GET 请求，将构造的查询参数发送至后端接口：
     - 报表页面：`/api/analysis/report`
     - 图表页面：`/api/analysis/chart`
4. **后端统一解析和数据聚合**
   - 后端 **analysis_api.py** 接收到请求后，解析所有 GET 参数（query_mode、template、advanced_conditions 等）。
   - 通过调用共享函数 **aggregate_query_data()**，后端根据查询参数构造 SQLAlchemy 查询，进行数据过滤、分组和聚合统计。
   - 在聚合过程中，会生成各分组数据，并额外计算一行“合计”数据，使返回的 **labels** 数组中包含所有分组（包括“合计”），**datasets** 和 **data_rows** 结构与报表要求一致。
5. **后端返回统一数据格式**
   - 后端将统一构造好的统计数据（包括多层表头信息、分组标签、各统计指标的数量和占比等）以 JSON 格式返回。
6. **前端数据转换和展示**
   - 报表页面的 **report.js** 根据返回数据调用 **renderReportHeader()** 和 **renderReportTable()**，构造并显示多层表头和数据表格。
   - 图表页面的 **chart.js** 根据返回数据调用 **renderChart()**（并结合 **getChartOptions()**）渲染图表，同时调用 **showFilterConditions()** 显示当前筛选条件信息。
   - 数据结构一致保证了报表和图表展示数据完全一致，只是展示方式不同。
7. **页面跳转与下钻功能**
   - 当用户在任一页面中点击下钻或切换报表/图表时，当前查询条件会随 URL 参数传递到目标页面，目标页面重新发起查询，确保数据一致性。

------

## 三、总结

- 前端统一收集预定义模板和自定义查询条件，构造出统一格式的查询数据对象，并通过 GET 请求发送给后端。
- 后端在 **analysis_api.py** 中统一解析查询参数，调用共享聚合函数 **aggregate_query_data()** 构造数据库查询，返回统一格式的统计数据（包括“合计”作为一组分组）。
- 前端报表页面（report.js）和图表页面（chart.js）分别根据相同数据进行不同展示，但共享数据逻辑，确保报表和图表数据一致，同时支持页面之间的跳转和下钻功能。

这种设计最大化了代码共享，不仅复用了查询逻辑，还确保了前后端数据结构和统计结果的一致性，从而降低了维护和出错的风险。

请确认此对照表和数据流程图是否满足您的需求，或是否需要进一步调整或细化。