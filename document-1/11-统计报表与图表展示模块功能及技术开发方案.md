下面是一份经过详细讨论后整理的统计报表页面及图表展示模块的功能与技术开发方案文档，供后续开发参考，请仔细阅读确认：

------

# 统计报表与图表展示模块功能及技术开发方案

## 1. 概述

**目标**
 构建一个统计分析模块，实现对系统内存储的各类数据进行多维度聚合计算，并分别以报表和图表两种形式展示统计结果。模块须满足以下要求：

- 支持用户通过组合查询方式过滤数据（支持预设模板、条件添加、清除、查询操作）。
- 报表页面通过 HTML 表格展示统计数据，并支持分页、导出功能。
- 图表页面利用 Chart.js 绘制图示，展示与报表数据对应的统计结果，并支持鼠标悬停显示详细信息。
- 两个页面之间能通过按钮实现跳转，且共享相同的查询条件，保证报表与图表数据一致。

**主要用户**

- 系统管理员
- 数据分析人员

------

## 2. 功能需求

### 2.1 报表数据展示

- **统计指标**
  - 统计视力数据，包括（但不限于）：
    - 视力等级（干预前与干预后）
    - 裸眼视力数据（左右眼）
    - 屈光数据（左右眼球镜、柱镜、轴位）
    - 干预效果（上升、维持、下降）
  - 用户可选择任意一个或多个数据字段作为统计指标。
  - 用户任意选择字段（例如学校、年级、班级、年龄等）进行分组统计。
  - 用户在确定统计指标和分组规则的前提下，还可以选择任意一个或多个字段作为筛选条件。
  - 交互要求

    ：

    - 如果用户只选择一个字段作为统计指标（例如“视力等级”），则报表表头采用两层结构：
      - 第一层：显示该字段的二级选项（例如“临床前期近视”、“轻度近视”、“中度近视”），
      - 第二层：在每个选项下固定显示“数量”和“占比”。
    - 如果用户选择两个及以上统计指标（例如“左眼视力干预效果”、“右眼视力干预效果”），则报表表头采用三层结构：
      - 第一层：显示各统计指标字段名称，（例如“左眼视力干预效果”、“右眼视力干预效果”）；
      - 第二层：在每个统计指标字段下显示其二级选项（例如“上升”、“下降”、“维持”）；
      - 第三层：在每个二级选项下固定显示“数量”和“占比”。

- **分组**

  - 用户可选取任意一个数据字段作为分组字段（例如“学校”、“年龄”等），分组字段决定报表中每行的统计维度。
  - 自由组合查询中，分组字段在报表第一列显示。要求：
    - 如果使用固定模板（如 template1、template2），则第一列名称由模板决定（例如“年龄段”、“性别”）；
    - 如果使用自定义查询，则第一列名称应动态取自第一个被设定为“分组”角色的字段（例如“学校”、“年龄”），而不能固定写死为“分组”。最后一列为“统计总是”。

  - **筛选**

    - 用户可将任一字段设置为筛选条件，影响统计范围。
    - 筛选条件（如“性别: 男”，“年级: 一年级”）不直接出现在报表行或列中，而在报表右上角以附注形式显示，与统计年份信息在同一行右对齐，字号较正文略小。

- **展示方式报表表格要求**

  - 页面：以 HTML 表格形式展示统计结果。
  - 表格行显示各分组数据，包括“数量”和“占比”。
  - 最后一行显示“合计”，
  - 最后一列显示“统计总数”
  - 筛选条件作为附注，以缩小的字号，展示在表格右上角，与表格右对齐，多重筛选横向并列展示
  - 数据年份作为固定的筛选条件，排在所有筛查条件的最前面

  - 表头：统一为三层结构
    - 第一层：以用户选定作为统计指标的数据字段名称为名头，用户选择几个字段作为统计指标，第一层名头就有几个（比如用户只选择“视力等级”这一个字段作为统计指标，第一层表头就是有“视力等级”这一个，如果用户同时选择了“视力等级”和“干预后视力等级”两个数据字段作为统计指标，那么第一层表头就是“视力等级”和“干预后视力等级”两个名头并列）
    - 第二层：以用户选择作为统计指标的数据字段的二级选项名称，作为第二层表头的名称（比如用户选择“视力等级”为统计指标，而在”视力等级“这个字段下面，用户又选择了“临床前近视和”、“轻度近视”、“中度近视“三个选项，此时这个第一层表头下面的的二层表头就分别是“临床前近视和”、“轻度近视”、“中度近视“三个，如果用户同时选择了其他数据字段作为统计指标，并选择了统计指标下面列示的二级选项的一部分或全部，该第一层表头下面的二层表头，就是用户选择的对应二级选项的名称。
    - 如果用户选择作为统计指标的数据字段没有二级选项，第三层就直接变成第二层，表头就变成了两层结构。
    - 第三层：固定是“数量”和“占比”两项，分配给每一个二层表头
    - 第一列固定是选定为分组的数据字段名称。不分层。
    - 最后一列固定是“统计总数。不分层。
    - 最后一列固定显示“统计总数”。
  - 数据行：按分组统计后生成，每行第一列显示具体分组值（例如具体学校、具体年龄），后续列依次显示各统计指标下“数量”和“占比”。
  - 最后一行为“合计”，显示各统计指标的汇总数据，同时最后一列显示各个分组统计数和总统计数。

  

- **分页与导出**
  - 当统计记录条数较多时，页面通过分页控件（例如每页10条）显示所有数据。
  - 提供“导出报表”按钮，支持将当前统计结果导出为 Excel 文件。

### 2.2 查询功能

- **查询方式**
  - 仅采用组合查询作为唯一查询入口，固定查询条件在报表页面中不再提供列配置功能。
  - 采用组合查询模块：
    - 支持预设查询模板查询：（例如“模版1：按年龄分组”、“模版2：按性别分组”），模板中预先定义统计维度；
    - 用户可以在预设模板基础上修改（增减、调整统计维度），临时生成新的查询条件，或保存为新模板。
    - 支持自定义查询：用户可以选择任意字段作为统计指标，选择任意字段作为分组条件，同时选择任意字段作为筛选条件，进行组合查询

- **查询条件类型**
  - 固定和多选字段（干预效果、视力等级、学校、年级、性别、数据年份等）采用下拉及复选框选择；
  - 数值型字段（裸眼视力、屈光数据等）支持区间查询（输入最小值和最大值）；
  - 文本型字段（姓名）支持模糊查询。

- **年龄字段特殊处理**

  - 区间统计：当用户为 age 输入区间条件（例如最小值6，最大值9），报表显示一行统计该区间数据，分组标签显示“6-9岁”。
  - 多区间支持：允许用户同时输入多个年龄区间（例如“6-9岁”和“10-12岁”），报表中分别统计各区间数据。
  - 具体年龄统计：如果用户不输入区间条件，而仅将 age 设置为分组字段，则直接按数据库中的具体年龄分组，每个具体年龄生成一行数据。

  ### 

- **查询结果处理**
  - 查询条件由组合查询模块收集，并存入隐藏输入框，通过 URL 参数传递到后端统计接口。
  - 后端统计接口根据查询条件执行聚合统计，并返回 JSON 格式数据给前端，前端动态生成表格内容。

### 2.3 图表展示功能

- **图表数据**
  - 图表页面调用后端图表数据接口获取统计结果，数据格式适合 Chart.js 绘制图表。
  - 示例数据包括：
    - 分组标签（例如“上升”、“维持”、“下降”）
    - 每个分组的统计数据（人数或比例）
    - 可配置不同图表类型（柱状图、饼图、折线图等）。
- **展示方式**
  - 图表页面显示一个主要图表区域，利用 Chart.js 绘制图示。
  - 鼠标悬停在图表上时显示详细数据（如具体人数、比例等）。
  - 图表页面提供“返回报表”按钮，跳转回统计报表页面；同样，报表页面提供“查看图表”按钮，跳转到图表页面，保证数据一致性。

### 2.4 页面布局与交互

- **整体布局**
  - 页面继承自统一的基础模板（base.html），保持全局导航、侧边栏、顶部导航一致。
  - 报表页面上半部分为查询区域（组合查询模块），下半部分为统计报表展示区域。
  - 图表页面同样包括查询区域和图表展示区域，但仅展示图表，不再显示数据报表。
- **操作按钮**
  - 查询按钮：收集组合查询条件，调用后端统计接口刷新报表数据；
  - 导出报表按钮：导出当前报表数据；
  - 切换按钮：报表页面的“查看图表”按钮和图表页面的“返回报表”按钮实现页面间跳转。
- **查询模版管理**
  - 提供预设模版下拉菜单，允许用户选择已有模版；
  - 保存模版功能：用户修改当前查询条件后可保存为新模版，下次直接调用。

##### 注：统计报表页面的详细设计见

------

## 3. 技术方案

### 3.1 前端

- **模板与页面结构**
  - 使用 Jinja2 模板引擎构建页面（如 report.html、chart.html）。
  - 采用基础模板（base.html）统一加载全局 CSS、JS 文件。
- **样式**
  - 全局样式由 core.css 定义。
  - 报表页面局部样式由 report.css 管理。
  - 组合查询模块样式由 comboQuery.css 提供，需调整类名避免与报表页面冲突（如将组合查询模块的卡片类统一改为 .report-combo-query-card）。
  - 表头采用两层或三层结构，根据统计指标数量动态生成：
    - 单一统计指标：两层（第一层为二级选项，如“临床前期近视”、“轻度近视”、“中度近视”，第二层为固定“数量”、“占比”）。
    - 多统计指标：三层（第一层显示各统计指标字段名称；第二层显示该字段二级选项；第三层固定显示“数量”、“占比”）。
- **交互逻辑**
  - report.js：
    - 负责收集查询条件（包括自由组合和预设模板）、调用 /api/analysis/report 接口、动态生成报表表头和数据行、生成分页控件、绑定导出和切换图表按钮。
    - 支持点击“保存模版”后弹出对话框，允许修改报表名称；
    - 支持点击表头排序任意统计指标列。
  - comboQuery.js：负责条件添加、删除、条件收集，支持在二级选项中批量选择条件（复选框形式），所有选项与定义的数据字段保持一致。
  - 图表页面使用 Chart.js 及 chart.js 脚本实现图表绘制，数据通过 analysis_api 接口获取。


### 3.2 后端

- **框架**
  - 使用 Flask 构建 RESTful API；
  - 蓝图注册各功能模块接口（如 import_api、query_api、analysis_api）。
- **数据库与 ORM**
  - 使用 Flask-SQLAlchemy 操作 SQLite 数据库（数据量10万条以内）。
- **统计计算与聚合**
  - 分析接口在 analysis_api 蓝图中实现，利用 SQLAlchemy 的聚合函数（func.count、func.sum、group_by 等）根据查询条件对 Student 与 StudentExtension 数据进行聚合统计实现数据统计。
  - 对于“视力不良”，统计计算恢复为：临床前期近视 + 轻度近视 + 中度近视；
  - 对 advanced_conditions 进行解析：
    - 按角色（metric、group、filter）处理；
    - 自由组合查询中对于 age 字段：
      - 如果传入区间条件（字典形式），则构造 case() 表达式支持多个区间（采用最新 SQLAlchemy 语法）；
      - 如果未传入区间条件，则直接 group_by(age)，按具体年龄生成数据行。
  - 当 advanced_conditions 存在时，template 参数忽略，以避免冲突。
- - 接口
    - /api/analysis/report 接口：（使用 func.count、group_by 等函数），返回统计报表数据。
    - /api/analysis/chart 接口：返回适用于图表展示的统计数据（格式适用于 Chart.js）。

### 3.3 实现逻辑

- **查询条件处理**
  - 前端组合查询模块收集条件，存入隐藏输入框 comboConditions；
  - 报表页面和图表页面在查询时都调用 getReportQueryParams()（或类似函数）将固定条件和组合查询条件拼接为 URL 参数，调用后端统计接口。
- **数据聚合统计**
  - 后端统计接口接收查询条件，构造 SQLAlchemy 查询，使用聚合函数计算每个分组（例如按照视力干预效果、性别、年龄段分组）的记录数；
  - 返回 JSON 格式统计数据，包括总人数、各分组人数和比例等。
- **报表生成**
  - 前端 report.js 接收统计数据后，动态生成表头与表格数据，分页控件根据总记录数动态生成；
  - 用户点击导出报表按钮时调用后端导出接口生成 Excel 文件。
- **图表生成**
  - 图表页面调用 /api/analysis/chart 接口，返回数据后利用 Chart.js 绘制柱状图、饼图等；
  - 支持鼠标悬停显示详细信息，提供图表切换及返回报表页面按钮。

------

## 4. 开发步骤

1. **后端接口开发**
   - 在 `analysis_api.py` 中实现 /api/analysis/report 接口，完成聚合统计逻辑。
   - 在 `analysis_api.py` 中实现 /api/analysis/chart 接口，生成适用于图表展示的数据格式。
   - 确保统计计算逻辑支持按预设模版（例如按年龄、按性别）分组统计。
2. **前端报表页面开发**
   - 修改/完善 `report.html`，确保组合查询模块、报表展示区域、分页控件、导出和切换按钮正确布局。
   - 编写/完善 `report.js`，实现查询条件收集、调用统计接口、动态生成表格和分页控件、绑定导出与页面切换按钮。
3. **前端图表页面开发**
   - 修改/完善 `chart.html`，确保图表展示区域与查询区域布局合理。
   - 编写 `chart.js`（或在已有 chart.js 中扩展），调用 /api/analysis/chart 接口，并利用 Chart.js 绘制图表。
   - 绑定返回报表页面按钮，确保图表和报表之间共享查询条件。
4. **查询模版管理开发**
   - 集成组合查询模块（comboQuery.html、comboQuery.js、comboQuery.css），实现预设模板下拉菜单和保存模板功能。
   - 确保预设模板能自动填充查询条件，并能在报表和图表页面中使用统一的查询条件。
5. **整体联调与测试**
   - 分别测试报表页面和图表页面的查询、分页、导出、图表绘制及页面切换功能。
   - 确保统计报表数据和图表数据在不同查询条件下一致。
   - 调试并解决所有前后端交互问题，确保最终用户体验流畅。

------

## 5. 技术框架与开发环境

- **后端**
  - Flask 2.x
  - Flask-SQLAlchemy
  - Waitress（生产服务器）
  - SQLite
- **前端**
  - HTML5、CSS3、JavaScript（原生）
  - Chart.js
  - Bootstrap 5
  - Jinja2 模板
- **开发环境**
  - VSCode
  - Powershell
  - Git

------

## 6. 调用与使用方法

### 6.1 后端接口

- **统计报表接口**
  - URL: `/api/analysis/report`
  - 请求方式: GET
  - 参数: 固定查询条件及组合查询条件（advanced_conditions，JSON 格式）
  - 返回数据: JSON 格式报表统计数据
- **图表数据接口**
  - URL: `/api/analysis/chart`
  - 请求方式: GET
  - 参数同上
  - 返回数据: JSON 格式图表数据，适用于 Chart.js

### 6.2 前端页面

- **报表页面 (report.html)**
  - 包含组合查询区域（通过 comboQuery.html 调用组合查询模块）
  - 通过 report.js 获取查询条件、调用统计接口，动态生成报表表格、分页控件
  - 提供导出报表按钮
- **图表页面 (chart.html)**
  - 包含组合查询区域与图表展示区域
  - 通过 chart.js 调用图表数据接口，利用 Chart.js 绘制图表
  - 提供返回报表页面按钮

------

## 7. 实现细节

- **数据聚合计算**
  - 利用 SQLAlchemy 的聚合函数（如 func.count、group_by）实现按不同统计维度分组统计
  - 支持动态解析组合查询条件，过滤数据后再聚合统计
- **报表与图表联动**
  - 保证报表页面和图表页面均从相同的查询条件出发，调用后端接口获取统计数据
  - 页面跳转通过按钮实现，保证查询条件通过 URL 参数或隐藏输入框共享
- **查询模版**
  - 预设模版由下拉菜单提供，后端不保存模版（也可根据需求保存至数据库或浏览器本地存储）
  - 模版内容包括固定组合查询条件，用户可修改后保存为新模版
- **加载提示**：查询、导出、排序等操作时显示加载动画，并禁用操作按钮，防止重复提交。
- **错误与成功反馈**：操作失败时以弹窗、提示条或 Toast 显示详细错误信息，操作成功时显示成功提示。
- **工具提示与统一样式**：为各操作按钮和控件添加鼠标悬停提示，确保交互风格一致。
- **响应式设计**：确保页面在不同设备上均显示正常，适当调整表格和控件尺寸。
- **查询历史与预览**：考虑记录查询历史，导出前弹出预览窗口供用户确认数据格式和字段顺序。
- **模板管理**：支持保存、编辑、删除查询模板；保存时允许用户修改模板名称，默认显示当前报表名称，方便后续快速调用。

------

以上即为统计报表与图表展示模块的完整功能及技术开发方案。请确认是否符合您的要求，我们将严格按照此方案进行后续代码开发和完善工作。