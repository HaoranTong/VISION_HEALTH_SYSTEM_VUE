





------

# 最低可用功能版本开发计划

本计划调整了原有开发顺序和完成时间，目标是先完成一个最低可用功能（MVP）版本，让客户先试用。该版本的主要要求如下：

1. 仅完成 Web 页面开发，所有用户交互操作均在 Web 页面完成。
2. 完成电子表格导入数据功能。
3. 完成数据查询及统计分析功能。

下文将详细描述各模块的开发任务、完整代码实现、测试用例以及操作步骤。所有代码模块均包含模块文件名称、功能说明、使用说明和详细注释，严格符合开发规范和 Markdown 文档语法要求。

---

## 1. 开发目标

- **Web 前端**：实现数据录入页面、数据查询页面、电子表格导入页面以及统计分析页面，所有用户操作均通过 Web 页面完成。
- **电子表格导入**：支持上传 .xlsx 文件，后端使用 Pandas 解析数据，校验必填字段后将数据存入数据库。
- **数据查询与统计分析**：通过现有数据查询 API 完成数据检索，并新增统计分析 API，返回学生总数及平均视力等指标。

---

## 2. 开发任务分解与时间安排

### 2.1 任务分解

1. **后端 API 开发**
   - 完成**电子表格导入 API**模块（`import_api.py`）。
   - 完成**统计分析 API**模块（`analysis_api.py`）。
   - 调整现有 API（数据录入、查询 API 保持不变）。
   - 修改 `app.py` 注册新蓝图及新增静态页面路由。

2. **前端页面开发**
   - 使用现有 `data_entry.html` 和 `data_query.html` 页面。
   - 新增电子表格导入页面（`data_import.html`）。
   - 新增统计分析页面（`statistics_analysis.html`）。

3. **测试与验证**
   - 编写单元测试用例，覆盖电子表格导入 API 和统计分析 API（分别在 `tests/unit/test_import_api.py` 和 `tests/unit/test_analysis_api.py`）。
   - 完整测试前后端交互及数据导入、查询和统计功能。

### 2.2 时间安排

- **后端 API 开发**：2 周
- **前端页面开发**：1 周
- **单元测试与集成测试**：1 周
- **总周期**：约 4 周

---

## 3. 代码模块实现

### 3.1 后端 API 模块

#### 3.1.1 电子表格导入 API  
**文件名称**：`src/context_system/api/endpoints/import_api.py`  
**功能说明**：  
- 接收上传的 Excel 文件（.xlsx），使用 Pandas 解析数据。
- 校验必填字段（`full_edu_id`、`name`、`school_code`、`vision_left`、`vision_right`）。
- 将数据存入数据库，返回导入记录条数；错误时返回错误信息。  
**使用说明**：  
- 请求 URL：`/api/students/import`  
- 请求方法：`POST`  
- 参数：文件参数 `file`（multipart/form-data）。

```python
# import_api.py

"""
import_api.py

功能说明：
    提供电子表格数据导入功能。
    接收上传的 Excel 文件 (.xlsx)，使用 Pandas 解析数据，
    校验必填字段（full_edu_id, name, school_code, vision_left, vision_right），
    将数据存入数据库，并返回导入记录条数或错误信息。

使用说明：
    API 接口 URL: /api/students/import
    请求方法: POST
    请求内容类型: multipart/form-data
    参数: file（上传的 .xlsx 文件）
"""

import os
import pandas as pd
from flask import Blueprint, request, jsonify
from werkzeug.utils import secure_filename
from src.context_system.core.models.student import Student
from src.context_system.infrastructure.database import db
from sqlalchemy.exc import SQLAlchemyError

# 创建 Blueprint
import_api = Blueprint('import_api', __name__)

# 允许上传的文件扩展名
ALLOWED_EXTENSIONS = {'xlsx'}

def allowed_file(filename):
    """检查文件是否为允许的扩展名"""
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@import_api.route('/api/students/import', methods=['POST'])
def import_students():
    """
    电子表格导入 API 接口
    接收上传的 Excel 文件，使用 Pandas 解析文件，校验必填字段，
    将符合要求的数据存入数据库，返回导入成功的记录条数。
    """
    if 'file' not in request.files:
        return jsonify({"error": "未找到上传文件"}), 400
    file = request.files['file']
    if file.filename == '':
        return jsonify({"error": "未选择文件"}), 400
    if file and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        # 将文件保存到临时目录
        filepath = os.path.join(os.getcwd(), filename)
        file.save(filepath)
        try:
            # 使用 Pandas 读取 Excel 文件
            df = pd.read_excel(filepath)
            required_columns = ['full_edu_id', 'name', 'school_code', 'vision_left', 'vision_right']
            missing_columns = [col for col in required_columns if col not in df.columns]
            if missing_columns:
                return jsonify({"error": f"缺少必填字段：{', '.join(missing_columns)}"}), 400
            imported_count = 0
            for index, row in df.iterrows():
                # 校验必填字段数据不为空
                if pd.isna(row['full_edu_id']) or pd.isna(row['name']) or pd.isna(row['school_code']) or pd.isna(row['vision_left']) or pd.isna(row['vision_right']):
                    continue
                student = Student(
                    full_edu_id=str(row['full_edu_id']),
                    school_code=str(row['school_code']),
                    name=str(row['name']),
                    vision_left=float(row['vision_left']),
                    vision_right=float(row['vision_right']),
                    myopia_level=None  # 由系统后续自动计算
                )
                db.session.add(student)
                imported_count += 1
            db.session.commit()
            # 删除临时文件
            os.remove(filepath)
            return jsonify({"message": "导入成功", "imported_count": imported_count}), 200
        except Exception as e:
            db.session.rollback()
            return jsonify({"error": f"文件处理错误: {str(e)}"}), 500
    else:
        return jsonify({"error": "不支持的文件格式，请上传 .xlsx 文件"}), 400
```

#### 3.1.2 统计分析 API

**文件名称**：`src/context_system/api/endpoints/analysis_api.py`
 **功能说明**：

- 提供统计分析接口，返回学生总数、平均左眼视力和平均右眼视力等统计指标。
   **使用说明**：
- 请求 URL：`/api/analysis/statistics`
- 请求方法：`GET`

```python
# analysis_api.py

"""
analysis_api.py

功能说明：
    提供统计分析 API 接口，用于根据数据库中学生数据生成统计数据。
    返回学生总数、平均左眼视力和平均右眼视力等指标。

使用说明：
    API 接口 URL: /api/analysis/statistics
    请求方法: GET
"""

from flask import Blueprint, jsonify
from src.context_system.core.models.student import Student
from src.context_system.infrastructure.database import db

# 创建 Blueprint
analysis_api = Blueprint('analysis_api', __name__)

@analysis_api.route('/api/analysis/statistics', methods=['GET'])
def statistics():
    """
    统计分析 API 接口
    返回学生总数、平均左眼视力和平均右眼视力等统计数据。
    """
    try:
        total_students = Student.query.count()
        # 使用 SQLAlchemy 函数计算平均值
        from sqlalchemy import func
        avg_vision_left = db.session.query(func.avg(Student.vision_left)).scalar() or 0
        avg_vision_right = db.session.query(func.avg(Student.vision_right)).scalar() or 0

        result = {
            "total_students": total_students,
            "average_vision_left": round(avg_vision_left, 2),
            "average_vision_right": round(avg_vision_right, 2)
        }
        return jsonify(result), 200
    except Exception as e:
        return jsonify({"error": f"统计分析错误: {str(e)}"}), 500
```

------

#### 3.1.3 数据查询 API 和 学生数据录入 API

这两部分代码已在原系统中实现，详细代码见之前版本（《近视预防干预系统开发文档_v1.1》中已包含）。

------

#### 3.1.4 修改后的应用入口

**文件名称**：`app.py`
 **功能说明**：

- 初始化 Flask 应用、加载配置、注册所有 API 蓝图和静态页面路由（包括新增加的导入和统计分析页面）。
   **使用说明**：
- 启动 Flask 开发服务器，访问相应 URL 获取页面和 API 服务。

```python
# app.py

"""
app.py

功能说明：
    初始化 Flask 应用、加载配置、初始化数据库并注册 API 蓝图。
    注册学生数据录入、查询、电子表格导入和统计分析 API 蓝图。
    定义根路由及静态文件路由（返回前端页面）。
    启动 Flask 开发服务器（调试模式）。

使用说明：
    启动命令: python app.py
    支持访问以下页面：
        - /data_entry.html
        - /data_query.html
        - /data_import.html
        - /statistics_analysis.html
"""

import os
from flask import Flask, send_from_directory
from src.context_system.api.endpoints.student_api import student_api
from src.context_system.api.endpoints.query_api import query_api
from src.context_system.api.endpoints.import_api import import_api
from src.context_system.api.endpoints.analysis_api import analysis_api
from src.context_system.infrastructure.database import db
from config.app.config import DevelopmentConfig

app = Flask(__name__)
app.config.from_object(DevelopmentConfig)
print("SQLALCHEMY_DATABASE_URI:", app.config.get("SQLALCHEMY_DATABASE_URI"))
db.init_app(app)

# 注册所有蓝图
app.register_blueprint(student_api)
app.register_blueprint(query_api)
app.register_blueprint(import_api)
app.register_blueprint(analysis_api)

@app.route('/')
def index():
    """
    根路由函数，当用户访问根路径时返回欢迎信息。
    """
    return "欢迎来到近视预防干预系统！"

@app.route('/data_entry.html')
def data_entry():
    """
    返回数据录入页面的静态文件
    从 frontend/web/ 目录中返回 data_entry.html 文件。
    """
    directory = os.path.join(app.root_path, 'frontend', 'web')
    return send_from_directory(directory, 'data_entry.html')

@app.route('/data_query.html')
def data_query():
    """
    返回数据查询页面的静态文件
    从 frontend/web/ 目录中返回 data_query.html 文件。
    """
    directory = os.path.join(app.root_path, 'frontend', 'web')
    return send_from_directory(directory, 'data_query.html')

@app.route('/data_import.html')
def data_import():
    """
    返回电子表格导入页面的静态文件
    从 frontend/web/ 目录中返回 data_import.html 文件。
    """
    directory = os.path.join(app.root_path, 'frontend', 'web')
    return send_from_directory(directory, 'data_import.html')

@app.route('/statistics_analysis.html')
def statistics_analysis():
    """
    返回统计分析页面的静态文件
    从 frontend/web/ 目录中返回 statistics_analysis.html 文件。
    """
    directory = os.path.join(app.root_path, 'frontend', 'web')
    return send_from_directory(directory, 'statistics_analysis.html')

if __name__ == '__main__':
    app.run(debug=True)
```

------

### 3.2 前端页面模块

#### 3.2.1 数据录入页面

**文件名称**：`frontend/web/data_entry.html`
 （代码见之前版本，不再重复，此文件已实现学生数据录入。）

#### 3.2.2 数据查询页面

**文件名称**：`frontend/web/data_query.html`
 （代码见之前版本，不再重复，此文件已实现数据查询。）

#### 3.2.3 电子表格导入页面

**文件名称**：`frontend/web/data_import.html`
 **功能说明**：

- 允许用户选择 .xlsx 文件上传，调用后端电子表格导入 API 实现数据批量导入。
   **使用说明**：
- 用户选择文件后点击“上传并导入”按钮，通过 AJAX 请求将文件发送到 `/api/students/import`。

```html
<!-- data_import.html -->

<!--
文件名称：data_import.html
功能说明：本页面用于通过电子表格导入学生数据。
         使用 Bootstrap 构建表单，通过表单上传 .xlsx 文件到后端 API。
使用说明：
    用户选择 .xlsx 文件后点击提交，页面通过 AJAX 调用后端 /api/students/import 接口。
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>电子表格数据导入</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>电子表格数据导入</h2>
        <form id="importForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="excelFile" class="form-label">选择 Excel 文件 (.xlsx)</label>
                <input type="file" class="form-control" id="excelFile" name="file" accept=".xlsx" required>
            </div>
            <button type="submit" class="btn btn-primary">上传并导入</button>
        </form>
        <div id="importResult" class="mt-3"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // 为导入表单绑定提交事件
        $("#importForm").submit(function(event) {
            event.preventDefault();
            let formData = new FormData();
            let file = $("#excelFile")[0].files[0];
            formData.append("file", file);
            $.ajax({
                url: "http://127.0.0.1:5000/api/students/import",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $("#importResult").html("<div class='alert alert-success'>导入成功，记录数：" + response.imported_count + "</div>");
                },
                error: function(xhr) {
                    let errorMsg = "导入失败";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += "：" + xhr.responseJSON.error;
                    }
                    $("#importResult").html("<div class='alert alert-danger'>" + errorMsg + "</div>");
                }
            });
        });
    </script>
</body>
</html>
```

------

#### 3.2.4 统计分析页面

**文件名称**：`frontend/web/statistics_analysis.html`
 **功能说明**：

- 通过 AJAX 请求调用后端统计分析 API 获取统计数据，并以表格形式展示。
   **使用说明**：
- 页面加载后自动请求 `/api/analysis/statistics` 接口，展示学生总数、平均左眼视力和平均右眼视力。

```html
<!-- statistics_analysis.html -->

<!--
文件名称：statistics_analysis.html
功能说明：本页面用于展示学生数据的统计分析结果，
         通过 AJAX 调用后端统计分析 API 获取数据，并以表格形式展示结果。
使用说明：
    页面加载后自动请求 /api/analysis/statistics 接口，显示统计数据。
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>统计分析</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>统计分析结果</h2>
        <div id="analysisResult"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // 页面加载后调用统计分析 API
        $(document).ready(function() {
            $.ajax({
                url: "http://127.0.0.1:5000/api/analysis/statistics",
                type: "GET",
                success: function(response) {
                    let html = "<table class='table table-bordered'><tr><th>指标</th><th>数值</th></tr>";
                    html += "<tr><td>学生总数</td><td>" + response.total_students + "</td></tr>";
                    html += "<tr><td>平均左眼视力</td><td>" + response.average_vision_left + "</td></tr>";
                    html += "<tr><td>平均右眼视力</td><td>" + response.average_vision_right + "</td></tr>";
                    html += "</table>";
                    $("#analysisResult").html(html);
                },
                error: function(xhr) {
                    $("#analysisResult").html("<div class='alert alert-danger'>获取统计数据失败</div>");
                }
            });
        });
    </script>
</body>
</html>
```

------

## 4. 测试计划

### 4.1 测试用例

#### 4.1.1 电子表格导入 API 测试

**文件名称**：`tests/unit/test_import_api.py`
 **功能说明**：

- 测试成功上传有效 Excel 文件并验证返回的记录条数；
- 测试未上传文件以及无效文件格式的错误处理。

```python
# tests/unit/test_import_api.py

"""
test_import_api.py

功能说明：
    包含针对电子表格导入 API 的单元测试：
    1. 测试成功上传有效 Excel 文件，验证返回导入记录条数。
    2. 测试上传无文件或无效文件格式，验证错误处理。

使用说明：
    在激活虚拟环境后，通过运行以下命令执行测试：
        python -m unittest tests/unit/test_import_api.py
"""

import os
import io
import unittest
import pandas as pd
from app import app, db

class ImportAPITestCase(unittest.TestCase):
    def setUp(self):
        app.config['TESTING'] = True
        self.client = app.test_client()
        # 创建测试数据库
        with app.app_context():
            db.create_all()
    
    def tearDown(self):
        with app.app_context():
            db.session.remove()
            db.drop_all()
    
    def test_import_success(self):
        # 创建一个测试 Excel 文件（内存文件）
        df = pd.DataFrame({
            'full_edu_id': ['test1', 'test2'],
            'name': ['Alice', 'Bob'],
            'school_code': ['SC001', 'SC002'],
            'vision_left': [4.5, 4.0],
            'vision_right': [4.8, 4.3]
        })
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
            df.to_excel(writer, index=False)
        output.seek(0)
        data = {
            'file': (output, 'test.xlsx')
        }
        response = self.client.post('/api/students/import', data=data, content_type='multipart/form-data')
        self.assertEqual(response.status_code, 200)
        json_data = response.get_json()
        self.assertIn('imported_count', json_data)
        self.assertEqual(json_data['imported_count'], 2)
    
    def test_import_no_file(self):
        response = self.client.post('/api/students/import', data={}, content_type='multipart/form-data')
        self.assertEqual(response.status_code, 400)
        json_data = response.get_json()
        self.assertIn('error', json_data)
    
    def test_import_invalid_file_format(self):
        data = {
            'file': (io.BytesIO(b"dummy data"), 'test.txt')
        }
        response = self.client.post('/api/students/import', data=data, content_type='multipart/form-data')
        self.assertEqual(response.status_code, 400)
        json_data = response.get_json()
        self.assertIn('error', json_data)

if __name__ == '__main__':
    unittest.main()
```

------

#### 4.1.2 统计分析 API 测试

**文件名称**：`tests/unit/test_analysis_api.py`
 **功能说明**：

- 测试统计分析 API 返回正确的统计数据（学生总数、平均视力）。

```python
# tests/unit/test_analysis_api.py

"""
test_analysis_api.py

功能说明：
    包含针对统计分析 API 的单元测试：
    测试统计分析 API 返回正确的统计数据。

使用说明：
    在激活虚拟环境后，通过运行以下命令执行测试：
        python -m unittest tests/unit/test_analysis_api.py
"""

import unittest
from app import app, db
from src.context_system.core.models.student import Student

class AnalysisAPITestCase(unittest.TestCase):
    def setUp(self):
        app.config['TESTING'] = True
        self.client = app.test_client()
        with app.app_context():
            db.create_all()
            # 添加测试数据
            student1 = Student(full_edu_id="id1", school_code="SC001", name="Alice", vision_left=4.5, vision_right=4.8, myopia_level=None)
            student2 = Student(full_edu_id="id2", school_code="SC002", name="Bob", vision_left=4.0, vision_right=4.3, myopia_level=None)
            db.session.add(student1)
            db.session.add(student2)
            db.session.commit()

    def tearDown(self):
        with app.app_context():
            db.session.remove()
            db.drop_all()

    def test_statistics(self):
        response = self.client.get('/api/analysis/statistics')
        self.assertEqual(response.status_code, 200)
        json_data = response.get_json()
        self.assertIn('total_students', json_data)
        self.assertEqual(json_data['total_students'], 2)
        self.assertIn('average_vision_left', json_data)
        self.assertIn('average_vision_right', json_data)

if __name__ == '__main__':
    unittest.main()
```

------

### 4.2 操作步骤

1. **确保项目目录结构正确**，所有文件均放在对应位置（参考最新的目录结构）。

2. 激活虚拟环境

   ：

   ```powershell
   cd E:\DEV_CONTEXT\1_Projects\VISION_HEALTH_SYSTEM
   .\.venv\Scripts\Activate
   ```

3. 初始化数据库

   ：

   ```powershell
   python init_db.py
   ```

4. 启动 Flask 应用

   ：

   ```powershell
   python app.py
   ```

   - 验证终端输出显示正确的数据库 URI。
   - 在浏览器中访问：
     - `http://127.0.0.1:5000/data_entry.html`（数据录入页面）
     - `http://127.0.0.1:5000/data_query.html`（数据查询页面）
     - `http://127.0.0.1:5000/data_import.html`（电子表格导入页面）
     - `http://127.0.0.1:5000/statistics_analysis.html`（统计分析页面）

5. 执行单元测试

   ：

   - 对导入 API 测试：

     ```powershell
     python -m unittest tests/unit/test_import_api.py
     ```

   - 对统计分析 API 测试：

     ```powershell
     python -m unittest tests/unit/test_analysis_api.py
     ```

------

## 5. 部署计划

- **开发环境**：使用当前配置的虚拟环境及 SQLite 数据库进行本地测试。
- **正式部署**：在最低可用版本确认后，计划迁移至云平台（如 Docker 容器化部署，使用 MySQL 数据库）。
- **后续迭代**：在客户试用后，基于反馈逐步添加用户认证、权限管理、后台字段动态配置等完整功能。

------

## 6. 总结

本开发计划调整了开发顺序和时间，先实现一个最低可用版本（MVP），涵盖：

- 完整的 Web 页面交互（数据录入、查询、电子表格导入、统计分析）。
- 后端 API 完成 Excel 数据导入和统计分析功能。
- 完整的单元测试覆盖导入与统计分析模块。

所有代码模块均提供了详细注释、模块说明及使用说明，确保开发团队和客户均能清晰理解并验证系统功能。后续将在客户试用基础上进行迭代更新，完善剩余功能。

```
以上即为最低可用功能版本的完整开发计划和代码实现，确保预期功能满足后，客户可先进行试用，然后进行后续迭代更新上线完整功能。
```