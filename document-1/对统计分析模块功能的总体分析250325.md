下面是对您需求的详细描述，供双方确认：

------

## 模块总体概述

**功能模块名称**：统计分析模块
 **包含页面**：

1. **统计报表页面**
2. **图表展示页面**

该模块是近视预防与干预系统的一部分，主要目的是为用户提供基于用户指定查询条件的数据统计、报表展示和数据可视化图表展示功能。前后端协同工作，支持预设模板查询和自定义组合查询两种模式，同时提供数据导出和交互式图表操作。

------

## 1. 查询条件与数据筛选

### 1.1 查询模式

- **预设模板模式**
  - 用户通过下拉框选择固定模板，如“按年龄段”或“按性别”。
  - 系统自动构造预设的分组条件与统计逻辑（例如模板1：按年龄段分组，模板2：按性别分组），无需用户手动设置详细条件。
- **自定义查询模式**
  - 用户可利用组合查询模块自由选择查询条件。
  - 查询条件分为三种角色：
    - **分组条件（Group）**：决定报表行的分组依据。
    - **统计指标（Metric）**：决定需要统计的字段，每个统计指标在报表中会生成“数量”和“占比”两列。
    - **筛选条件（Filter）**：用于对查询数据进行进一步过滤，但不参与报表分组或统计计算。

### 1.2 参数验证

- **必选项验证**：
  - 无论采用哪种模式，必须至少选择一个数据字段作为“分组”和至少一个数据字段作为“统计指标”。
  - 对于支持二级选项或需要数值/文本输入的字段，用户必须至少选择或填写一个有效值，否则需弹出提示“请选择二级选项或填写数值或文本”。
- **特殊处理**：
  - 对于干预方式等特殊字段，要求操作符为 `in`，并且系统对传入的子选项做映射转换，以确保后端能正确识别。

------

## 2. 统计报表页面

### 2.1 页面布局与风格

- **查询区域**：
  - 与图表页面共享同一组合查询区域，包括固定查询字段（如学校、年级、数据年份等）、统计时间、报表名称、查询模式（模板或自定义）以及动态添加的组合查询条件。
  - 模板模式下，下拉框直接选择模板；自定义模式下，允许用户动态添加多个查询条件行，每一行包含角色、字段、操作符和查询值。
- **报表展示区域**：
  - 展示为一个表格，表头为多层结构，数据行按照分组计算后的统计结果排列。

### 2.2 多层表头设计

- **第一列（分组列）**：
  - 始终显示分组信息，不参与层级拆分。
  - 表头名称规则：
    - 如果所有分组条件均来自同一字段（例如多次选择“年龄”），则第一列表头使用该字段中文名称（如“年龄”）；
    - 如果分组条件来自多个不同字段，则统一显示“分组”。
  - 该单元格跨越所有中间表头层数（即设置 rowspan 为 2 或 3）。
- **中间部分（统计指标区域）**：
  - **第一层**：显示每个被选统计指标的中文名称。
    - 如果同一统计指标被多次选择（例如“左眼裸眼视力”输入多个区间），只显示一次指标名称，但后续会区分不同子选项。
  - **第二层**（可选）：
    - 对于支持二级选项的统计指标，显示用户输入的数值区间或具体子选项的标签。
    - 如果某个指标仅选择一次且无额外选项，则可以直接跳过第二层。
  - **最下层**：
    - 无论是否存在第二层，每个统计指标（或每个子选项）对应生成两列，分别显示“数量”和“占比”。
- **最后一列（统计总数）**：
  - 固定显示“统计总数”，同样不参与分层，且跨行数与第一列一致。

### 2.3 数据行与合计行

- **数据行**：
  - 每行第一列显示分组标签，后续列按照各统计指标和其子选项顺序显示对应的“数量”和“占比”，最后一列显示该分组下的总数。
  - “占比”列的值按该分组内具体统计数据计算百分比。
- **合计行**：
  - 在数据行末尾增加“合计”行：
    - 对各“数量”列进行累加；
    - 对“占比”列，使用累计数量与总体统计数重新计算百分比（合计行不显示占比或显示为空）。

### 2.4 数据导出

- 提供 Excel 导出功能，导出内容包括完整的多层表头、所有数据行及合计行。
- 导出时使用 openpyxl 生成 Excel 文件，要求：
  - 表头单元格合并（使用 rowspan 与 colspan）；
  - 数据格式中，对于“占比”列设置百分比格式显示。

------

## 3. 图表展示页面

### 3.1 页面布局与风格

- **查询区域**：
  - 与统计报表页面完全一致，复用组合查询区域，使得用户在两页面之间切换时条件保持一致。
- **图表展示区域**：
  - 使用 `<canvas id="analysisChart">` 元素，通过 Chart.js 渲染图表。
  - 页面右侧增加图表类型切换下拉框，支持“柱状图”、“饼图”、“折线图”等类型。
  - 针对饼图，前端动态为 `<canvas>` 添加特定 CSS 类（如 `.pie-chart`），确保图表显示为固定正方形并居中。

### 3.2 数据请求与图表渲染

- 前端通过统一构造查询参数（包括固定字段、组合查询条件、统计时间、报表名称等），调用后端 `/api/analysis/chart` 接口。
- 接口返回的数据格式适合 Chart.js 使用，包括：
  - `labels`: 各个分组标签数组（如“男”、“女”、“合计”）。
  - `datasets`: 数组，每个对象包含 `label`、`data`（统计数量或占比）、`backgroundColor` 等配置项。
- 图表配置支持响应式、交互式操作：
  - 点击图表中的数据点，可跳转到统计报表页面，并带上当前点击的分组条件。
  - 提供图表导出功能，将当前图表以 PNG 格式下载。

------

## 4. 交互与前端组件

### 4.1 组合查询模块

- 用户可动态添加、删除查询条件行。
- 每一行包含：
  - **角色选择下拉框**：选项包括“统计指标”、“分组”、“筛选”。
  - **字段下拉框**：列出所有支持的字段，字段名称使用后端统一标识（英文），显示时转换为中文。
  - **运算符下拉框**：如 `=`, `!=`, `like`, `>`, `<` 等。
  - **值输入区域**：根据字段类型生成相应的输入控件（文本框、数值区间输入、复选框组等）。
- 组合查询条件最终被序列化成 JSON 字符串传递给后端接口（例如 advanced_conditions 参数）。

### 4.2 参数收集与统一处理

- 前端模块（comboQuery_report.js、report.js、chart.js）均通过统一的函数（如 getReportQueryParams()）收集查询参数，保证报表与图表页面查询条件完全一致。
- 特殊字段（如干预方式）需要额外进行值映射和操作符的强制设置。

### 4.3 分页与模板切换

- 统计报表页面支持分页显示数据，每页默认显示一定数量记录。
- 模板切换：
  - 模板模式下自动构造分组表达式，如模板1以年龄区间分组，模板2按性别分组；
  - 自定义模式下根据用户的组合查询条件构造动态查询和分组条件。

------

## 5. 后端实现

### 5.1 接口设计

- **统计报表数据接口**：
  - URL：`/api/analysis/report`
  - 支持 GET 请求，处理预设模板和自定义查询模式。
  - 根据查询条件构造 SQLAlchemy 查询，进行分组统计，动态构造多层表头数据结构，并返回 JSON 格式的报表数据和分页信息。
  - 内部处理包括：
    - 解析 advanced_conditions JSON，验证必填条件；
    - 处理数值字段的单值和区间条件；
    - 根据分组字段生成对应的 SQLAlchemy case 表达式，生成第一列分组标签；
    - 对每个统计指标字段（可能多次选择同一字段）计算各子选项的数量，并计算百分比；
    - 生成合计行（总和及占比重新计算）。
- **图表数据接口**：
  - URL：`/api/analysis/chart`
  - 支持 GET 请求，参数包括统计时间、组合查询条件、分组字段（group_by）及统计指标字段（metric）。
  - 构造基础查询、应用筛选条件，并按分组计算总记录数和指标统计数据。
  - 返回数据格式适合 Chart.js 的数据格式，包括 labels、datasets（数量和占比）等。

### 5.2 数据库与 ORM

- 后端使用 Flask 和 SQLAlchemy。
- 数据查询涉及关联 StudentExtension 与 Student 表。
- 依据数据字典中定义的字段及约束，确保所有字段名称、类型和选项与数据库模型一致。

### 5.3 Excel 导出

- 报表接口支持导出 Excel 文件：
  - 使用 openpyxl 生成工作簿，写入多层表头和数据行。
  - 合并单元格、设置居中对齐以及百分比格式化，确保导出文件与页面显示一致。

------

## 6. 用户交互与错误处理

- **前端交互**：
  - 用户通过查询区域输入条件后点击查询按钮，前端首先验证必填项，然后调用相应 API 获取数据并动态渲染报表或图表。
  - 交互按钮包括“添加条件”、“取消”、“查询”、“导出报表”、“导出图表”以及页面间的切换按钮。
- **错误提示**：
  - 若查询参数不全（例如缺少分组或统计指标），前端会弹出提示信息；
  - 后端遇到错误（如数据转换失败、SQL 查询异常）会返回 JSON 格式的错误提示，前端捕获后显示给用户。

------

## 7. 前端样式与布局

- **CSS 文件**：
  - report.css 用于统计报表页面样式调整（如报表标题居中、筛选附注显示）。
  - chart.css 专用于图表展示页面，确保图表区域自适应屏幕高度以及饼图等特殊图表样式处理。
- **HTML 模板**：
  - report.html 和 chart.html 分别定义统计报表和图表展示页面的基本结构，继承统一的基础模板，复用查询区域代码。
- **JavaScript 文件**：
  - report.js 处理统计报表的数据请求、表格渲染、分页和导出功能；
  - chart.js 实现图表数据获取、Chart.js 图表实例创建及交互事件绑定；
  - comboQuery_report.js 实现动态组合查询条件的添加、删除和数据收集逻辑。

------

## 总结

整个统计分析模块主要围绕以下核心点展开：

1. **统一的查询入口**：无论报表或图表页面，都通过同一组合查询模块收集查询条件，支持预设模板和自定义模式。
2. **动态数据统计与分组**：后端根据用户输入构造分组表达式与统计指标，多层表头动态生成，满足不同数据字段组合查询的灵活性。
3. **数据可视化与导出**：图表页面利用 Chart.js 展示交互式图表，支持图表导出；报表页面支持数据表格显示和 Excel 文件导出。
4. **全面的验证与错误处理**：前后端均对输入条件、数值格式和必选项进行严格验证，确保用户体验和数据准确性。
5. **前后端协同开发**：基于 Flask、SQLAlchemy、Chart.js、openpyxl 等技术实现，前端多个模块协作保证界面统一与操作便捷。

以上就是对统计分析模块的详细需求描述，是否满足您的预期？如有补充或修改意见，请及时指出。