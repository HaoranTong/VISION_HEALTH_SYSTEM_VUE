

------

# 组合查询模块功能及技术开发文档

## 1. 模块概述

### 1.1 功能目标

组合查询模块旨在为数据查询页面提供灵活多样的条件查询能力，支持用户通过添加多个查询条件，组合构造出复杂的查询语句。模块功能包括：

- **动态添加查询条件行**：允许用户点击“添加条件”按钮，动态生成一行查询条件。
- **多种查询控件类型支持**：支持文本输入、下拉选择、数值区间查询、复选框多选和单个复选框，满足不同字段类型的查询需求。
- **条件数据收集**：将所有动态生成的查询条件收集为 JSON 数组，传递给后端接口进行查询。
- **与固定查询无缝集成**：固定查询和组合查询条件将共同组成最终的查询条件，统一调用后端查询接口。

### 1.2 技术目标

- 模块化封装：将组合查询的 HTML、CSS、JS 分别封装为独立组件，便于在数据查询页面及统计分析模块中复用。
- 配置驱动：所有字段的查询方式、下拉选项、复选项等均通过静态配置（数组或对象）定义，方便后续维护和扩展。
- 兼容性与扩展性：确保组合查询模块与固定查询区域、分页和其他模块均能正常协同工作，同时允许在调用时修改样式、布局或查询控件。

------

## 2. 功能需求及详细设计

### 2.1 支持字段类型

每个字段可配置以下查询控件类型：

- 文本型 ("text")
  - 用于自由文本输入，如“教育ID号”、“姓名”、“身份证号码”、“家长姓名”等。
- 下拉选择 ("dropdown")
  - 用于字段选项固定的情况，如“数据年份”、“学校”、“年级”、“班级”、“性别”、“视力等级”、“干预后视力等级”等。
  - 选项内容来源于预定义数组，用户可从中选择。
- 数值区间 ("number_range")
  - 用于数值型字段，如“年龄”、“左眼-裸眼视力”、“右眼-裸眼视力”等。
  - 界面生成两个输入框，分别用于输入最小值和最大值。
- 多选复选 ("multi-select")
  - 用于那些有固定多个可能值且允许多选的字段，如“左眼视力干预效果”、“右眼视力干预效果”、“左眼球镜干预效果”、“右眼球镜干预效果”等。
  - 固定选项一般为 “上升”、“维持”、“下降”。
- 单个复选 ("checkbox")
  - 用于布尔型字段，例如“刮痧”、“艾灸”、“中药熏蒸”、“热灸训练”、“穴位贴敷”、“热磁脉冲”、“拔罐”、“框架眼镜”、“隐形眼镜”、“夜戴角膜塑型镜”、“第1次干预” ~ “第16次干预”等。

### 2.2 静态配置

所有字段的查询方式均通过一个配置对象定义，示例如下（部分字段示例）：

```javascript
const comboQueryConfig = {
  "data_year": {
    label: "数据年份",
    type: "dropdown",
    options: ["2023", "2024", "2025", "2026", "2027", "2028"]
  },
  "education_id": {
    label: "教育ID号",
    type: "text"
  },
  "school": {
    label: "学校",
    type: "dropdown",
    options: ["华兴小学", "苏宁红军小学", "师大附小清华小学"]
  },
  "grade": {
    label: "年级",
    type: "dropdown",
    options: ["一年级", "二年级", "三年级", "四年级", "五年级", "六年级", "七年级", "八年级", "九年级"]
  },
  "class_name": {
    label: "班级",
    type: "dropdown",
    options: (function () {
      let arr = [];
      for (let i = 1; i <= 15; i++) {
        arr.push(i + "班");
      }
      return arr;
    })()
  },
  "姓名": { type: "text", label: "姓名" },
  "性别": {
    label: "性别",
    type: "dropdown",
    options: ["男", "女"]
  },
  "年龄": { type: "number_range", label: "年龄" },
  "视力等级": {
    label: "视力等级",
    type: "dropdown",
    options: ["临床前期近视", "轻度近视", "中度近视"]
  },
  "干预后视力等级": {
    label: "干预后视力等级",
    type: "dropdown",
    options: ["临床前期近视", "轻度近视", "中度近视"]
  },
  // 数值区间型字段
  "左眼-裸眼视力": { type: "number_range", label: "左眼-裸眼视力" },
  "右眼-裸眼视力": { type: "number_range", label: "右眼-裸眼视力" },
  // … (其它字段配置)
  // 多选复选框示例（干预效果）
  "左眼视力干预效果": {
    label: "左眼视力干预效果",
    type: "multi-select",
    options: ["上升", "维持", "下降"]
  },
  "右眼视力干预效果": {
    label: "右眼视力干预效果",
    type: "multi-select",
    options: ["上升", "维持", "下降"]
  },
  // 单个复选框示例（例如“刮痧”）
  "刮痧": { label: "刮痧", type: "checkbox" },
  // ……其他布尔型字段同理
};
```

> 注：所有配置项均以键值对形式定义，键为显示的字段名称（用于前端显示及作为提交参数的标识），每个配置对象中包含：
>
> - **label**：显示的文本标签
> - **type**：控件类型（text/dropdown/number_range/multi-select/checkbox）
> - **options**（可选）：对于下拉、多选类型，选项内容数组

### 2.3 模块结构与文件划分

组合查询模块封装为独立的组件，包含以下文件：

- **HTML 文件（comboQuery.html）**
   定义组合查询区域的 DOM 结构，包含：
  - 卡片头部区域：显示“添加条件”、“清除条件”和“查询”按钮；
  - 卡片主体区域：用于动态插入查询条件行，以及一个隐藏输入框（id="comboConditions"）用于存储组合查询条件的 JSON 字符串。
- **CSS 文件（comboQuery.css）**
   定义组合查询模块的样式，包括卡片的外观、内边距、滚动条设置、以及各查询控件的间距等。模块内可定义局部 CSS 变量，用于统一管理组件样式，同时不会影响全局样式。
- **JS 文件（comboQuery.js）**
   实现组合查询的交互逻辑，主要功能包括：
  - 初始化模块（绑定“添加条件”、“清除条件”、“查询”按钮的事件）；
  - 动态添加查询条件行，根据 comboQueryConfig 配置生成相应的控件（文本框、下拉选择、数值区间输入、复选框组等）；
  - 提供 `getComboConditions()` 函数，遍历所有条件行，收集用户输入的查询条件数据，并将结果存储为 JSON 字符串到隐藏输入框中；
  - 在点击“查询”按钮时调用 `getComboConditions()` 并触发数据查询（通常调用页面中的 `fetchData()` 函数）。

### 2.4 调用与使用方法

在数据查询页面（例如 query.html）中，通过模板包含方式调用组合查询模块。调用步骤如下：

1. 在 query.html 文件中，在需要显示组合查询区域的位置，通过 `{% include "comboQuery.html" %}` 引入组合查询模块的 HTML 片段；
2. 在 query.html 中引入 comboQuery.css 和 comboQuery.js 文件，确保组合查询模块样式和交互逻辑生效；
3. 固定查询区域和组合查询区域在页面中并排显示，各自占用一定宽度（例如固定查询区域 50%，组合查询区域 50%或其它比例，可根据需求调整）；
4. 当用户在组合查询区域添加查询条件后，点击组合查询区域的“查询”按钮，comboQuery.js 会调用 `getComboConditions()` 收集条件数据，并将 JSON 字符串存入隐藏输入框，然后调用固定查询页面的 `fetchData()` 函数，将 advanced_conditions 参数传递到后端查询接口中。

调用示例（query.html 部分）：

```html
<!-- 固定查询区域代码…… -->
<div class="card fixed-query-card">
  <!-- 第一排和第二排固定查询条件…… -->
</div>
<!-- 组合查询区域 -->
<div class="card combo-query-card">
  {% include "comboQuery.html" %}
</div>
```

在 JS 中，固定查询的 fetchData() 函数会读取隐藏输入框 comboConditions 的值，并作为 advanced_conditions 参数传递给后端接口。

### 2.5 接口说明

后端查询接口（/api/students/query）支持两种条件：

- **固定查询条件**：由固定查询区域传入，按设定逻辑过滤；
- **组合查询条件**：由组合查询模块收集的 JSON 数组，存储在 advanced_conditions 参数中，后端在 build_query() 中解析后与固定查询条件共同作用于数据库查询。

接口调用示例：

```
/api/students/query?education_id=&school=&...&advanced_conditions=[{"field":"学校","operator":"like","value":"苏宁红军小学"}, ...]
```

后端将根据 advanced_conditions 中的每一项构造 SQLAlchemy 的过滤器，并返回符合条件的记录，同时支持分页显示。

------

## 3. 技术细节与注意事项

### 3.1 CSS 变量与样式隔离

- 模块内部在 comboQuery.css 中可定义局部全局变量（例如 `--combo-card-width`），但这些变量仅在该 CSS 文件内生效，调用时可以通过修改父容器样式或覆盖局部变量来调整组合查询模块的样式。

- 例如，在 comboQuery.css 中定义：

  ```css
  :root {
    --combo-card-width: 75%;
    --combo-card-bg: #ffffff;
    /* 其它变量…… */
  }
  .combo-query-card {
    width: var(--combo-card-width);
    background-color: var(--combo-card-bg);
    /* … */
  }
  ```

  在调用页面中可通过在父容器上覆盖这些变量的值，实现样式调整。

### 3.2 JS 模块封装与调用

- comboQuery.js 模块独立封装了所有组合查询的交互逻辑，通过 DOMContentLoaded 后自动初始化。确保该文件和 HTML 文件 comboQuery.html 一同引用到查询页面中。
- 模块内部所有动态添加的查询条件行，其生成逻辑、删除事件、以及条件数据收集均通过配置对象 comboQueryConfig 控制，确保配置项修改后自动生效。

### 3.3 代码输出与质量要求

- 所有代码均输出完整的源文件，不遗漏任何一行，确保可以直接覆盖原文件运行。
- 修改过程中只针对组合查询模块相关代码进行调整，不破坏固定查询区域、分页、列配置和其它已验证功能。

------

## 4. 调用示例与测试步骤

### 4.1 前端调用

- 在数据查询页面（query.html）中包含组合查询模块：

  ```html
  <div class="card combo-query-card">
    {% include "comboQuery.html" %}
  </div>
  ```

- 在 query.html 中引入 comboQuery.css 和 comboQuery.js，确保模块样式与逻辑正常加载。

### 4.2 测试步骤

1. **加载页面后**：检查固定查询区域和组合查询区域是否并排显示，且各自布局正确。
2. **添加查询条件**：点击“添加条件”按钮，确认动态生成查询条件行，查询条件行控件类型正确（文本框、下拉框、区间输入、复选框组等）。
3. **设置条件并查询**：在组合查询区域设置条件（例如选择“学校”字段，选择“苏宁红军小学”作为条件；或在“姓名”中输入部分姓名），点击组合查询区域的“查询”按钮，检查隐藏输入框中是否正确存储了组合查询条件的 JSON 字符串，并触发固定查询的 fetchData() 函数进行查询。
4. **后端查询**：在 Network 面板检查请求 URL，确认 advanced_conditions 参数是否包含您设置的条件，返回的 JSON 数据是否符合查询条件。
5. **分页与列配置**：确保查询结果分页正常，列配置下拉菜单完整显示所有列项。

------

## 5. 结论

以上文档详细描述了组合查询模块的功能、技术设计、调用方式以及测试步骤。模块采用配置驱动方式，独立封装 HTML、CSS、JS 文件，确保与固定查询模块、分页、列配置等其他功能协同工作，同时满足可扩展和易维护的要求。

请根据本文档进行后续开发与调试，若有任何问题或需要进一步修改的部分，请及时反馈。

------

请确认以上文档是否满足您的需求，如需调整或补充请告知。