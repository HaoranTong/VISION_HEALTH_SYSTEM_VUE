


### **图表展示页面功能需求及技术开发文档v1.0**  
**版本**：1.0  
**日期**：2023年10月25日  

#### **一、项目概述**  

**目标**：为用户提供与统计报表联动的交互式数据可视化功能，支持多维度数据分析，并确保代码可扩展性。  
**范围**：基于现有系统架构，开发图表展示页面，复用布局组件，支持动态查询、多图表类型及数据下钻。  

---

#### **二、功能模块详述**  

---

##### **1. 页面布局与风格**  
**需求描述**：  
- 复用现有系统的侧边栏和顶部导航栏，保持整体风格一致。  
- 顶部组合查询区域与报表页面完全一致（包括模板选择、统计时间、组合查询按钮等），右侧新增图表类型切换按钮。  
- 中间区域为图表展示区，占页面主体80%高度。  

**技术方案**：  
- **前端框架**：基于现有Bootstrap布局，复用 `layouts/base.html` 模板。  
- **DOM结构**：  
  ```html  
  <!-- 顶部导航栏（复用报表页面代码） -->
  <nav class="navbar">...</nav>  
  
  <!-- 顶部组合查询区（与报表页面一致） -->
  <div class="card query-card">  
    <!-- 原有查询控件（模板选择、统计时间、组合查询等） -->
    <div class="card-body">  
      <!-- 报表页面的查询控件代码 -->  
    </div>  
    <!-- 新增图表类型选择 -->  
    <div class="chart-controls">  
      <select id="chartType" class="form-select">  
        <option value="bar">柱状图</option>  
        <option value="pie">饼图</option>  
        <option value="line">折线图</option>  
      </select>  
    </div>  
  </div>  
  
  <!-- 图表展示区 -->  
  <div class="chart-area">  
    <canvas id="analysisChart"></canvas>  
  </div>  
  ```
- **样式文件**：复用 `report.css`，新增 `chart.css` 定义图表容器高度与边距。  

---

##### **2. 动态查询与数据加载**  
**需求描述**：  
- 用户选择分组字段（如学校、年级）、统计指标（如视力等级、干预效果）后，自动触发图表更新。  
- 支持与报表页面相同的组合查询条件（如年龄段、干预方式）。  

**技术方案**：  
- **参数传递**：  
  ```javascript  
  function getChartQueryParams() {  
    const params = new URLSearchParams();  
    // 复用报表页面的查询参数  
    const commonParams = ['template', 'stat_time', 'advanced_conditions'];  
    commonParams.forEach(param => {  
      const value = document.getElementById(param)?.value;  
      if (value) params.append(param, value);  
    });  
    // 新增图表专用参数  
    params.append('group_by', document.getElementById('groupBy').value);  
    params.append('metric', document.getElementById('metric').value);  
    return params;  
  }  
  ```
- **API设计**：  
  ```python  
  # 后端接口：/api/analysis/chart  
  @analysis_api.route("/api/analysis/chart", methods=["GET"])  
  def analysis_chart():  
      group_by = request.args.get("group_by")  # 分组字段（如'school'）  
      metric = request.args.get("metric")      # 统计指标（如'vision_level'）  
      # 数据处理逻辑（参考报表接口，返回labels和datasets）  
      return jsonify({  
          "labels": ["学校A", "学校B"],  
          "datasets": [{  
              "label": "视力正常比例",  
              "data": [30, 45],  
              "backgroundColor": ["#4CAF50", "#2196F3"]  
          }]  
      })  
  ```

---

##### **3. 图表展示与交互**  
**需求描述**：  
- 支持三种图表类型：柱状图、饼图、折线图。  
- 图表需显示标题、图例、数据标签（如百分比）。  
- 点击图例或图表元素可跳转到对应筛选条件下的报表页面。  

**技术方案**：  
- **图表渲染**（基于Chart.js）：  
  ```javascript  
  let analysisChart;  
  
  function renderChart(data) {  
    const ctx = document.getElementById('analysisChart').getContext('2d');  
    if (analysisChart) analysisChart.destroy();  
  
    // 统一配置  
    const options = {  
      responsive: true,  
      plugins: {  
        title: { display: true, text: '视力统计图表' },  
        legend: { position: 'bottom' },  
        datalabels: {  // 添加数据标签  
          formatter: (value) => `${value}%`,  
          color: '#333'  
        }  
      },  
      onClick: (e, elements) => {  // 点击事件  
        if (elements.length > 0) {  
          const index = elements[0].index;  
          const label = data.labels[index];  
          window.location.href = `/report?group_by=${groupBy}&filter=${label}`;  
        }  
      }  
    };  
  
    analysisChart = new Chart(ctx, {  
      type: document.getElementById('chartType').value,  
      data: data,  
      options: options  
    });  
  }  
  ```
- **图表类型适配**：  
  - **柱状图**：显示分类对比，自动调整柱宽和间距。  
  - **饼图**：显示占比分布，添加引导线避免标签重叠。  
  - **折线图**：显示趋势变化，支持平滑曲线和点样式配置。  

---

##### **4. 交互操作区**  
**需求描述**：  
- 提供图表下载（PNG/PDF）、全屏展示、重置筛选条件按钮。  

**技术方案**：  
- **图表下载**：  
  ```javascript  
  document.getElementById('downloadBtn').addEventListener('click', () => {  
    const url = analysisChart.toBase64Image();  
    const link = document.createElement('a');  
    link.download = 'chart.png';  
    link.href = url;  
    link.click();  
  });  
  ```
- **全屏展示**：  
  ```javascript  
  document.getElementById('fullscreenBtn').addEventListener('click', () => {  
    const canvas = document.getElementById('analysisChart');  
    if (canvas.requestFullscreen) canvas.requestFullscreen();  
  });  
  ```

---

#### **三、技术实现规范**  

---

##### **1. 代码可扩展性设计**  
- **模块化拆分**：  
  - `chart.js` 拆分为 `chartCore.js`（图表渲染）、`chartEvents.js`（交互逻辑）、`chartApi.js`（数据请求）。  
- **配置中心化**：  
  ```javascript  
  // config/chartOptions.js  
  export const CHART_COLORS = ['#4CAF50', '#2196F3', '#FF9800'];  
  export const DEFAULT_OPTIONS = {  
    responsive: true,  
    maintainAspectRatio: false  
  };  
  ```
- **动态注册图表类型**：  
  ```javascript  
  // 支持未来扩展新图表类型  
  const chartTypes = {  
    bar: BarController,  
    pie: PieController,  
    line: LineController  
  };  
  ```

---

##### **2. 前后端交互规范**  
- **API响应格式**：  
  ```json  
  {  
    "labels": ["分组1", "分组2"],  
    "datasets": [  
      {  
        "label": "数据集1",  
        "data": [30, 70],  
        "backgroundColor": ["#4CAF50", "#2196F3"]  
      }  
    ]  
  }  
  ```
- **错误处理**：  
  - 后端返回 `400` 时，前端显示Toast提示（如“无效的查询参数”）。  
  - 网络错误时，显示全局错误遮罩层。  

---

##### **3. 性能优化**  
- **数据缓存**：对相同查询参数的结果缓存10分钟（LocalStorage）。  
- **防抖请求**：用户连续操作时，延迟500ms再发送请求。  
  ```javascript  
  let fetchTimeout;  
  document.getElementById('groupBy').addEventListener('change', () => {  
    clearTimeout(fetchTimeout);  
    fetchTimeout = setTimeout(fetchChartData, 500);  
  });  
  ```

---

#### **四、非功能性需求**  

| **需求类型** | **要求**                          |
| ------------ | --------------------------------- |
| **兼容性**   | 支持 Chrome/Firefox/Edge 最新版本 |
| **响应时间** | 数据加载 ≤2秒，图表渲染 ≤1秒      |
| **可维护性** | 代码注释率 ≥30%，API文档齐全      |
| **安全性**   | 数据请求需携带用户Token验证权限   |

---

#### **五、测试计划**  
1. **功能测试**：验证筛选条件联动、图表切换、数据下钻。  
2. **性能测试**：模拟100并发请求，检查响应时间与错误率。  
3. **兼容性测试**：覆盖主流浏览器及移动端分辨率。  

---

#### **六、交付物**  
1. 可运行的图表展示页面（HTML/CSS/JS）。  
2. 后端API接口文档（Swagger）。  
3. 单元测试与集成测试用例。  

---

**审批**：  
开发负责人：________________________  
日期：________________________