下面是一份结构化的总结，涵盖了到目前为止我们完成的主要任务、实现的功能以及关键的技术细节。请仔细阅读，如有问题随时反馈。

------

# 近视预防干预系统——开发任务及技术总结

## 一、整体架构概览

- **后端框架**：使用 Flask 作为 Web 框架

- **数据库**：SQLite，使用 Flask-SQLAlchemy 进行 ORM 映射

- **前端框架**：HTML/CSS/JavaScript；采用 Bootstrap 及 Bootstrap Icons

- 组件化设计

  ：

  - **侧边栏组件**：独立封装，通过共用基础模板 `layouts/base.html` 进行继承
  - **顶部导航栏组件**：同样采用独立命名空间（如 `visionhealth-topnav`），在基础模板中统一引入

- API 接口

  ：

  - 数据导入接口 (`/api/students/import`)
  - 数据查询、统计、计算等其他功能接口

------

## 二、已实现的核心功能

### 1. 页面布局及公共组件

- **基础模板（layouts/base.html）**
  - 定义了页面基本结构：包含顶部导航栏和侧边栏，并预留了主内容区和脚本块
  - 所有页面均通过模板继承获得统一的侧边栏和顶部导航栏
- **侧边栏组件**
  - 文件：`frontend/templates/components/sidebar/sidebar.html`
  - 动态加载菜单数据：通过调用 `/api/menu` API 接口加载菜单项数据
  - 样式文件：`frontend/static/components/sidebar/sidebar.css`
  - 交互逻辑：`frontend/static/components/sidebar/sidebar.js`
  - 当前所有页面均显示统一的侧边栏菜单，便于统一管理
- **顶部导航栏组件**
  - 文件：`frontend/templates/components/topnav/topnav.html`
  - 包含侧边栏折叠按钮、全屏按钮、用户头像及下拉菜单
  - 样式文件：`frontend/static/components/topnav/topnav.css`（采用独立命名空间 `visionhealth-topnav`）
  - 交互逻辑：`frontend/static/components/topnav/topnav.js`

### 2. 数据导入功能

- **导入接口**：

  - 文件：`backend/api/import_api.py`

  - 支持 Excel (.xlsx) 与 CSV (.csv) 文件上传

  - 使用 Pandas 解析上传的文件，并进行数据清洗（包括清除列名称首尾空白字符）

  - **必填字段校验**：验证上传数据中必须存在的字段（例如：`教育ID号`、`学校`、`年级`、`班级`、`姓名`、`性别`、`年龄`、`右眼-裸眼视力`、`左眼-裸眼视力`）

  - 重复数据处理

    ：

    - 根据 `教育ID号` 判断是否为重复数据
    - 已存在数据采用“部分更新”：仅在数据库字段为空时填充新数据；不允许覆盖已有数据

  - 错误记录

    ：

    - 对于缺失必填字段或数据格式不正确的行，记录为失败行
    - 失败行数据会生成上传失败记录表，并在“错误信息”列标红显示错误原因
    - 生成的失败记录表保存至 `frontend/static/uploads` 目录，提供公开下载链接

  - 最终返回 JSON 格式结果，包含成功记录数、失败记录数以及失败记录文件下载链接（若有）

- **数据导入页面**：

  - 文件：`frontend/templates/data_import.html`
  - 页面支持文件选择和拖拽上传
  - 包含“选择文件”、“取消上传”和“上传文件”按钮
  - 上传过程中显示上传状态和错误提示

------

## 三、关键技术细节

### 1. 模板继承与组件共用

- **基础模板 (`layouts/base.html`)** 定义了共用的页面框架，所有具体页面（如首页、数据导入页面）均继承此模板，确保导航栏、侧边栏等公共组件统一。
- 如果将来需要定制某些页面的侧边栏或导航栏，可以通过覆盖模板中的指定块（例如 `{% block sidebar %}`）。

### 2. 动态加载菜单

- **侧边栏 API (`backend/api/sidebar_api.py`)** 返回菜单数据，所有页面通过侧边栏组件调用该接口加载菜单项。
- 修改菜单内容只需更新该 API 接口中返回的数据结构，页面无需修改。

### 3. 数据清洗与校验

- 在 

  ```
  import_api.py
  ```

   中：

  - 对 DataFrame 的列名执行 `df.columns = df.columns.str.strip()`，确保去除首尾空白字符。
  - 校验必填字段，调用 `validate_required_fields()` 函数；如果同一行存在多个必填项缺失，计为一条失败记录。

### 4. 重复数据处理

- 利用 `education_id` 判断数据重复。

- 对于已存在的数据行，调用 

  ```
  partial_update_student()
  ```

   进行部分更新。更新规则：

  - 如果数据库已有值，则不覆盖；
  - 仅当数据库字段为 `None` 时，使用上传数据更新。

### 5. 失败记录生成

- 对于校验不合格的行，将这些行提取出来保存为 Excel 文件，文件生成后放置于 `frontend/static/uploads` 目录，并返回下载链接。
- 使用 XlsxWriter 引擎写入 Excel 文件，并对错误信息列使用红色字体标识。

------

## 四、需要注意和维护的事项

- 不要轻易修改已经调试通过的代码
  - 请在修改代码前做好备份，或者使用 Git 提交以便回退。
- 代码模块之间相互独立
  - 侧边栏和顶部导航栏组件采用独立的命名空间，避免相互干扰。修改某个组件的代码时，要确保不影响其它页面。
- 数据导入模块扩展
  - 如果以后需要支持更多字段或修改校验规则，只需在 `validate_required_fields()` 和 `partial_update_student()` 中调整。
  - 同时如果字段映射关系变化，也需要在该模块中更新对电子表格列名和数据库字段的对应逻辑。
- 日志记录
  - 后续调试时请注意查看 `app.log` 日志文件，记录了详细的调试信息，便于追踪问题。

------

## 五、未来扩展

- 独立页面扩展

  ：

  - 当前所有页面均共用侧边栏和顶部导航栏，如将来需要定制页面导航，可在模板中预留相应的块进行覆盖。

- 数据导入增强

  ：

  - 完善数据校验逻辑，如格式校验、范围校验等。
  - 增加导入进度显示、并行上传控制等高级功能。

- 错误报告细化

  ：

  - 进一步改进失败记录文件的格式和错误提示，使用户更易理解并能迅速定位问题。

------

以上就是目前系统的开发任务和技术细节的完整总结。请根据这个文档进行后续开发和维护，如有任何疑问或需要进一步说明的部分，请随时告知。