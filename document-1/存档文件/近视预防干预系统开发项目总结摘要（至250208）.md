下面提供一份完整的项目总结摘要，该摘要基于对话初始时提供的上下文信息以及我们整个开发过程中的讨论记录。摘要中包含了已完成的工作任务、关键技术细节、各模块的最终定稿代码、关键问题讨论要点及其结论，并以 Markdown 格式输出。请以此摘要作为我们重新开始对话时了解全部开发工作上下文信息的唯一来源。
该总结摘要记录的内容，截止于2025年2月7号

------

# 近视预防干预系统开发项目总结摘要

## 一、项目背景与目标

本项目旨在开发一套**近视预防干预系统**，覆盖学生视力数据录入、近视状况筛查、干预状态跟踪、数据统计分析及图文报表展示输出等全流程。系统的主要目标包括：

- 多层级（学校/区域）数据聚合；
- 动态组合分析（支持 50+ 维度）；
- 智能预警与干预效果评估。

项目需求、设计方案和最低可用版本（MVP）的开发计划已分别在《近视预防干预系统需求文档_v1.1》、《近视预防干预系统开发文档_v1.1》以及《最低可用功能版本开发计划》文档中定义。

------

## 二、文档管理与开发环境

- **需求文档**：近视预防干预系统需求文档_v1.1
  - 主要需求调整包括：新增“学校ID”字段、Excel 导入后自动生成“索引ID”、系统管理员可配置字段及计算规则、数据导入时分别生成“导入失败记录表”和“数据不完整记录表”、前端查询统计支持丰富展示形式及导出等。
- **开发文档**：近视预防干预系统开发文档_v1.1
  - 包括系统架构设计、详细设计、开发计划和环境配置说明。
- **最低可用版本开发计划**：重点先实现 Web 页面（数据录入、查询、Excel 导入、统计分析）功能，后续根据客户反馈逐步扩展。
- **开发环境**：
  - **操作系统**：Windows
  - **开发工具**：VSCode（集成 PowerShell 终端）、Git、GitHub
  - **编程语言**：Python（使用 Flask、SQLAlchemy、Pandas 等）
  - **数据库**：初期使用 SQLite，后续可迁移至 MySQL
  - **目录结构**：项目包含 config、docs、frontend、instance、scripts、src、tests、app.py、init_db.py、requirements.txt 等目录和文件

------

## 三、已完成的工作任务与技术细节

### 3.1 后端模块

#### 3.1.1 应用入口（app.py）

- **功能**：
  - 初始化 Flask 应用、加载配置文件、初始化数据库及注册各 API 蓝图（学生录入、查询、Excel 导入、统计分析）。
  - 定义根路由及静态页面路由，启动 Flask 开发服务器。
- **最终代码**：

```python
# app.py
"""
app.py

功能说明：
    初始化 Flask 应用、加载配置、初始化数据库并注册 API 蓝图。
    注册学生数据录入、查询、电子表格导入和统计分析 API 蓝图。
    定义根路由及静态文件路由（返回前端页面）。
    启动 Flask 开发服务器（调试模式）。

使用说明：
    启动命令: python app.py
    支持访问以下页面：
        - /data_entry.html
        - /data_query.html
        - /data_import.html
        - /dashboard.html
"""

import os
from flask import Flask, send_from_directory
from src.context_system.api.endpoints.student_api import student_api
from src.context_system.api.endpoints.query_api import query_api
from src.context_system.api.endpoints.import_api import import_api
from src.context_system.api.endpoints.analysis_api import analysis_api
from src.context_system.infrastructure.database import db
from config.app.config import DevelopmentConfig

app = Flask(__name__)
app.config.from_object(DevelopmentConfig)
print("SQLALCHEMY_DATABASE_URI:", app.config.get("SQLALCHEMY_DATABASE_URI"))
db.init_app(app)

# 注册所有蓝图
app.register_blueprint(student_api)
app.register_blueprint(query_api)
app.register_blueprint(import_api)
app.register_blueprint(analysis_api)

@app.route('/')
def index():
    """
    根路由函数，当用户访问根路径时返回欢迎信息。
    """
    return "欢迎来到近视预防干预系统！"

@app.route('/data_entry.html')
def data_entry():
    """
    返回数据录入页面的静态文件
    从 frontend/web/ 目录中返回 data_entry.html 文件。
    """
    directory = os.path.join(app.root_path, 'frontend', 'web')
    return send_from_directory(directory, 'data_entry.html')

@app.route('/data_query.html')
def data_query():
    """
    返回数据查询页面的静态文件
    从 frontend/web/ 目录中返回 data_query.html 文件。
    """
    directory = os.path.join(app.root_path, 'frontend', 'web')
    return send_from_directory(directory, 'data_query.html')

@app.route('/data_import.html')
def data_import():
    """
    返回电子表格导入页面的静态文件
    从 frontend/web/ 目录中返回 data_import.html 文件。
    """
    directory = os.path.join(app.root_path, 'frontend', 'web')
    return send_from_directory(directory, 'data_import.html')

@app.route('/dashboard.html')
def dashboard():
    """
    返回查询统计分析页面的静态文件
    从 frontend/web/ 目录中返回 dashboard.html 文件。
    """
    directory = os.path.join(app.root_path, 'frontend', 'web')
    return send_from_directory(directory, 'dashboard.html')

if __name__ == '__main__':
    app.run(debug=True)
```

------

#### 3.1.2 数据模型

- **模块**：学生数据模型定义
  - 使用 SQLAlchemy 定义 ORM 模型，学生模型包含字段：教育ID号、学校、学校ID、索引ID（由学校代码与教育ID号组合自动生成）、姓名、左右眼视力、近视等级等。
- **最终代码**：

**models.py**

```python
# models.py
from flask_sqlalchemy import SQLAlchemy

# 初始化数据库对象
db = SQLAlchemy()

class Student(db.Model):
    __tablename__ = 'students'  # 指定数据库表名

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    full_edu_id = db.Column(db.String(20), nullable=False)  # 取消 unique 限制
    school_code = db.Column(db.String(6), nullable=False)
    index_id = db.Column(db.String(40), unique=True, nullable=False)  # 自动生成唯一索引字段
    name = db.Column(db.String(50), nullable=False)
    vision_left = db.Column(db.Float, nullable=False)
    vision_right = db.Column(db.Float, nullable=False)
    myopia_level = db.Column(db.String(10))  # 自动计算字段

    def __init__(self, full_edu_id, school_code, name, vision_left, vision_right, myopia_level=None):
        self.full_edu_id = full_edu_id
        self.school_code = school_code
        self.name = name
        self.vision_left = vision_left
        self.vision_right = vision_right
        self.myopia_level = myopia_level
        # 自动生成 index_id，格式为：学校代码 + '_' + full_edu_id
        self.index_id = f"{school_code}_{full_edu_id}"

    def __repr__(self):
        return f'<Student {self.name}>'
```

**student.py** (位于 `src/context_system/core/models/student.py`)

```python
# src/context_system/core/models/student.py
"""
student.py

功能说明：
    定义学生数据模型，包括学生基本信息和视力数据。
    根据最新需求：
      - full_edu_id 字段不再作为唯一索引（取消 unique 限制）。
      - 系统自动生成唯一的索引字段 index_id，其格式为：学校代码 + '_' + full_edu_id。

使用说明：
    本模块使用 SQLAlchemy 定义 ORM 模型，用于数据库操作。
    请不要直接运行此文件，应通过 app.py 启动应用，并确保 PYTHONPATH
    已正确配置以包含项目根目录。
"""

from sqlalchemy import Column, Integer, String, Float
from src.context_system.infrastructure.database import db

class Student(db.Model):
    """学生数据模型类，用于存储学生基本信息和视力数据。"""
    __tablename__ = 'students'
    id = Column(Integer, primary_key=True)
    full_edu_id = Column(String(20), nullable=False)
    school_code = Column(String(6), nullable=False)
    index_id = Column(String(40), unique=True, nullable=False)
    name = Column(String(50), nullable=False)
    vision_left = Column(Float, nullable=False)
    vision_right = Column(Float, nullable=False)
    myopia_level = Column(String(10))

    def __init__(self, full_edu_id, school_code, name, vision_left, vision_right, myopia_level=None):
        self.full_edu_id = full_edu_id
        self.school_code = school_code
        self.name = name
        self.vision_left = vision_left
        self.vision_right = vision_right
        self.myopia_level = myopia_level
        self.index_id = f"{school_code}_{full_edu_id}"

    def to_dict(self):
        """返回学生数据的字典表示"""
        return {
            "id": self.id,
            "full_edu_id": self.full_edu_id,
            "index_id": self.index_id,
            "school_code": self.school_code,
            "name": self.name,
            "vision_left": self.vision_left,
            "vision_right": self.vision_right,
            "myopia_level": self.myopia_level
        }
```

------

#### 3.1.3 学生数据录入 API（student_api.py）

- **功能**：
  - 接受前端提交的学生数据（JSON 格式），验证必填字段后写入数据库；
  - 出现错误时回滚事务，并返回错误信息。
- **最终代码**：

```python
# src/context_system/api/endpoints/student_api.py
"""
student_api.py

该模块实现了学生数据录入的 API 接口。
功能说明：
1. 接受前端提交的学生数据（JSON格式）。
2. 进行必填字段校验（教育ID号、姓名、学校代码、左眼视力、右眼视力）。
3. 将数据存入数据库，并返回操作结果（成功或失败）。
"""

from flask import Blueprint, request, jsonify
from sqlalchemy.exc import SQLAlchemyError
from src.context_system.core.models.student import Student
from src.context_system.infrastructure.database import db

student_api = Blueprint('student_api', __name__)

@student_api.route('/api/student/add', methods=['POST'])
def add_student():
    data = request.get_json()
    if not data.get("full_edu_id") or not data.get("name") or not data.get("school_code") or \
       data.get("vision_left") is None or data.get("vision_right") is None:
        return jsonify({"error": "必填字段缺失"}), 400
    try:
        student = Student(
            full_edu_id=data["full_edu_id"],
            school_code=data["school_code"],
            name=data["name"],
            vision_left=data["vision_left"],
            vision_right=data["vision_right"],
            myopia_level=None
        )
        db.session.add(student)
        db.session.commit()
        return jsonify({"message": "录入成功", "id": student.id}), 201
    except SQLAlchemyError as e:
        db.session.rollback()
        return jsonify({"error": f"数据库错误: {str(e)}"}), 500
    except (RuntimeError, KeyError) as e:
        return jsonify({"error": f"运行时错误: {str(e)}"}), 500
```

------

#### 3.1.4 数据查询 API（query_api.py）

- **功能**：
  - 根据学生姓名进行模糊查询，支持分页查询，返回当前页数据和总记录数，数据格式为 JSON。
- **最终代码**：

```python
# src/context_system/api/endpoints/query_api.py
"""
query_api.py

该模块实现了学生数据查询的 API 接口。
功能说明：
1. 根据学生姓名进行模糊查询。
2. 支持分页查询，返回当前页数据及总记录数。
3. 返回数据格式为 JSON。
"""

from flask import Blueprint, request, jsonify
from src.context_system.core.models.student import Student

query_api = Blueprint('query_api', __name__)

@query_api.route('/api/students/query', methods=['GET'])
def query_students():
    name = request.args.get("name", "")
    page = request.args.get("page", 1, type=int)
    per_page = request.args.get("per_page", 10, type=int)
    query = Student.query.filter(Student.name.ilike(f"%{name}%"))
    pagination = query.paginate(page=page, per_page=per_page, error_out=False)
    students = [student.to_dict() for student in pagination.items]
    return jsonify({
        "students": students,
        "total": pagination.total,
        "page": page,
        "per_page": per_page
    })
```

------

#### 3.1.5 电子表格导入 API（import_api.py）

- **功能**：
  - 接受上传的 Excel 文件（.xlsx），使用 Pandas 解析数据；
  - 将 Excel 文件中的列名映射为内部字段名（例如“教育ID号”映射为“edu_id”等），并根据后台预设的学校名称映射将“学校”转换为后台“学校ID”；
  - 校验必填字段（edu_id, name, school_code, vision_left, vision_right），将数据存入数据库，返回成功导入的记录数；对于导入失败的记录生成 xlsx 格式的导入失败表格（后续功能，此处已实现基本校验与导入）。
- **最终代码**：

```python
# src/context_system/api/endpoints/import_api.py
"""
import_api.py

功能说明：
    提供电子表格数据导入功能。
    接收上传的 Excel 文件 (.xlsx)，使用 Pandas 解析文件，
    并将 Excel 文件中列名称映射为系统内部字段名称：
        "教育ID号" -> "edu_id"
        "学校" -> "school_code"
        "姓名" -> "name"
        "左眼-裸眼视力" -> "vision_left"
        "右眼-裸眼视力" -> "vision_right"
    同时，通过后台预设的学校名称映射，将 Excel 文件中“学校”列
    转换为后台设置的“学校ID”，赋值给内部字段 school_code，映射规则如下：
        苏宁红军小学校： "001"
        师大附小清华小学校： "002"
        华兴小学校： "003"
    校验必填字段（edu_id, name, school_code, vision_left, vision_right），
    将符合要求的数据存入数据库，并返回导入成功的记录条数或错误信息。
    注意：后台维护的“学校ID”不在 Excel 文件中，由系统根据学校名称自动确定。

使用说明：
    API 接口 URL: /api/students/import
    请求方法: POST
    请求内容类型: multipart/form-data
    参数: file（上传的 .xlsx 文件）
"""

import os
import pandas as pd
from flask import Blueprint, request, jsonify
from werkzeug.utils import secure_filename

from src.context_system.core.models.student import Student
from src.context_system.infrastructure.database import db

ALLOWED_EXTENSIONS = {'xlsx'}

# 定义 Excel 列名称到内部字段名称的映射字典
COLUMN_MAPPING = {
    "教育ID号": "edu_id",
    "学校": "school_code",
    "姓名": "name",
    "左眼-裸眼视力": "vision_left",
    "右眼-裸眼视力": "vision_right"
}

# 定义学校名称到后台设置学校ID的映射字典
SCHOOL_MAPPING = {
    "苏宁红军小学校": "001",
    "师大附小清华小学校": "002",
    "华兴小学校": "003"
}

def allowed_file(filename):
    """检查文件是否为允许的扩展名"""
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

import_api = Blueprint('import_api', __name__)

@import_api.route('/api/students/import', methods=['POST'])
def import_students():
    """
    电子表格导入 API 接口
    接收上传的 Excel 文件，使用 Pandas 解析文件，
    重命名列以匹配系统内部字段名称，并根据后台预设
    的学校映射将 Excel 中的学校名称转换为后台学校ID，
    校验必填字段，并将符合要求的数据存入数据库，
    返回导入成功的记录条数。
    """
    if 'file' not in request.files:
        return jsonify({"error": "未找到上传文件"}), 400

    file = request.files['file']
    if file.filename == '':
        return jsonify({"error": "未选择文件"}), 400

    if file and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        filepath = os.path.join(os.getcwd(), filename)
        file.save(filepath)
        try:
            df = pd.read_excel(filepath)
            df.rename(columns=COLUMN_MAPPING, inplace=True)
            required_columns = ['edu_id', 'name', 'school_code', 'vision_left', 'vision_right']
            missing_columns = [col for col in required_columns if col not in df.columns]
            if missing_columns:
                return jsonify({"error": f"缺少必填字段：{', '.join(missing_columns)}"}), 400

            imported_count = 0
            for _, row in df.iterrows():
                # 检查必填字段
                if (pd.isna(row['edu_id']) or pd.isna(row['name']) or
                    pd.isna(row['school_code']) or pd.isna(row['vision_left']) or
                    pd.isna(row['vision_right'])):
                    continue

                backend_school_code = SCHOOL_MAPPING.get(str(row['school_code']).strip())
                if not backend_school_code:
                    continue

                student = Student(
                    full_edu_id=str(row['edu_id']),
                    school_code=backend_school_code,
                    name=str(row['name']),
                    vision_left=float(row['vision_left']),
                    vision_right=float(row['vision_right']),
                    myopia_level=None
                )
                db.session.add(student)
                imported_count += 1

            db.session.commit()
            os.remove(filepath)
            return jsonify({"message": "导入成功", "imported_count": imported_count}), 200
        except Exception as e:
            db.session.rollback()
            return jsonify({"error": f"文件处理错误: {str(e)}"}), 500
    else:
        return jsonify({"error": "不支持的文件格式，请上传 .xlsx 文件"}), 400
```

------

#### 3.1.6 统计分析 API（analysis_api.py）

- **功能**：
  - 调用后端统计函数，返回学生总数、平均左眼视力及平均右眼视力等统计数据。
- **最终代码**：

```python
# src/context_system/api/endpoints/analysis_api.py
"""
analysis_api.py

功能说明：
    提供统计分析 API 接口，用于根据数据库中学生数据生成统计数据。
    返回学生总数、平均左眼视力和平均右眼视力等指标。

使用说明：
    API 接口 URL: /api/analysis/statistics
    请求方法: GET
"""

from flask import Blueprint, jsonify
from sqlalchemy import func
from sqlalchemy.exc import SQLAlchemyError
from src.context_system.core.models.student import Student
from src.context_system.infrastructure.database import db

analysis_api = Blueprint('analysis_api', __name__)

@analysis_api.route('/api/analysis/statistics', methods=['GET'])
def statistics():
    try:
        total_students = Student.query.count()
        avg_vision_left = db.session.query(func.avg(Student.vision_left)).scalar() or 0
        avg_vision_right = db.session.query(func.avg(Student.vision_right)).scalar() or 0

        result = {
            "total_students": total_students,
            "average_vision_left": round(avg_vision_left, 2),
            "average_vision_right": round(avg_vision_right, 2)
        }
        return jsonify(result), 200
    except SQLAlchemyError as e:
        return jsonify({"error": f"统计分析错误: {str(e)}"}), 500
```

------

### 3.2 前端模块

#### 3.2.1 数据录入页面（data_entry.html）

- **功能**：
  - 提供表单录入学生数据，使用 AJAX 提交数据至后端录入 API。
- **最终代码**：

```html
<!-- data_entry.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>数据录入</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>学生数据录入</h2>
        <form id="entryForm">
            <div class="mb-3">
                <label for="full_edu_id" class="form-label">教育ID号</label>
                <input type="text" class="form-control" id="full_edu_id" name="full_edu_id" placeholder="请输入教育ID号" required>
            </div>
            <div class="mb-3">
                <label for="name" class="form-label">姓名</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="请输入学生姓名" required>
            </div>
            <div class="mb-3">
                <label for="school_code" class="form-label">学校代码</label>
                <input type="text" class="form-control" id="school_code" name="school_code" placeholder="请输入学校代码" required>
            </div>
            <div class="mb-3">
                <label for="vision_left" class="form-label">左眼视力</label>
                <input type="number" step="0.1" class="form-control" id="vision_left" name="vision_left" placeholder="请输入左眼视力" required>
            </div>
            <div class="mb-3">
                <label for="vision_right" class="form-label">右眼视力</label>
                <input type="number" step="0.1" class="form-control" id="vision_right" name="vision_right" placeholder="请输入右眼视力" required>
            </div>
            <button type="submit" class="btn btn-primary">提交</button>
        </form>
        <div id="result" class="mt-3"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $("#entryForm").submit(function(event) {
            event.preventDefault();
            let formData = {
                full_edu_id: $("#full_edu_id").val(),
                name: $("#name").val(),
                school_code: $("#school_code").val(),
                vision_left: parseFloat($("#vision_left").val()),
                vision_right: parseFloat($("#vision_right").val())
            };
            $.ajax({
                url: "http://127.0.0.1:5000/api/student/add",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(formData),
                success: function(response) {
                    $("#result").html("<div class='alert alert-success'>录入成功，ID：" + response.id + "</div>");
                },
                error: function(xhr) {
                    let errorMsg = "录入失败";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += "：" + xhr.responseJSON.error;
                    }
                    $("#result").html("<div class='alert alert-danger'>" + errorMsg + "</div>");
                }
            });
        });
    </script>
</body>
</html>
```

------

#### 3.2.2 数据查询页面（data_query.html）

- **功能**：
  - 提供查询表单（按姓名模糊查询、分页），使用 AJAX 调用后端查询 API，并在页面显示查询结果表格。
- **最终代码**：

```html
<!-- data_query.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- 添加 viewport meta 标签确保移动设备上良好显示 -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>数据查询</title>
    <!-- 引入 Bootstrap 样式表 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>学生数据查询</h2>
        <form id="queryForm" class="row g-3">
            <div class="col-md-4">
                <label for="name" class="form-label">姓名</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="请输入姓名进行查询">
            </div>
            <div class="col-md-2">
                <label for="page" class="form-label">页码</label>
                <input type="number" class="form-control" id="page" name="page" value="1" min="1">
            </div>
            <div class="col-md-2">
                <label for="per_page" class="form-label">每页数量</label>
                <input type="number" class="form-control" id="per_page" name="per_page" value="10" min="1">
            </div>
            <div class="col-md-4 align-self-end">
                <button type="submit" class="btn btn-primary">查询</button>
            </div>
        </form>
        <div id="result" class="mt-4"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $("#queryForm").submit(function(event) {
            event.preventDefault();
            let name = $("#name").val();
            let page = $("#page").val();
            let per_page = $("#per_page").val();
            let queryUrl = "http://127.0.0.1:5000/api/students/query";
            $.ajax({
                url: queryUrl,
                type: "GET",
                data: {
                    name: name,
                    page: page,
                    per_page: per_page
                },
                success: function(response) {
                    let students = response.students;
                    let total = response.total;
                    let html = `<h4>查询结果 (共 ${total} 条记录)</h4>`;
                    if (students.length > 0) {
                        html += "<table class='table table-bordered'>";
                        html += "<thead><tr><th>ID</th><th>教育ID号</th><th>姓名</th></tr></thead><tbody>";
                        $.each(students, function(index, student) {
                            html += `<tr>
                                        <td>${student.id}</td>
                                        <td>${student.full_edu_id}</td>
                                        <td>${student.name}</td>
                                     </tr>`;
                        });
                        html += "</tbody></table>";
                    } else {
                        html += "<div class='alert alert-info'>没有查询到相关数据</div>";
                    }
                    $("#result").html(html);
                },
                error: function(xhr) {
                    let errorMsg = "查询失败";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += "：" + xhr.responseJSON.error;
                    }
                    $("#result").html("<div class='alert alert-danger'>" + errorMsg + "</div>");
                }
            });
        });
    </script>
</body>
</html>
```

------

#### 3.2.3 电子表格导入页面（data_import.html）

- **功能**：
  - 支持上传 .xlsx 文件，使用 AJAX 调用后端导入 API，实现数据批量导入；
  - 导入失败的记录生成 xlsx 文件导出（目前已实现导入成功与失败提示）。
- **最终代码**：

```html
<!-- data_import.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>电子表格数据导入</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h2>电子表格数据导入</h2>
        <form id="importForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="excelFile" class="form-label">选择 Excel 文件 (.xlsx)</label>
                <input type="file" class="form-control" id="excelFile" name="file" accept=".xlsx" required>
            </div>
            <button type="submit" class="btn btn-primary">上传并导入</button>
        </form>
        <div id="importResult" class="mt-3"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $("#importForm").submit(function(event) {
            event.preventDefault();
            let formData = new FormData();
            let file = $("#excelFile")[0].files[0];
            formData.append("file", file);
            $.ajax({
                url: "http://127.0.0.1:5000/api/students/import",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $("#importResult").html("<div class='alert alert-success'>导入成功，记录数：" + response.imported_count + "</div>");
                },
                error: function(xhr) {
                    let errorMsg = "导入失败";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += "：" + xhr.responseJSON.error;
                    }
                    $("#importResult").html("<div class='alert alert-danger'>" + errorMsg + "</div>");
                }
            });
        });
    </script>
</body>
</html>
```

------

#### 3.2.4 综合查询与统计分析页面（dashboard.html）

- **功能与要求**：
  - 左侧“综合信息”菜单：
    - 悬停时显示已选字段摘要（支持滚动）；
    - 点击后展开四个二级子菜单（基本信息、健康信息、干预前视力、干预后视力），并在各子菜单下显示复选框查询面板，面板内复选框列表支持滚动；
    - 默认复选框状态：基本信息默认选中“姓名”、“性别”、“学校”、“年级”、“班级”，干预前视力默认选中“右眼-裸眼视力”、“左眼-裸眼视力”，干预后视力默认选中“右眼-干预-裸眼视力”、“左眼-干预-裸眼视力”；
    - 点击查询或重置按钮后，查询面板自动收起，同时整合四个子菜单中当前选中的字段，调用后端查询 API 展示统一结果表格（支持横向滚动）；
    - 点击页面其他部分时，二级菜单及查询面板自动收起。
- **最终代码**（最终定稿版本）：

```html
<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 指定字符编码 -->
    <meta charset="UTF-8">
    <!-- 设置 viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>综合查询与统计分析</title>
    <!-- 引入 Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <!-- 引入 Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 整体蓝白扁平化风格 */
        body {
            background-color: #f0f4f8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        header.top-control {
            background-color: #007bff;
            color: #fff;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            z-index: 1200;
        }
        header.top-control .sys-name {
            font-size: 1.4rem;
            font-weight: bold;
        }
        header.top-control .control-buttons {
            display: flex;
            align-items: center;
        }
        header.top-control .control-buttons button {
            margin-left: 10px;
            border: none;
            background: none;
            color: #fff;
            font-size: 1.2rem;
        }
        nav.navbar {
            background-color: #007bff;
            padding: 5px 15px;
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            height: 50px;
            z-index: 1100;
        }
        nav.navbar .container-fluid {
            display: flex;
            justify-content: flex-end;
        }
        /* 左侧菜单 */
        #sidebar {
            background-color: #fff;
            border-right: 1px solid #dee2e6;
            min-height: calc(100vh - 100px);
            transition: width 0.3s ease;
            width: 250px;
            position: fixed;
            top: 100px;
            bottom: 0;
            left: 0;
            z-index: 1000;
        }
        #sidebar .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: #333;
            font-weight: 500;
            cursor: pointer;
        }
        #sidebar .nav-link.active,
        #sidebar .nav-link:hover {
            background-color: #e9f2ff;
            color: #007bff;
        }
        #sidebar .nav-link i {
            font-size: 1.25rem;
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        #sidebar.collapsed .menu-text {
            display: none;
        }
        /* 二级菜单样式 */
        .submenu {
            list-style: none;
            padding-left: 20px;
            display: none;
        }
        .submenu .sub-menu {
            font-size: 0.9rem;
            padding: 5px 15px;
            color: #555;
            cursor: pointer;
        }
        .submenu .sub-menu:hover,
        .submenu .sub-menu.active {
            background-color: #e9f2ff;
            color: #007bff;
        }
        /* “综合信息”悬停面板 */
        #comprehensivePanel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 5px 15px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            position: absolute;
            left: 15px;
            right: 15px;
            z-index: 1050;
        }
        /* 主内容区域 */
        #content {
            margin-top: 100px;
            margin-left: 250px;
            width: calc(100% - 250px);
            transition: margin-left 0.3s ease, width 0.3s ease;
            padding: 20px;
        }
        #sidebar.collapsed ~ #content {
            margin-left: 60px;
            width: calc(100% - 60px);
        }
        /* 查询/统计结果区域 */
        #resultsArea {
            background-color: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1200px;
            text-align: center;
            width: 100%;
            overflow-x: auto;
        }
        /* 加载动画 */
        #loadingSpinner {
            display: none;
            text-align: center;
            padding: 50px;
        }
        /* 小屏幕设置 */
        @media (max-width: 768px) {
            #sidebar {
                top: 100px;
                transform: translateX(-250px);
                transition: transform 0.3s ease;
            }
            #sidebar.show {
                transform: translateX(0);
            }
            #content {
                margin-left: 0;
                width: 100%;
            }
        }
        /* 查询面板样式 */
        .query-panel {
            background-color: #fff;
            padding: 10px 15px;
            border-top: 1px solid #dee2e6;
            display: none;
        }
        .field-list-container {
            max-height: 200px;
            overflow-y: auto;
        }
        .query-panel .field-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .query-panel .field-item {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- 顶部固定控制栏 -->
    <header class="top-control">
        <div class="d-flex align-items-center">
            <button class="btn btn-primary d-md-none me-2" id="sidebarToggleMobile" title="切换菜单">
                <i class="fa-solid fa-bars"></i>
            </button>
            <span class="sys-name">近视预防干预系统</span>
        </div>
        <div class="control-buttons d-flex align-items-center">
            <button id="btn-fullscreen" title="全屏">
                <i class="fa-solid fa-expand"></i>
            </button>
            <button id="btn-refresh" title="刷新">
                <i class="fa-solid fa-arrow-rotate-right"></i>
            </button>
            <button id="btn-notification" title="通知">
                <i class="fa-solid fa-bell"></i>
            </button>
            <div class="dropdown">
                <button class="btn btn-outline-light dropdown-toggle" type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    未登录
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuButton">
                    <li><a class="dropdown-item" href="#">登录</a></li>
                    <li><a class="dropdown-item" href="#">个人中心</a></li>
                    <li><a class="dropdown-item" href="#">退出登录</a></li>
                </ul>
            </div>
        </div>
    </header>

    <!-- 顶部蓝色导航部分 -->
    <nav class="navbar">
        <div class="container-fluid">
            <div id="topQuery">
                <!-- 默认查询面板 -->
                <div id="queryPanel-default" class="query-panel">
                    <h6 id="defaultQueryTitle"></h6>
                    <div class="row g-2 align-items-center justify-content-end">
                        <div class="col-auto">
                            <select class="form-select" id="q_default" title="请选择查询条件">
                                <option value="all">全部</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" id="btn-query-default">查询</button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-secondary" id="btn-reset-default">重置</button>
                        </div>
                    </div>
                </div>
                <!-- 首页查询面板 -->
                <div id="queryPanel-home" class="query-panel">
                    <!-- 首页直接显示统计信息 -->
                </div>
            </div>
        </div>
    </nav>

    <!-- 小屏幕左侧菜单折叠按钮 -->
    <div id="sidebarToggleWrapper" class="d-md-none">
        <button class="btn btn-outline-light" id="sidebarToggle" title="切换菜单" aria-label="切换菜单">
            <i class="fa-solid fa-bars"></i>
        </button>
    </div>

    <!-- 左侧菜单 -->
    <nav id="sidebar">
        <div class="position-sticky">
            <div class="d-none d-md-block text-end mb-2">
                <button class="btn btn-sm btn-outline-primary" id="sidebarToggleDesktop" title="折叠菜单" aria-label="折叠菜单">
                    <i class="fa-solid fa-angle-double-left"></i>
                </button>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="home">
                        <i class="fa-solid fa-house"></i>
                        <span class="menu-text">首页</span>
                    </a>
                </li>
                <!-- 综合信息菜单 -->
                <li class="nav-item" id="li-comprehensive">
                    <a class="nav-link" href="#" data-menu="comprehensive" id="menu-comprehensive">
                        <i class="fa-solid fa-layer-group"></i>
                        <span class="menu-text">综合信息</span>
                        <i class="fa-solid fa-caret-down ms-auto"></i>
                    </a>
                    <!-- 二级菜单 -->
                    <ul class="submenu" id="submenu-comprehensive">
                        <li class="nav-item"><a class="nav-link sub-menu" href="#" data-submenu="basicInfo">基本信息</a></li>
                        <li class="nav-item"><a class="nav-link sub-menu" href="#" data-submenu="healthInfo">健康信息</a></li>
                        <li class="nav-item"><a class="nav-link sub-menu" href="#" data-submenu="preVision">干预前视力</a></li>
                        <li class="nav-item"><a class="nav-link sub-menu" href="#" data-submenu="postVision">干预后视力</a></li>
                    </ul>
                    <!-- 悬停面板：显示当前默认选中字段摘要 -->
                    <div id="comprehensivePanel"></div>
                    <!-- 查询面板区域（各子菜单对应） -->
                    <div id="panel-basicInfo" class="query-panel">
                        <div class="field-list-container">
                            <div class="field-list" id="fields-basicInfo"></div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary" id="btn-query-basicInfo">查询</button>
                            <button class="btn btn-secondary" id="btn-reset-basicInfo">重置</button>
                            <button class="btn btn-success" id="btn-export-basicInfo">导出</button>
                        </div>
                    </div>
                    <div id="panel-healthInfo" class="query-panel">
                        <div class="field-list-container">
                            <div class="field-list" id="fields-healthInfo"></div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary" id="btn-query-healthInfo">查询</button>
                            <button class="btn btn-secondary" id="btn-reset-healthInfo">重置</button>
                            <button class="btn btn-success" id="btn-export-healthInfo">导出</button>
                        </div>
                    </div>
                    <div id="panel-preVision" class="query-panel">
                        <div class="field-list-container">
                            <div class="field-list" id="fields-preVision"></div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary" id="btn-query-preVision">查询</button>
                            <button class="btn btn-secondary" id="btn-reset-preVision">重置</button>
                            <button class="btn btn-success" id="btn-export-preVision">导出</button>
                        </div>
                    </div>
                    <div id="panel-postVision" class="query-panel">
                        <div class="field-list-container">
                            <div class="field-list" id="fields-postVision"></div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary" id="btn-query-postVision">查询</button>
                            <button class="btn btn-secondary" id="btn-reset-postVision">重置</button>
                            <button class="btn btn-success" id="btn-export-postVision">导出</button>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="schoolCount">
                        <i class="fa-solid fa-school"></i>
                        <span class="menu-text">学校数量</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="classCount">
                        <i class="fa-solid fa-layer-group"></i>
                        <span class="menu-text">班级数量</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="studentCount">
                        <i class="fa-solid fa-user-graduate"></i>
                        <span class="menu-text">学生数量</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="vision">
                        <i class="fa-solid fa-eye"></i>
                        <span class="menu-text">视力数据</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="intervEffect">
                        <i class="fa-solid fa-hand-holding-medical"></i>
                        <span class="menu-text">干预效果</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-menu="intervTimes">
                        <i class="fa-solid fa-calendar-check"></i>
                        <span class="menu-text">干预次数</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <main id="content">
        <div id="resultsArea">
            <h3 class="text-center">查询/统计结果</h3>
            <div id="resultsContent">
                <p>请在上方选择查询条件或统计功能...</p>
            </div>
        </div>
        <div id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    </main>

    <!-- 引入 Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // 定义二级菜单对应的字段列表
        var fieldsMap = {
            basicInfo: [
                "教育ID号", "学校", "学校ID", "年级", "班级", "姓名", "性别", "年龄", "出生日期",
                "联系电话", "身份证", "区域", "联系地址", "家长姓名", "家长电话", "索引ID"
            ],
            healthInfo: [
                "身高", "体重", "饮食偏好", "运动偏好", "健康教育", "既往史", "家族史", "是否早产",
                "过敏史", "矫正方式", "矫正方式类型"
            ],
            preVision: [
                "右眼-裸眼视力", "左眼-裸眼视力", "右眼-矫正视力", "左眼-矫正视力", "右眼-角膜曲率K1", "左眼-角膜曲率K1",
                "右眼-角膜曲率K2", "左眼-角膜曲率K2", "右眼-眼轴", "左眼-眼轴", "右眼屈光-球镜", "左眼屈光-球镜",
                "右眼屈光-柱镜", "左眼屈光-柱镜", "右眼屈光-轴位", "左眼屈光-轴位", "右眼散瞳-球镜", "左眼散瞳-球镜",
                "右眼散瞳-柱镜", "左眼散瞳-柱镜", "右眼散瞳-轴位", "左眼散瞳-轴位", "右眼-前房深度", "左眼-前房深度",
                "其他情况", "眼疲劳状况"
            ],
            postVision: [
                "右眼-干预-裸眼视力", "左眼-干预-裸眼视力", "右眼屈光-干预-球镜", "右眼屈光-干预-柱镜", "右眼屈光-干预-轴位",
                "左眼屈光-干预-球镜", "左眼屈光-干预-柱镜", "左眼屈光-干预-轴位", "右眼散瞳-干预-球镜",
                "右眼散瞳-干预-柱镜", "右眼散瞳-干预-轴位", "左眼散瞳-干预-球镜", "左眼散瞳-干预-柱镜",
                "左眼散瞳-干预-轴位"
            ]
        };

        // 定义默认选中字段
        var defaultSelected = {
            basicInfo: ["姓名", "性别", "学校", "年级", "班级"],
            healthInfo: [],
            preVision: ["右眼-裸眼视力", "左眼-裸眼视力"],
            postVision: ["右眼-干预-裸眼视力", "左眼-干预-裸眼视力"]
        };

        // 更新悬停面板显示
        function updateComprehensivePanel() {
            var summary = [];
            summary = summary.concat(defaultSelected.basicInfo, defaultSelected.preVision, defaultSelected.postVision);
            var html = "<strong>当前选中字段：</strong><ul class='list-unstyled mb-0'>";
            summary.forEach(function(item) {
                html += "<li>" + item + "</li>";
            });
            html += "</ul>";
            $("#comprehensivePanel").html(html);
        }

        // 页面初始化：隐藏所有查询面板，默认显示首页
        $(document).ready(function() {
            $(".query-panel").hide();
            showMainPanel("home");
            loadResults("home");
            updateComprehensivePanel();
        });

        // 左侧菜单（除综合信息外）的点击事件
        $("#sidebar a.nav-link").not("#menu-comprehensive").click(function(e) {
            e.preventDefault();
            $("#sidebar a.nav-link").removeClass("active");
            $(this).addClass("active");
            hideAllQueryPanels();
            showMainPanel($(this).data("menu"));
            loadResults($(this).data("menu"));
        });

        // “综合信息”菜单悬停事件
        $("#menu-comprehensive").hover(
            function() {
                if (!$("#submenu-comprehensive").is(":visible")) {
                    updateComprehensivePanel();
                    $("#comprehensivePanel").slideDown();
                }
            },
            function() {
                setTimeout(function() {
                    if (!$("#comprehensivePanel").is(":hover")) {
                        $("#comprehensivePanel").slideUp();
                    }
                }, 200);
            }
        );
        $("#comprehensivePanel").hover(
            function() {
                $(this).stop(true, true);
            },
            function() {
                $(this).slideUp();
            }
        );

        // “综合信息”菜单点击事件：展开/收起二级菜单，并隐藏悬停面板
        $("#menu-comprehensive").click(function(e) {
            e.preventDefault();
            $(this).toggleClass("active");
            $("#submenu-comprehensive").slideToggle();
            $("#comprehensivePanel").slideUp();
        });

        // 二级菜单点击事件
        $("#submenu-comprehensive").on("click", ".sub-menu", function(e) {
            e.preventDefault();
            e.stopPropagation();
            $("#submenu-comprehensive .sub-menu").removeClass("active");
            $(this).addClass("active");
            var subType = $(this).data("submenu");
            console.log("sub-menu clicked: " + subType);
            showQueryPanel(subType);
        });

        // 隐藏所有综合信息查询面板
        function hideAllQueryPanels() {
            $("#panel-basicInfo, #panel-healthInfo, #panel-preVision, #panel-postVision, #queryPanel-home, #queryPanel-default").slideUp();
        }

        // 显示默认查询面板（用于首页等非综合信息菜单）
        function showMainPanel(menuType) {
            hideAllQueryPanels();
            if (menuType === "home") {
                $("#queryPanel-home").slideDown();
            } else {
                $("#queryPanel-default").slideDown();
                $("#defaultQueryTitle").text(getMenuTitle(menuType) + "查询");
            }
        }

        // 根据二级菜单名称显示对应的查询面板
        function showQueryPanel(panel) {
            hideAllQueryPanels();
            if (panel === "basicInfo") {
                $("#panel-basicInfo").slideDown();
                generateCheckboxes("fields-basicInfo", fieldsMap.basicInfo, defaultSelected.basicInfo);
            } else if (panel === "healthInfo") {
                $("#panel-healthInfo").slideDown();
                generateCheckboxes("fields-healthInfo", fieldsMap.healthInfo, defaultSelected.healthInfo);
            } else if (panel === "preVision") {
                $("#panel-preVision").slideDown();
                generateCheckboxes("fields-preVision", fieldsMap.preVision, defaultSelected.preVision);
            } else if (panel === "postVision") {
                $("#panel-postVision").slideDown();
                generateCheckboxes("fields-postVision", fieldsMap.postVision, defaultSelected.postVision);
            }
        }

        // 根据菜单类型返回对应的标题
        function getMenuTitle(menuType) {
            var titles = {
                "schoolCount": "学校数量",
                "classCount": "班级数量",
                "studentCount": "学生数量",
                "vision": "视力数据",
                "intervEffect": "干预效果",
                "intervTimes": "干预次数"
            };
            return titles[menuType] || "";
        }

        // 动态生成复选框列表
        function generateCheckboxes(panelId, fieldsArray, selectedDefaults) {
            var container = $("#" + panelId);
            container.empty();
            fieldsArray.forEach(function(field) {
                var checked = (selectedDefaults.indexOf(field) !== -1) ? "checked" : "";
                var checkbox = $('<label class="field-item me-3"><input type="checkbox" class="field-checkbox" value="' + field + '" ' + checked + '> ' + field + '</label>');
                container.append(checkbox);
            });
        }

        // 绑定查询按钮事件：查询后整合所有选中字段，然后收起当前查询面板
        $("#btn-query-basicInfo").click(function() {
            queryComprehensive();
            $("#panel-basicInfo").slideUp();
        });
        $("#btn-query-healthInfo").click(function() {
            queryComprehensive();
            $("#panel-healthInfo").slideUp();
        });
        $("#btn-query-preVision").click(function() {
            queryComprehensive();
            $("#panel-preVision").slideUp();
        });
        $("#btn-query-postVision").click(function() {
            queryComprehensive();
            $("#panel-postVision").slideUp();
        });

        // 绑定重置按钮事件：恢复默认后收起当前查询面板
        $("#btn-reset-basicInfo").click(function() {
            generateCheckboxes("fields-basicInfo", fieldsMap.basicInfo, defaultSelected.basicInfo);
            $("#panel-basicInfo").slideUp();
        });
        $("#btn-reset-healthInfo").click(function() {
            generateCheckboxes("fields-healthInfo", fieldsMap.healthInfo, defaultSelected.healthInfo);
            $("#panel-healthInfo").slideUp();
        });
        $("#btn-reset-preVision").click(function() {
            generateCheckboxes("fields-preVision", fieldsMap.preVision, defaultSelected.preVision);
            $("#panel-preVision").slideUp();
        });
        $("#btn-reset-postVision").click(function() {
            generateCheckboxes("fields-postVision", fieldsMap.postVision, defaultSelected.postVision);
            $("#panel-postVision").slideUp();
        });

        // 综合信息查询：整合所有子菜单中选中的字段后查询
        function queryComprehensive() {
            var selectedFields = [];
            $(".field-checkbox:checked").each(function() {
                var field = $(this).val();
                if (selectedFields.indexOf(field) === -1) {
                    selectedFields.push(field);
                }
            });
            $.ajax({
                url: "http://127.0.0.1:5000/api/students/query",
                type: "GET",
                data: { name: "" },
                success: function(response) {
                    var html = "<table class='table table-bordered' style='width:100%;'><thead><tr>";
                    selectedFields.forEach(function(field) {
                        html += "<th>" + field + "</th>";
                    });
                    html += "</tr></thead><tbody>";
                    $.each(response.students, function(index, student) {
                        html += "<tr>";
                        selectedFields.forEach(function(field) {
                            var value = student[field] || "N/A";
                            html += "<td>" + value + "</td>";
                        });
                        html += "</tr>";
                    });
                    html += "</tbody></table>";
                    $("#resultsContent").html(html).fadeIn();
                    $("#loadingSpinner").hide();
                },
                error: function(xhr) {
                    $("#resultsContent").html("<div class='alert alert-danger'>获取综合信息数据失败</div>").fadeIn();
                    $("#loadingSpinner").hide();
                }
            });
        }

        // 默认查询面板按钮事件（模拟）
        $("#btn-query-default").click(function() {
            loadResults($("#sidebar a.nav-link.active").data("menu"));
        });
        $("#btn-reset-default").click(function() {
            alert("重置查询条件（待实现）");
        });

        // 加载结果函数（首页及其他菜单使用）
        function loadResults(menuType) {
            $("#resultsContent").hide();
            $("#loadingSpinner").show();
            if (menuType === "home") {
                $.ajax({
                    url: "http://127.0.0.1:5000/api/analysis/statistics",
                    type: "GET",
                    success: function(response) {
                        var html = "<table class='table table-bordered' style='width:100%;'><tr>";
                        html += "<th>指标</th><th>数值</th></tr>";
                        html += "<tr><td>学生总数</td><td>" + response.total_students + "</td></tr>";
                        html += "<tr><td>平均左眼视力</td><td>" + response.average_vision_left + "</td></tr>";
                        html += "<tr><td>平均右眼视力</td><td>" + response.average_vision_right + "</td></tr>";
                        html += "</table>";
                        $("#resultsContent").html(html).fadeIn();
                        $("#loadingSpinner").hide();
                    },
                    error: function(xhr) {
                        $("#resultsContent").html("<div class='alert alert-danger'>获取统计数据失败</div>").fadeIn();
                        $("#loadingSpinner").hide();
                    }
                });
            } else if (menuType === "schoolCount" ||
                       menuType === "classCount" ||
                       menuType === "studentCount" ||
                       menuType === "vision" ||
                       menuType === "intervEffect" ||
                       menuType === "intervTimes") {
                setTimeout(function() {
                    var html = "<table class='table table-bordered' style='width:100%;'><tr>";
                    html += "<th>指标</th><th>数值</th></tr>";
                    html += "<tr><td>示例指标</td><td>模拟数据</td></tr>";
                    html += "</table>";
                    $("#resultsContent").html(html).fadeIn();
                    $("#loadingSpinner").hide();
                }, 1000);
            }
        }

        // 侧边菜单折叠事件
        $("#sidebarToggle, #sidebarToggleMobile").click(function() {
            $("#sidebar").toggleClass("show");
        });
        $("#sidebarToggleDesktop").click(function() {
            $("#sidebar").toggleClass("collapsed");
        });

        // 刷新、全屏、通知按钮事件
        $("#btn-refresh").click(function() {
            location.reload();
        });
        $("#btn-fullscreen").click(function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                $(this).html('<i class="fa-solid fa-compress"></i>');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    $(this).html('<i class="fa-solid fa-expand"></i>');
                }
            }
        });
        $("#btn-notification").click(function() {
            alert("显示系统通知（待实现）");
        });

        // 点击文档其他部分时收起综合信息二级菜单和查询面板
        $(document).click(function(e) {
            if ($(e.target).closest("#li-comprehensive, .query-panel").length === 0) {
                $("#submenu-comprehensive, .query-panel").slideUp();
                $("#menu-comprehensive").removeClass("active");
            }
        });
    </script>
</body>
</html>
```

------

### 测试与调试说明

1. **二级菜单点击**
   - 打开浏览器 Console，点击“综合信息”子菜单（例如“基本信息”），应在 Console 输出 “sub-menu clicked: basicInfo”。
   - 此时，侧边栏中“综合信息”下对应的查询面板（#panel-basicInfo）应 slideDown() 显示，内含复选框列表（默认仅选中 “姓名”、“性别”、“学校”、“年级”、“班级”）、查询、重置、导出按钮。
2. **查询按钮效果**
   - 点击“查询”按钮后，页面调用后端 `/api/students/query` 接口（条件为空，示例数据），并在主内容区域显示整合所有已选字段的结果表格；同时，当前查询面板应自动 slideUp() 收起。
3. **重置按钮效果**
   - 点击“重置”按钮后，当前查询面板内复选框恢复为默认选中状态，并自动收起。
4. **点击页面其他区域**
   - 点击侧边栏“综合信息”之外的区域时，二级菜单及所有已展开的查询面板应自动收起。
5. **滚动查看**
   - 当复选框列表内容超过容器高度时，“field-list-container”内出现滚动条，确保用户可滚动查看所有选项和按钮。

请将代码更新后测试，若出现“已经隐藏”等提示或无显示，请检查：

- 是否所有查询面板容器（#panel-basicInfo、#panel-healthInfo、#panel-preVision、#panel-postVision）确实在 HTML 中存在；
- Console 是否有错误信息；
- 如果仍有问题，请反馈详细的 Console 日志或截图，以便进一步排查原因。

------

## 七、 关键问题讨论及结论

### 7.1 综合信息查询面板设计

- 讨论要点

  ：

  - 需求要求在左侧“综合信息”菜单中，鼠标悬停时显示一个仅展示当前已选字段摘要的悬停面板；
  - 点击“综合信息”菜单后展开四个二级子菜单，点击任一子菜单后显示对应的查询面板（含复选框列表、查询、重置、导出按钮）；
  - 查询后整合四个子菜单中当前选中的字段，在主内容区展示查询结果表格（支持横向滚动）。

- 关键问题

  ：

  - 复选框默认状态设置为：基本信息默认选中“姓名”、“性别”、“学校”、“年级”、“班级”；干预前视力默认选中“右眼-裸眼视力”、“左眼-裸眼视力”；干预后视力默认选中“右眼-干预-裸眼视力”、“左眼-干预-裸眼视力”。
  - 查询面板的展开/收起行为：查询、重置按钮点击后自动收起当前查询面板；点击页面其他区域自动收起所有综合信息相关面板。

- 讨论结论

  ：

  - 经过多次代码调整，目前侧边栏“综合信息”菜单在悬停和点击时基本满足要求，但查询面板的自动收起、滚动及事件冲突问题仍需通过全局 document click 事件及查询面板容器（设置固定高度和 overflow-y: auto）进行调试和完善。

### 7.2 其他问题讨论

- 关于复选框列表滚动显示、查询结果整合显示以及导出功能（目前仅提示）等问题，均在后续版本中计划进一步完善。
- 下一步将继续完成其他菜单项的功能实现（如学校数量、班级数量、学生数量、视力数据、干预效果、干预次数）。

------

## 八、下一步计划

1. 完善“综合信息”查询面板
   - 解决查询按钮、重置按钮点击后查询面板自动收起的问题；
   - 优化查询结果表格的横向滚动显示效果。
2. 完成其他左侧菜单项功能
   - 开发学校数量、班级数量、学生数量、视力数据、干预效果、干预次数等模块，完善相应查询条件、统计算法及图表展示。
3. 实现数据导出功能
   - 基于当前查询结果导出 Excel 和 PDF 文件功能。
4. 系统联调与优化
   - 对各模块进行整体集成测试、响应式布局优化以及性能和安全性调试。
5. 部署上线准备
   - 配置容器化部署（如 Docker）、云平台迁移以及上线前性能与安全测试。

------

请以此摘要作为我们重新开始对话时了解全部开发工作上下文信息的唯一来源。如有任何补充或修改，请及时更新本摘要。