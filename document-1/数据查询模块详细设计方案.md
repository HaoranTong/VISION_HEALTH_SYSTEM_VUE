# 数据查询模块功能设计方案

## 1. 功能概述

数据查询模块主要分为两个部分：

1. **固定检索查询区域**
   - 该区域位于页面顶部（紧接在顶部导航栏下方）保持两行的宽度，提供常用的快速检索条件，帮助用户快速定位到单个或少量学生记录。
   - 固定检索条件包括：
     - 数据年份
     - 教育ID号
     - 学校
     - 年级
     - 班级
     - 姓名
     - 性别
     - 身份证号码
   - 每个条件输入框支持三种交互方式：
     - **下拉选择**（例如数据年份、学校、年级、班级、性别：选项固定）
     - **模糊输入**：当用户输入部分字符时，下拉自动匹配显示符合条件的选项（适用于姓名）
     - **精确输入**：如身份证号码要求精确匹配（可以先输入后直接过滤）。
   - 检索区域右侧放置“查询”按钮，点击后立即发起查询；放置”清除“按钮，点击后清除所有选择；放置”导出“按钮，点击可以将查询结果导出为电子表格文档；
   - 查询结果显示列内容要能够自由组合，设置一个“列配置”下拉框，下拉框包括里面包括数据库全部字段映射的列中文名称，前面有复选框可以选择或取消选择，还要有一个“全选\取消”选择项
2. **组合查询区域**
   - 用于支持用户自定义任意字段的组合查询。
   - 设计为可折叠/展开的面板：初始状态下默认隐藏，仅在用户点击“展开组合查询”按钮后显示。
   - 用户可在组合查询区域中选择任意数据库字段（例如：年龄区间、视力数据、健康信息等），配置查询条件（区间、精确、模糊等）。
   - 组合查询条件设置灵活，支持多条件组合（AND/OR逻辑），帮助用户筛选出符合复杂条件的一批学生记录。

## 2. 页面结构设计

### 2.1 固定检索查询区域

- 布局

  ：

  - 采用两排布局。
  - 第一排：显示【教育ID号】、【学校】、【年级】、【班级】、【数据年份】等五个条件。
  - 第二排：显示【姓名】、【性别】、【身份证号码】，以及紧邻的全部按钮和列配置下拉框。

- 交互

  ：

  - 对于下拉框类型（数据年份、学校、年级、班级、性别）：直接显示固定选项。
  - 对于姓名输入框：支持用户输入时自动模糊匹配下拉建议（建议基于预先缓存的姓名列表或通过 AJAX 异步查询实现）。
  - 身份证号码输入框为纯文本输入，要求精确匹配，不启用模糊匹配。

### 2.2 组合查询区域

- 布局

  ：

  - 设计为一个折叠面板，初始状态下可隐藏，用户点击展开按钮后显示。
  - 面板内部采用多行网格布局，每行包含一个查询条件组件，用户可以选择字段、选择条件类型（如大于、小于、等于、区间）、日期、文本等输入值。

- 交互

  ：

  - 每个查询条件组件支持下拉选择（字段名称）、条件类型选择（例如：包含、不包含、等于、大于、小于等）、输入框（支持模糊输入）。
  - 用户可以动态添加或删除查询条件。

### 2.3 数据展示区域

- 展示形式

  ：

  - 查询结果以表格形式展示，每一行代表一条学生记录，部分重要字段（如数据年份、教育ID号、姓名、学校、年级、班级、性别、视力等级、部分视力数据及干预效果）默认显示。
  - 表格顶部或侧边提供“列配置”下拉菜单，用户可以选择显示或隐藏某些列。
  - 表格支持排序功能（点击列标题按该列排序）。

- 详情跳转

  ：

  - 用户点击表格中的某一行后，跳转到学生详情页，该页以清晰布局展示该学生的全部信息（可配置哪些字段展示）。

## 3. 技术方案

### 3.1 前端部分

- 使用 HTML5、CSS3 与 JavaScript 实现静态页面。
- 使用前端框架（例如 Vue、React 或基于 jQuery 的方案）实现交互效果：
  - 下拉自动匹配（模糊搜索）可使用开源组件如 Select2 或自定义组件实现。
  - 折叠面板可使用 Bootstrap 的 Collapse 组件或其他轻量 JS 插件实现。
  - 表格展示可以使用 DataTables 等插件支持排序、分页、列选择、导出功能。
- 数据查询页面（query.html）结构示例：
  - 顶部固定区域：固定检索查询条件（两排布局）。
  - 折叠的组合查询面板：动态添加查询条件。
  - 结果展示区：表格展示查询结果，支持导出按钮（例如导出为 Excel 或 PDF）。

### 3.2 后端部分

- 使用 Flask 框架构建 RESTful API：
  - 一个接口用于处理固定检索查询，根据前端传入的参数返回符合条件的学生基本信息和扩展信息。
  - 一个接口用于处理组合查询，解析传入的复杂查询条件，构造 SQLAlchemy 查询，返回符合条件的记录。
  - 查询接口支持分页、排序、过滤等功能。
- 数据库使用 SQLAlchemy ORM 管理，基本信息表（students）和扩展信息表（student_extensions）的模型已经建立。
- 对于查询条件：
  - 后端接收到前端传递的条件（可能为 JSON 格式），解析各个字段、条件类型和值，构造过滤条件（例如 SQLAlchemy 的 filter、filter_by、and_、or_等），执行查询并返回结果。

### 3.3 交互流程

1. 用户访问数据查询页面（/query）。
2. 页面上部显示固定检索条件，用户可直接输入或选择条件后点击“查询”按钮。
3. 如果用户需要更复杂的查询，点击“展开组合查询”，在组合查询面板内配置更多条件后点击“查询”。
4. 后端根据接收到的条件，构造查询，返回符合条件的记录，并在页面中以表格形式显示。
5. 用户可以在表格中进行列配置、排序，并点击某一行进入详细的学生详情页。

------





## 数据查询功能模块开发工作总结摘要

以下是我对数据查询模块当前状态及后续需要完成功能的摘要，请确认：

------

### 一、当前已实现的功能

1. **固定检索查询区域**
   - 页面上部的固定查询条件（例如教育ID号、学校、年级、班级、数据年份、姓名、性别、身份证号码）已实现，支持文本输入、下拉选择等基本交互。
   - 固定查询条件通过 GET 参数传递给后端查询接口（/api/students/query），后端根据条件生成 SQLAlchemy 过滤器并返回分页数据。
   - 查询结果以表格形式展示，并支持分页功能；同时，已有的导出接口可以根据当前查询条件生成 Excel 文件。
2. **前端列配置与动态表格生成**
   - 查询页面（query.html）内置列配置下拉菜单，用户可选择显示哪些数据库字段。
   - 前端 JavaScript（query.js）根据用户选择的列动态构造表头和数据行，实现数据的动态展示。
3. **基本的后端查询接口**
   - 后端模块 query_api.py 已实现基本的查询与导出功能，支持固定条件的组合查询，并对查询结果进行序列化返回。

------

### 二、待开发的功能需求（后续完善部分）

1. **组合查询区域（高级查询）**

   - **页面设计**：
     - 在固定查询区域下方新增一个折叠/展开的高级查询面板（例如按钮标识“展开组合查询”）。
     - 面板内允许用户动态添加多个组合查询条件，每个条件包含：
       - **字段选择**：下拉列表提供所有可查询字段（例如：年龄、视力等级、各项视力数据变化、干预后视力等级等）。
       - **条件类型**：下拉选择支持“等于”、“不等于”、“包含”、“大于”、“小于”、“区间”等操作。
       - **输入方式**：对于“区间”条件提供两个输入框；其他条件使用单个输入框；对于日期、数值字段要支持相应的输入验证。
       - **逻辑组合**：每个条件允许指定与前一个条件之间的逻辑连接符（AND/OR），支持多条件组合。
     - 用户可点击“添加条件”按钮动态增加条件，也可以删除不需要的条件。
   - **前端实现**：
     - 在 query.html 中增加组合查询面板及“展开/收起”按钮；
     - 在 query.js 中增加代码，采集组合查询条件，将其转换为 JSON 格式，并附加在查询接口的 GET 参数中（例如参数名“combination_conditions”）；
     - 同时支持固定查询条件与组合查询条件同时生效。

2. **后端组合查询支持**

   - 解析组合条件

     ：

     - 在 query_api.py 中扩展 build_query() 函数，解析 GET 请求中的组合查询条件 JSON；
     - 为此建立一个字段映射字典（将用户传来的字段名称映射到 Student 或 StudentExtension 的列），并根据条件类型构造相应的 SQLAlchemy 过滤表达式。
     - 支持各种操作（等于、不等于、包含、大于、小于、区间）以及每个条件间的逻辑连接（AND/OR），最终将这些过滤器与固定条件一起组合到查询中。

3. **排序功能**

   - 在查询页面和后端接口中增加排序功能：
     - 前端提供“排序字段”及“排序方式”（升序/降序）的选择控件；
     - 后端解析相应参数（例如 sort_field 与 sort_order），并在构造查询时使用 SQLAlchemy 的 order_by 实现排序。

4. **高级数据展示与交互**

   - 可考虑在查询结果页面中增加功能：
     - 支持表格列拖拽调整顺序；
     - 记忆用户最后一次的组合查询条件；
     - 对错误输入条件给出友好提示。

5. **导出功能扩展**

   - 导出接口也需要支持组合查询和排序条件，确保导出的 Excel 文件与当前前端展示保持一致。

------

### 三、总结

- **目前**：固定查询、分页、列配置、基本导出功能均已实现；
- **待开发**：新增组合查询区域（支持动态添加条件和逻辑组合）、排序功能及高级数据展示交互，同时后端需要扩展组合查询参数的解析，确保固定查询和高级查询条件均能正确作用于数据库过滤。

请确认以上功能需求摘要是否满足您的要求，我们再继续讨论后续代码实现部分。