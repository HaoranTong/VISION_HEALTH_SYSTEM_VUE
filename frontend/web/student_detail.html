#!/usr/bin/env python
# -*- coding: utf-8 -*-
{#
文件名称: student_detail.html
完整存储路径: E:\DEV_CONTEXT\1_Projects\VISION_HEALTH_SYSTEM_VUE\frontend\web\student_detail.html
功能介绍:
    学生详情页用于展示和编辑学生基本信息（Student 表）及扩展信息（StudentExtension 表）。
    页面统一包含左侧导航栏和顶部导航栏，通过 {% include 'sidebar.html' %} 和
    {% include 'topnav.html' %} 引入公共组件。
    页面提供编辑、保存、取消和重新计算功能，并通过 Chart.js 展示部分数据图表。
使用方法:
    启动 Flask 服务后，通过浏览器访问：http://localhost:5000/student_detail.html?id=1
#}
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学生详情 - 近视预防干预系统</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <style>
    body { margin: 0; padding: 0; display: flex; height: 100vh; }
    .main-content { margin-left: 250px; margin-top: 60px; padding: 15px; flex-grow: 1; overflow-y: auto; }
    .section-title { margin-bottom: 15px; }
    .data-table { margin-bottom: 20px; }
  </style>
</head>
<body>
  {% include 'sidebar.html' %}
  {% include 'topnav.html' %}
  <div class="main-content">
    <div class="container" id="detailContent">
      <h1>学生详情</h1>
      <!-- 隐藏字段：存储当前学生ID -->
      <input type="hidden" id="studentId" value="{{ request.args.get('id') }}" />
      <!-- 基本信息区域 -->
      <div id="basicInfoArea">
        <h2 class="section-title">基本信息</h2>
        <div id="basicInfoDisplay"></div>
      </div>
      <!-- 扩展信息区域 -->
      <div id="extensionInfoArea">
        <h2 class="section-title">扩展信息</h2>
        <div id="extensionInfoDisplay"></div>
      </div>
      <!-- 操作按钮区域 -->
      <div id="actionArea" class="mb-4">
        <button id="editBtn" class="btn btn-primary">编辑</button>
        <button id="saveBtn" class="btn btn-success" style="display:none;">保存</button>
        <button id="cancelBtn" class="btn btn-secondary" style="display:none;">取消</button>
        <button id="recalcBtn" class="btn btn-warning">重新计算</button>
      </div>
      <!-- 图表区域 -->
      <div id="chartArea">
        <h2 class="section-title">干预效果（图表展示）</h2>
        <canvas id="effectChart"></canvas>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /**
     * 从 URL 中获取学生ID参数
     * @return {string} 学生ID
     */
    function getStudentIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    /**
     * 生成基本信息 HTML (支持显示和编辑模式)
     * @param {Object} data - 学生基本信息数据
     * @param {boolean} editMode - 是否为编辑模式
     * @return {string} HTML 字符串
     */
    function generateBasicInfoHTML(data, editMode=false) {
      let html = '<table class="table">';
      html += `<tr><th>姓名</th><td>${editMode ? '<input type="text" id="name" value="' + (data.name || '') + '">' : data.name || ''}</td></tr>`;
      html += `<tr><th>年龄</th><td>${editMode ? '<input type="number" id="age" value="' + (data.age || '') + '">' : data.age || ''}</td></tr>`;
      html += `<tr><th>学校</th><td>${data.school_id || ''}</td></tr>`;
      html += `<tr><th>年级</th><td>${editMode ? '<input type="text" id="grade" value="' + (data.grade || '') + '">' : data.grade || ''}</td></tr>`;
      html += `<tr><th>班级</th><td>${editMode ? '<input type="text" id="class_name" value="' + (data.class_name || '') + '">' : data.class_name || ''}</td></tr>`;
      html += `<tr><th>性别</th><td>${editMode ? '<input type="text" id="gender" value="' + (data.gender || '') + '">' : data.gender || ''}</td></tr>`;
      html += `<tr><th>出生日期</th><td>${editMode ? '<input type="date" id="birthday" value="' + (data.birthday || '') + '">' : data.birthday || ''}</td></tr>`;
      html += `<tr><th>联系电话</th><td>${editMode ? '<input type="text" id="phone" value="' + (data.phone || '') + '">' : data.phone || ''}</td></tr>`;
      html += `<tr><th>身份证</th><td>${editMode ? '<input type="text" id="id_card" value="' + (data.id_card || '') + '">' : data.id_card || ''}</td></tr>`;
      html += `<tr><th>家长姓名</th><td>${editMode ? '<input type="text" id="parent_name" value="' + (data.parent_name || '') + '">' : data.parent_name || ''}</td></tr>`;
      html += `<tr><th>家长电话</th><td>${editMode ? '<input type="text" id="parent_phone" value="' + (data.parent_phone || '') + '">' : data.parent_phone || ''}</td></tr>`;
      html += '</table>';
      return html;
    }

    /**
     * 生成扩展信息 HTML (支持显示和编辑模式)
     * @param {Object} data - 学生扩展信息数据
     * @param {boolean} editMode - 是否为编辑模式
     * @return {string} HTML 字符串
     */
    function generateExtensionInfoHTML(data, editMode=false) {
      if (!data) return "<p>暂无扩展信息</p>";
      let html = '<table class="table">';
      html += `<tr><th>区域</th><td>${editMode ? '<input type="text" id="region" value="' + (data.region || '') + '">' : data.region || ''}</td></tr>`;
      html += `<tr><th>饮食偏好</th><td>${editMode ? '<input type="text" id="diet_preference" value="' + (data.diet_preference || '') + '">' : data.diet_preference || ''}</td></tr>`;
      html += `<tr><th>运动偏好</th><td>${editMode ? '<input type="text" id="exercise_preference" value="' + (data.exercise_preference || '') + '">' : data.exercise_preference || ''}</td></tr>`;
      html += `<tr><th>健康教育</th><td>${editMode ? '<input type="text" id="health_education" value="' + (data.health_education || '') + '">' : data.health_education || ''}</td></tr>`;
      // 示例：仅显示第1次干预记录（其他扩展字段可按需求增加）
      html += `<tr><th>第1次干预</th><td>${editMode ? '<input type="datetime-local" id="intervention1" value="' + (data.intervention1 ? data.intervention1.substring(0,16) : '') + '">' : (data.intervention1 || '')}</td></tr>`;
      html += '</table>';
      return html;
    }

    /**
     * 加载学生详情数据，通过调用后端 API 获取数据，并更新页面显示区域
     */
    function loadStudentDetail() {
      const studentId = getStudentIdFromURL();
      if (!studentId) {
        alert("未找到学生ID");
        return;
      }
      document.getElementById("studentId").value = studentId;
      fetch(`/api/students/detail/${studentId}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById("basicInfoDisplay").innerHTML =
            generateBasicInfoHTML(data.student, false);
          document.getElementById("extensionInfoDisplay").innerHTML =
            generateExtensionInfoHTML(data.extension, false);
          updateChart(data);
        })
        .catch(error => console.error("加载学生详情出错:", error));
    }

    /**
     * 使用 Chart.js 更新图表，示例中显示裸眼视力数据
     * @param {Object} data - 学生详情数据
     */
    function updateChart(data) {
      const ctx = document.getElementById('effectChart').getContext('2d');
      const chartData = {
        labels: ['左眼裸眼视力', '右眼裸眼视力'],
        datasets: [{
          label: '裸眼视力',
          data: [data.student.vision_left, data.student.vision_right],
          backgroundColor: ['rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)']
        }]
      };
      new Chart(ctx, {
        type: 'bar',
        data: chartData
      });
    }

    /**
     * 切换至编辑模式，将显示的文本转换为输入框
     */
    function switchToEditMode() {
      const studentId = document.getElementById("studentId").value;
      fetch(`/api/students/detail/${studentId}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById("basicInfoDisplay").innerHTML =
            generateBasicInfoHTML(data.student, true);
          document.getElementById("extensionInfoDisplay").innerHTML =
            generateExtensionInfoHTML(data.extension, true);
          document.getElementById("editBtn").style.display = "none";
          document.getElementById("saveBtn").style.display = "inline-block";
          document.getElementById("cancelBtn").style.display = "inline-block";
        })
        .catch(error => console.error("切换编辑模式出错：", error));
    }

    /**
     * 保存编辑内容（示例，仅显示提示，实际需调用后端更新接口）
     */
    function saveEdits() {
      alert("保存功能待实现");
      cancelEdits();
    }

    /**
     * 取消编辑，恢复显示模式并重新加载数据
     */
    function cancelEdits() {
      loadStudentDetail();
      document.getElementById("editBtn").style.display = "inline-block";
      document.getElementById("saveBtn").style.display = "none";
      document.getElementById("cancelBtn").style.display = "none";
    }

    /**
     * 重新计算扩展字段数据，通过调用后端 API
     * @param {string} studentId - 学生ID
     */
    function recalculateStudent(studentId) {
      fetch(`/api/students/calculate/${studentId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            alert("更新成功：" + data.message);
            loadStudentDetail();
          } else {
            alert("更新失败：" + data.error);
          }
        })
        .catch(error => alert("请求出错：" + error));
    }

    document.addEventListener("DOMContentLoaded", function() {
      loadStudentDetail();
      document.getElementById("editBtn").addEventListener("click", switchToEditMode);
      document.getElementById("saveBtn").addEventListener("click", saveEdits);
      document.getElementById("cancelBtn").addEventListener("click", cancelEdits);
      document.getElementById("recalcBtn").addEventListener("click", function() {
        const studentId = document.getElementById("studentId").value;
        recalculateStudent(studentId);
      });
    });
  </script>
</body>
</html>
