<!--
文件名称: data_import.html
完整存储路径: E:\DEV_CONTEXT\1_Projects\VISION_HEALTH_SYSTEM_VUE\frontend\templates\data_import.html
功能说明:
    数据导入测试页面，支持上传 Excel (.xlsx) 和 CSV (.csv) 文件，提供拖拽与文件选择功能，
    并增加数据年份选择下拉框（从 2023 至未来年份供选择）。上传后显示成功与失败记录，
    失败记录可下载查看错误详情。
使用方法:
    打开页面后，通过下拉框选择数据年份，然后选择或拖拽文件上传。
-->
{% extends "layouts/base.html" %}

{% block title %}数据导入 - 近视预防干预系统{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12 col-md-10 offset-md-1">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h2 class="h4 mb-0">数据导入</h2>
        </div>
        <div class="card-body">
          <p class="text-muted">
            请选择或拖拽要导入的 Excel (.xlsx) 或 CSV (.csv) 文件。上传后将自动校验数据，
            合格记录保存到数据库，失败记录生成“上传失败记录表”供下载查看。
          </p>
          <!-- 数据年份选择下拉框 -->
          <div class="mb-3">
            <label for="dataYearSelect" class="form-label">选择数据年份</label>
            <select id="dataYearSelect" class="form-select">
              {% for year in range(2023, 2031) %}
              <option value="{{ year }}">{{ year }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- 上传区域 -->
          <div id="uploadArea" class="border rounded p-4 mb-4" style="min-height:150px; text-align: center; transition: background 0.3s;">
            <p class="text-muted">拖拽文件到此区域，或点击“选择文件”按钮</p>
            <div id="fileList" class="text-start"></div>
          </div>
          <div class="mb-3 d-flex flex-wrap gap-2">
            <button type="button" id="selectFileBtn" class="btn btn-secondary">
              <i class="bi bi-folder me-2"></i>选择文件
            </button>
            <button type="button" id="cancelBtn" class="btn btn-outline-secondary">
              <i class="bi bi-x me-2"></i>取消上传
            </button>
            <button type="button" id="uploadBtn" class="btn btn-primary">
              <i class="bi bi-upload me-2"></i>上传文件
            </button>
          </div>
          <div id="uploadStatus" class="mt-3"></div>
          <!-- 隐藏的文件输入控件 -->
          <input type="file" id="fileInput" accept=".xlsx,.csv" multiple style="display:none;">
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById('fileInput');
  const selectFileBtn = document.getElementById('selectFileBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileList = document.getElementById('fileList');
  const uploadArea = document.getElementById('uploadArea');
  const uploadStatus = document.getElementById('uploadStatus');
  const dataYearSelect = document.getElementById('dataYearSelect');

  // 存储选择的文件（数组）
  let selectedFiles = [];

  // 更新显示选中文件列表
  function updateFileList() {
    if (selectedFiles.length === 0) {
      fileList.innerHTML = '<p class="text-muted">暂无选中文件</p>';
      return;
    }
    fileList.innerHTML = '';
    selectedFiles.forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.style.display = 'flex';
      fileItem.style.justifyContent = 'space-between';
      fileItem.style.alignItems = 'center';
      fileItem.style.padding = '6px 0';
      fileItem.style.borderBottom = '1px solid #eee';
      fileItem.innerHTML = `
        <span>${file.name}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-index="${index}">
          <i class="bi bi-x-circle"></i>
        </button>`;
      fileList.appendChild(fileItem);
    });
  }

  // 选择文件按钮点击
  selectFileBtn.addEventListener('click', () => {
    fileInput.click();
  });

  // 文件输入改变时更新文件列表
  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    selectedFiles = selectedFiles.concat(files);
    updateFileList();
  });

  // 处理拖拽文件
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.backgroundColor = '#f7f7f7';
  });

  uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.style.backgroundColor = '';
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.backgroundColor = '';
    const files = Array.from(e.dataTransfer.files).filter(file => {
      const ext = file.name.split('.').pop().toLowerCase();
      return ext === 'xlsx' || ext === 'csv';
    });
    selectedFiles = selectedFiles.concat(files);
    updateFileList();
  });

  // 点击取消上传按钮，清空选中文件
  cancelBtn.addEventListener('click', () => {
    selectedFiles = [];
    fileInput.value = '';
    updateFileList();
    uploadStatus.innerHTML = '<div class="alert alert-info mt-2">已取消所有选择的文件。</div>';
  });

  // 绑定删除单个文件事件（通过委托方式绑定）
  fileList.addEventListener('click', (e) => {
    if (e.target.closest('button')) {
      const index = e.target.closest('button').getAttribute('data-index');
      selectedFiles.splice(index, 1);
      updateFileList();
    }
  });

  // 上传文件按钮点击
  uploadBtn.addEventListener('click', () => {
    if (selectedFiles.length === 0) {
      uploadStatus.innerHTML = '<div class="alert alert-warning mt-2">请选择要上传的文件。</div>';
      return;
    }
    // 获取用户选择的数据年份
    const dataYear = dataYearSelect.value;
    const formData = new FormData();
    // 为保证批量上传时统一使用同一 data_year，先取第一个文件上传
    // 如有需要，可修改为批量上传，每个文件单独处理 data_year
    formData.append('data_year', dataYear);
    selectedFiles.forEach(file => {
      formData.append('file', file);
    });
    uploadStatus.innerHTML = '<div class="alert alert-info mt-2">正在上传，请稍候……</div>';
    fetch("{{ url_for('import_api.import_students') }}", {
      method: 'POST',
      body: formData
    })
      .then(response => response.json())
      .then(result => {
        if (result.error) {
          uploadStatus.innerHTML = `<div class="alert alert-danger mt-2">${result.error}</div>`;
        } else {
          uploadStatus.innerHTML = `<div class="alert alert-success mt-2">${result.message}</div>`;
        }
      })
      .catch(err => {
        uploadStatus.innerHTML = `<div class="alert alert-danger mt-2">上传过程中出现错误：${err}</div>`;
        console.error('上传错误:', err);
      });
  });
});
</script>
{% endblock %}
