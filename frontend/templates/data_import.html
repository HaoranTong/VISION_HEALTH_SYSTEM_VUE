{#
文件名称: data_import.html
完整存储路径: frontend/templates/data_import.html
功能说明:
    数据导入测试页面，专用于文件上传、数据校验和导入状态反馈。
    支持 Excel (.xlsx) 和 CSV (.csv) 文件的上传，支持拖拽和文件选择，
    显示选中文件列表，并提供“选择文件”、“上传文件”和“取消上传”按钮。
    页面布局和样式经过小幅优化，使上传区域更美观、易用。
使用说明:
    用户通过此页面选择或拖拽文件，点击上传按钮完成数据导入，
    点击取消按钮可清空所有已选文件。上传成功后显示成功记录条数，
    上传失败记录生成错误报告，并显示失败记录文件下载链接。
#}
{% extends "layouts/base.html" %}

{% block title %}数据导入 - 近视预防干预系统{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12 col-md-10 offset-md-1">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h2 class="h4 mb-0">数据导入</h2>
        </div>
        <div class="card-body">
          <p class="text-muted">
            请选择或拖拽要导入的 Excel (.xlsx) 或 CSV (.csv) 文件。上传后将自动校验数据并保存合格记录，
            不合格记录会生成“上传失败记录表”供您下载查看。若部分行校验失败，会显示失败行数及下载链接。
          </p>
          <!-- 上传区域 -->
          <div id="uploadArea" class="border rounded p-4 mb-4"
               style="min-height:150px; text-align: center; transition: background 0.3s;">
            <p class="text-muted">拖拽文件到此区域，或点击“选择文件”按钮</p>
            <div id="fileList" class="text-start"></div>
          </div>
          <div class="mb-3 d-flex flex-wrap gap-2">
            <button type="button" id="selectFileBtn" class="btn btn-secondary">
              <i class="bi bi-folder me-2"></i>选择文件
            </button>
            <button type="button" id="cancelBtn" class="btn btn-outline-secondary">
              <i class="bi bi-x me-2"></i>取消上传
            </button>
            <button type="button" id="uploadBtn" class="btn btn-primary">
              <i class="bi bi-upload me-2"></i>上传文件
            </button>
          </div>
          <div id="uploadStatus" class="mt-3"></div>
          <!-- 隐藏的文件输入控件 -->
          <input type="file" id="fileInput" accept=".xlsx,.csv" multiple style="display:none;">
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById('fileInput');
  const selectFileBtn = document.getElementById('selectFileBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileList = document.getElementById('fileList');
  const uploadArea = document.getElementById('uploadArea');
  const uploadStatus = document.getElementById('uploadStatus');

  // 存储选择的文件（数组）
  let selectedFiles = [];

  // 更新显示选中文件列表
  function updateFileList() {
    if (selectedFiles.length === 0) {
      fileList.innerHTML = '<p class="text-muted">暂无选中文件</p>';
      return;
    }
    fileList.innerHTML = '';
    selectedFiles.forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.style.display = 'flex';
      fileItem.style.justifyContent = 'space-between';
      fileItem.style.alignItems = 'center';
      fileItem.style.padding = '6px 0';
      fileItem.style.borderBottom = '1px solid #eee';
      fileItem.innerHTML = `
        <span>${file.name}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-index="${index}">
          <i class="bi bi-x-circle"></i>
        </button>`;
      fileList.appendChild(fileItem);
    });
  }

  // 选择文件按钮点击
  selectFileBtn.addEventListener('click', () => {
    fileInput.click();
  });

  // 文件输入改变时更新文件列表
  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    selectedFiles = selectedFiles.concat(files);
    updateFileList();
  });

  // 处理拖拽文件
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.backgroundColor = '#f7f7f7';
  });

  uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.style.backgroundColor = '';
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.backgroundColor = '';
    const files = Array.from(e.dataTransfer.files).filter(file => {
      const ext = file.name.split('.').pop().toLowerCase();
      return ext === 'xlsx' || ext === 'csv';
    });
    selectedFiles = selectedFiles.concat(files);
    updateFileList();
  });

  // 点击取消上传按钮，清空选中文件
  cancelBtn.addEventListener('click', () => {
    selectedFiles = [];
    fileInput.value = '';
    updateFileList();
    uploadStatus.innerHTML = '<div class="alert alert-info mt-2">已取消所有选择的文件。</div>';
  });

  // 绑定删除单个文件事件（通过委托方式绑定）
  fileList.addEventListener('click', (e) => {
    if (e.target.closest('button')) {
      const index = e.target.closest('button').getAttribute('data-index');
      selectedFiles.splice(index, 1);
      updateFileList();
    }
  });

  // 上传文件按钮点击
  uploadBtn.addEventListener('click', () => {
    if (selectedFiles.length === 0) {
      uploadStatus.innerHTML = '<div class="alert alert-warning mt-2">请选择要上传的文件。</div>';
      return;
    }
    uploadStatus.innerHTML = '<div class="alert alert-info mt-2">正在上传，请稍候……</div>';
    // 对每个文件进行上传，这里采用并行上传
    const promises = selectedFiles.map(file => {
      const formData = new FormData();
      formData.append('file', file);
      return fetch("{{ url_for('import_api.import_students') }}", {
        method: 'POST',
        body: formData
      }).then(response => response.json());
    });

    Promise.all(promises)
      .then(results => {
        // 累加后端返回的导入与失败信息
        let totalImported = 0;
        let totalFailed = 0;
        let errorMessages = [];
        let failureLinks = [];

        results.forEach(result => {
          // 如果后端顶层有 error，则说明发生了严重错误
          if (result.error) {
            errorMessages.push(result.error);
          } else {
            // 累加导入成功和失败数量
            totalImported += (result.imported_count || 0);
            totalFailed += (result.failures_count || 0);
            if (result.failures_file) {
              failureLinks.push(result.failures_file);
            }
          }
        });

        // 根据累计结果判断显示
        if (totalFailed > 0) {
          // 部分或全部失败
          let failLinksHtml = "";
          if (failureLinks.length > 0) {
            // 可能一次上传多个文件，每个文件都可能生成一个失败记录表
            failLinksHtml = failureLinks.map(link => {
              return `<div><a href="${link}" target="_blank" class="text-danger">下载失败记录</a></div>`;
            }).join("");
          }
          uploadStatus.innerHTML = `
            <div class="alert alert-danger mt-2">
              上传完成：成功导入 ${totalImported} 条记录，失败 ${totalFailed} 条记录。<br>
              ${failLinksHtml ? `失败记录表：<br>${failLinksHtml}` : ""}
              ${errorMessages.length > 0 ? `<br>其他错误：<br>${errorMessages.join("<br>")}` : ""}
            </div>`;
        } else if (errorMessages.length > 0) {
          // 如果 purely 只有 result.error
          uploadStatus.innerHTML = `
            <div class="alert alert-danger mt-2">
              上传出现错误：<br>${errorMessages.join("<br>")}
            </div>`;
        } else {
          // 全部成功
          uploadStatus.innerHTML = `
            <div class="alert alert-success mt-2">
              所有文件均成功上传，共导入 ${totalImported} 条记录。
            </div>`;
        }
      })
      .catch(err => {
        uploadStatus.innerHTML = `
          <div class="alert alert-danger mt-2">
            上传过程中出现错误：${err}
          </div>`;
        console.error('上传错误:', err);
      });
  });
});
</script>
{% endblock %}
